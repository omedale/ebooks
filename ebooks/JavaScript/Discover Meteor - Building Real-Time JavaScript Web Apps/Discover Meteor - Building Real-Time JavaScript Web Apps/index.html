<!DOCTYPE html>
<html class='no-js' lang='en'>
  <head>
    <meta charset='utf-8'>
    <!-- Set the viewport width to device width for mobile -->
    <meta content='width=device-width, initial-scale=1.0' name='viewport'>
    <meta content='Discover Meteor' name='Title'>
    <meta content='Tom Coleman &amp; Sacha Greif' name='Author'>
    <meta content='Learn to build Meteor apps from scratch.' name='Description'>
    <title>Discover Meteor</title>
    <!-- Included CSS Files -->
    <link href='stylesheets/ebook.css' rel='stylesheet'>
    <link href='images/favicon.ico' rel='shortcut icon'>
  </head>
  <body>
    <div class='main'>
      <div class='row'>
        <section class='inner-cover'>
          <div class='title'>
            <h1>
              <span>Discover</span>
              <strong>Meteor</strong>
            </h1>
            <h2>Building Real-Time JavaScript Web Apps</h2>
          </div>
          <footer>
            <div class='credits'>
              <h3>Tom Coleman &amp; Sacha Greif</h3>
              <p>
                Cover photo credit:
                <a href='http://www.flickr.com/photos/dobieks/4889222256/in/photostream/'>Perseid Hunting</a>
                by Darren Blackburn, licensed under a Creative Commons Attribution 2.0 Generic license.
              </p>
            </div>
            <div class='site'>
              <a href='http://discovermeteor.com'>www.discovermeteor.com</a>
            </div>
          </footer>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='introduction'>
              Introduction
              <span class='number'>1</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn what makes Meteor special.</li>
            <li>Read about the story of this book.</li>
            <li>Learn how this book is organized.</li>
            </ul>
            </div>
            
            <p>Do a little mental experiment for me. Imagine you&#39;re opening the same folder in two different windows on your computer. </p>
            
            <p>Now click inside one of the two windows and delete a file. Did the file disappear from the other window as well?</p>
            
            <p>You don&#39;t need to actually do these steps to know that it did. When we modify something on our local filesystems, the change is applied everywhere without the need for refreshes or callbacks. It just happens. </p>
            
            <p>However, let&#39;s think about how the same scenario would play out on the web. For example, let&#39;s say you opened the same WordPress site admin in two browser windows and then created a new post in one of them. Unlike on the desktop, no matter how long you wait, the other window won&#39;t reflect the change unless you refresh it. </p>
            
            <p>Over the years, we&#39;ve gotten used to the idea that a website is something that you only communicate with in short, separate bursts. </p>
            
            <p>But Meteor is part of a new wave of frameworks and technologies that are looking to challenge the status quo by making the web real-time and reactive.</p>
            
            <h3>What is Meteor?</h3>
            
            <p>Meteor is a platform built on top of Node.js for building real-time web apps. It&#39;s what sits between your app&#39;s database and its user interface and makes sure that both are kept in sync.</p>
            
            <p>Since it&#39;s built on Node.js, Meteor uses JavaScript on both the client and on the server. What&#39;s more, Meteor is also able to share code between both environments. </p>
            
            <p>The result of all this is a platform that manages to be very powerful and very simple by abstracting away many of the usual hassles and pitfalls of web app development.</p>
            
            <h3>Why Meteor?</h3>
            
            <p>So why should you spend your time learning Meteor rather than another web framework? Leaving aside all the various features of Meteor, we believe it boils down to one thing: Meteor is easy to learn.</p>
            
            <p>More so than any other framework, Meteor makes it possible to get a real-time web app up and running on the web in a matter of hours. And if you&#39;ve ever done front-end development before, you&#39;ll already be familiar with JavaScript and won&#39;t even need to learn a new language.</p>
            
            <p>Meteor might be the ideal framework for your needs, or then again it might not. But since you can get started over the course of a few evenings or a week-end, why not try it and find out for yourself?</p>
            
            <h3>Why This Book?</h3>
            
            <p>For the past 6 months, we&#39;ve been working on <a href="http://telesc.pe">Telescope</a>, an open-source Meteor app that lets anybody create their own social news site (think <a href="http://reddit.com">Reddit</a> or <a href="http://news.ycombinator.com">Hacker news</a>), where people can submit links and vote on them.</p>
            
            <p>We learned a ton building the app, but it wasn&#39;t always easy to find the answers to our questions. We had to piece things together from many different sources, and in many cases even invent our own solutions. So with this book, we wanted to share all those lessons, and create a simple step-by-step guide that will walk you through building a full-fledged Meteor app from scratch. </p>
            
            <p>The app we&#39;re building is a slightly simplified version of Telescope, which we call Microscope. While building it, we&#39;ll address all the different elements that go into building a Meteor app, such as user accounts, Meteor collections, routing, and more. </p>
            
            <p>And after you&#39;re done reading the book, if you want to go further you&#39;ll be able to easily understand the code of Telescope, since it follows the same patterns. </p>
            
            <h3>About the Authors</h3>
            
            <p>In case you&#39;re wondering who we are and why you should trust us, here is a little more background on both of us.  </p>
            
            <p><img class="portrait" src="images/tom-photo.jpg"/>
            <strong>Tom Coleman</strong> is one part of <a href="http://percolatestudio.com/">Percolate Studio</a>, a web development shop with a focus on quality and user experience. He&#39;s also the co-creator of <a href="https://github.com/oortcloud/meteorite">Meteorite</a> and the <a href="http://atmosphere.meteor.com">Atmosphere</a> package repository, and is also behind many other Meteor open-source projects (such as the <a href="https://github.com/tmeasday/meteor-router">Router</a>).</p>
            
            <p><img class="portrait" src="images/sacha-photo.jpg"/>
            <strong>Sacha Greif</strong> has worked with startups such as <a href="http://hipmunk.com">Hipmunk</a> and <a href="http://rubymotion.com">RubyMotion</a> as a product and web designer. He&#39;s the creator of <a href="http://telesc.pe">Telescope</a> and <a href="http://sidebar.io">Sidebar</a> (which is based on Telescope), and is also the founder of <a href="http://folyo.me">Folyo</a>.</p>
            
            <h3>Chapters &amp; Sidebars</h3>
            
            <p>We wanted this book to be useful both for the novice Meteor user and the advanced programmer, so we split the chapters into two categories: regular chapters (numbered 1 through 14) and sidebars (.5 numbers).</p>
            
            <p>Regular chapters will walk you through building the app, and will try to get you operational as soon as possible by explaining the most important steps without bogging you down with too much detail.</p>
            
            <p>On the other hand, sidebars will go deeper into Meteor&#39;s intricacies, and will help you get a better understanding of what&#39;s really going on behind the scenes.</p>
            
            <p>So if you&#39;re a beginner, feel free to skip the sidebars on your first read, and come back to them later on once you&#39;ve played around with Meteor. </p>
            
            <h3>Commits &amp; Live Instances</h3>
            
            <p>There&#39;s nothing worse than following along in a programming book and suddenly realizing your code has gotten out of sync with the examples and that nothing works like it should anymore. </p>
            
            <p>To prevent this, we&#39;ve set up <a href="https://github.com/SachaG/Microscope">a GitHub repository for Microscope</a>, and we&#39;ll also provide direct links to git commits every few code changes. Additionally, each commit also links to a live instance of the app at this particular commit, so you can compare it with your local copy. Here&#39;s an example of what that will look like:</p>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 11-2</h4><p>Display notifications in the header.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter11-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter11-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>But note that just because we provide these commits doesn&#39;t mean you should just go from one <code>git checkout</code> to the next. You will learn much better if you take the time to manually type out your app&#39;s code!</p>
            
            <h3>A Few Other Resources</h3>
            
            <p>If you ever want to learn more about a particular aspect of Meteor, the <a href="http://docs.meteor.com/">official Meteor documentation</a> is the best place to start. </p>
            
            <p>We also recommend <a href="http://stackoverflow.com/questions/tagged/meteor">Stack Overflow</a> for troubleshooting and questions, and the #meteor <a href="https://webchat.freenode.net/">IRC channel</a> if you need live help. </p>
            
            <div class="note"><h3>Do I Need Git?</h3>
            
            <p>While being familiar with Git version control is not strictly necessary to follow along with this book, we strongly recommend it. </p>
            
            <p>If you want to get up to speed, we recommend Nick Farina&#39;s <a href="http://nfarina.com/post/9868516270/git-is-simpler">Git Is Simpler Than You Think</a>. </p>
            
            <p>If you&#39;re a git novice, we also recommend the <a href="http://mac.github.com/">GitHub for Mac</a> app, which lets you clone and manage repos without using the command line. </p>
            </div>
            
            <h3>Getting in Touch</h3>
            
            <ul>
            <li>If you&#39;d like to get in touch with us, you can email us at <a href="mailto:hello@discovermeteor.com">hello@discovermeteor.com</a>.</li>
            <li>Additionally, if you find a typo or another mistake in the book&#39;s contents, you can let us know by <a href="https://github.com/DiscoverMeteor/book/issues">submitting a bug in this GitHub repo</a>. </li>
            <li>If you have a problem with Microscope&#39;s code, you can <a href="https://github.com/DiscoverMeteor/Microscope/issues">submit a bug in Microscope&#39;s repository</a>.</li>
            <li>Finally, for every other question you can also just leave us a comment in this app&#39;s side panel. </li>
            </ul>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='gettingstarted'>
              Getting Started
              <span class='number'>2</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Install Meteor &amp; Meteorite.</li>
            <li>Learn about the 5 types of Meteor packages.</li>
            <li>Setup the file structure of your Meteor app.</li>
            </ul>
            </div>
            
            <h3>Installing Meteor</h3>
            
            <p>To begin with, we can install Meteor from http://meteor.com:</p>
            <div class="highlight"><pre><span class="nv">$ </span>curl https://install.meteor.com | sh</pre></div>
            <p>This will install the <code>meteor</code> executable onto your system and have you ready to use Meteor.</p>
            
            <div class="note"><h3><em>Not</em> Installing Meteor</h3>
            
            <p>If you can&#39;t (or don&#39;t want to) install Meteor locally, we recommend checking out <a href="http://nitrous.io">Nitrous.io</a>.</p>
            
            <p>Nitrous.io is a service that lets you run apps and edit their code right in your browser, and we&#39;ve written <a href="https://www.discovermeteor.com/2013/10/04/meteor-nitrous/">a short guide</a> to help you get set up. </p>
            
            <p>You can simply follow that guide up to (and including) the &ldquo;Installing Meteor &amp; Meteorite&rdquo; section, and then follow along with the book again starting from the &ldquo;Creating a Simple App&rdquo; secion of this chapter. </p>
            </div>
            
            <h3>Meteorite</h3>
            
            <p>Due to the fact that Meteor doesn&#39;t yet support third-party packages out of the box, Tom Coleman (one of this book&#39;s authors) and some members of the community have created <a href="http://oortcloud.github.com/meteorite/">Meteorite</a>, a wrapper for Meteor. Meteorite also takes care of installing Meteor for you and hooking it together with any packages you might find.</p>
            
            <p>Since we&#39;ll be relying on third-party packages for some of Microscope&#39;s features, let&#39;s install Meteorite. </p>
            
            <h3>Installing Meteorite</h3>
            
            <p>You&#39;ll need to ensure node and git are installed on your machine. Install them in the standard way for your OS, or try these links:</p>
            
            <ul>
            <li><a href="http://nodejs.org/download/">Node download site</a></li>
            <li><a href="http://git-scm.com/downloads">Git download site</a></li>
            </ul>
            
            <p>Second, let&#39;s install Meteorite. As it&#39;s a <a href="https://npmjs.org/">npm</a> executable (Node Packaged Module, Node&#39;s standard module format), we install it with:</p>
            <div class="highlight"><pre><span class="nv">$ </span>npm install -g meteorite</pre></div>
            <div class="note"><h3>Permission errors?</h3>
            
            <p>On some machines you may need root permission to install Meteorite. To avoid problems, make sure you use <code>sudo -H</code>:</p>
            
            <pre><code class="bash">$ sudo -H npm install -g meteorite&#x000A;</code></pre>
            
            <p>You can read more about this issue in the <a href="https://github.com/oortcloud/meteorite/blob/master/README.md#permission-woes">Meteorite documentation</a>.</p>
            </div>
            
            <p>That&#39;s it! Meteorite will handle things from here.</p>
            
            <p>Note: there is no Windows support for Meteorite yet, but you can take a look at <a href="http://themeteorbook.com/2013/03/20/using-meteor-and-atmopshere-on-windows/">our windows tutorial</a> instead.</p>
            
            <div class="note"><p>### <code>mrt</code> vs <code>meteor</code></p>
            
            <p>Meteorite installs the <code>mrt</code> executable, which we&#39;ll use to install packages into our application. When we want to run our server, however, we use the <code>meteor</code> executable.</p>
            </div>
            
            <h3>Creating a Simple App</h3>
            
            <p>Now that we have installed Meteorite, let&#39;s create an app. To do this, we use Meteorite&#39;s command line tool <code>mrt</code>:</p>
            <div class="highlight"><pre><span class="nv">$ </span>mrt create microscope</pre></div>
            <p>This command will download Meteor, and set up a basic, ready to use Meteor project for you. When it&#39;s done, you should see a directory, <code>microscope/</code>, containing the following:</p>
            <div class="highlight"><pre>microscope.css  &#x000A;microscope.html &#x000A;microscope.js   &#x000A;smart.json </pre></div>
            <p>The app that Meteor has created for you is a simple boilerplate application demonstrating a few simple patterns. </p>
            
            <p>Even though our app doesn&#39;t do much, we can still run it. To run the app, go back to your terminal and type:</p>
            <div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>microscope&#x000A;<span class="nv">$ </span>meteor</pre></div>
            <p>Now point your browser to <code>http://localhost:3000/</code> (or the equivalent <code>http://0.0.0.0:3000/</code>) and you should see something like this: </p>
            
            <figure class="screenshot "><img src="images/screenshots/2-1.png" alt="Meteor's Hello World."/><figcaption>Meteor&rsquo;s Hello World.</figcaption></figure>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 2-1</h4><p>Created basic microscope project.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter2-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter2-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Congratulations! You&#39;ve got your first Meteor app running. By the way, to stop the app all you need to do is bring up the terminal tab where the app is running, and press <code>ctrl+c</code>. </p>
            
            <h3>Adding a Package</h3>
            
            <p>We will now use Meteorite to add a smart package that will let us include <a href="http://twitter.github.com/bootstrap/">Bootstrap</a> in our project:</p>
            <div class="highlight"><pre><span class="nv">$ </span>mrt add bootstrap</pre></div>
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 2-2</h4><p>Added bootstrap package.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter2-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter2-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <div class="note"><h3>A Note on Packages</h3>
            
            <p>When speaking about packages in the context of Meteor, it pays to be specific. Meteor uses five basic types of packages:</p>
            
            <ul>
            <li>The Meteor core itself is split into different <strong>core packages</strong>. They are included with every Meteor app, and you will pretty much never need to worry about these.</li>
            <li>Meteor <strong>smart packages</strong> are a group of <a href="http://docs.meteor.com/#packages">about 37 packages</a> (you can get the full list with <code>meteor list</code>) that come bundled with Meteor and that you can optionally import into your own app. You can add them even when you&#39;re not using Meteorite, with <code>meteor add packagename</code>. </li>
            <li><strong>Local packages</strong> are custom packages you can create yourself and put in the <code>/packages</code> directory. You don&#39;t need Meteorite to use them either.</li>
            <li><strong>Atmosphere smart packages</strong> are third-party Meteor packages listed on <a href="http://atmosphere.meteor.com">Atmosphere</a>. Meteorite is needed to import and use them. </li>
            <li><strong>NPM packages</strong> (Node Packaged Modules) are Node.js packages. Although they don&#39;t work out of the box with Meteor, they <em>can</em> be used by the previous types of packages. </li>
            </ul>
            </div>
            
            <h3>The File Structure of a Meteor App</h3>
            
            <p>Before we begin coding, we must set up our project properly. To ensure we have a clean build, open up the <code>microscope</code> directory and delete <code>microscope.html</code>, <code>microscope.js</code>, and <code>microscope.css</code>. </p>
            
            <p>Next, create five root directories inside <code>/microscope</code>: <code>/client</code>, <code>/server</code>, <code>/public</code>, <code>/lib</code>, and <code>/collections</code>, and we&#39;ll also create empty <code>main.html</code> and <code>main.js</code> files inside <code>/client</code>. Don&#39;t worry if this breaks the app for now, we&#39;ll start filling in these files in the next chapter. </p>
            
            <p>We should mention that some of these directories are special. When it comes to files, Meteor has a few rules:</p>
            
            <ul>
            <li>Code in the <code>/server</code> directory only runs on the server.</li>
            <li>Code in the <code>/client</code> directory only runs on the client.</li>
            <li>Everything else runs on both the client and server.</li>
            <li>Files in <code>/lib</code> are loaded before anything else.</li>
            <li>Any <code>main.*</code> file is loaded after everything else.</li>
            <li>Your static assets (fonts, images, etc.) go in the <code>/public</code> directory. </li>
            </ul>
            
            <p>Note that although Meteor has these rules, it doesn&#39;t really force you to use any predefined file structure for your app if you don&#39;t want to. So the structure we suggest is just our way of doing things, not a rule set in stone. </p>
            
            <p>We encourage you to check out the <a href="http://docs.meteor.com/#structuringyourapp">official Meteor docs</a> if you want more details on this.</p>
            
            <div class="note"><h3>Is Meteor MVC?</h3>
            
            <p>If you&#39;re coming to Meteor from other frameworks such as Ruby on Rails, you might be wondering if Meteor apps adopt the MVC (Model View Controller) pattern. </p>
            
            <p>The short answer is no. Unlike Rails, Meteor doesn&#39;t impose any predefined structure to your app. So in this book we&#39;ll simply lay out code in the way that makes the most sense to us, without worrying too much about acronyms.</p>
            </div>
            
            <h3>No public?</h3>
            
            <p>OK, we lied. We don&#39;t actually need the <code>public/</code> directory for the simple reason that Microscope doesn&#39;t use any static assets! But since most other Meteor apps are going to include at least a couple images, we thought it was important to cover it too. </p>
            
            <p>By the way, you might also notice a hidden <code>.meteor</code> directory. This is where Meteor stores its own code, and modifying  things in there is usually a very bad idea. The only exceptions to this are the <code>.meteor/packages</code> and <code>.meteor/release</code> files, which are respectively used to list your smart packages and the version of Meteor to use.</p>
            
            <div class="note"><h3>Underscores vs CamelCase</h3>
            
            <p>The only thing we&#39;ll say about the age-old underscore (<code>my_variable</code>) vs camelCase (<code>myVariable</code>) debate is that it doesn&#39;t really matter which one you pick as long as you stick to it. </p>
            
            <p>In this book, we&#39;re using camelCase because it&#39;s the usual JavaScript way of doing things (after all, it&#39;s JavaScript, not java_script!). </p>
            
            <p>The only exceptions to this rule are file names, which will use underscores (<code>my_file.js</code>), and CSS classes, which use hyphens (<code>.my-class</code>). The reason for this is that in the filesystem, underscores are most common, while the CSS syntax itself already uses hyphens (<code>font-family</code>, <code>text-align</code>, etc.).</p>
            </div>
            
            <h3>Taking Care of CSS</h3>
            
            <p>This book is not about CSS. So to avoid slowing you down with styling details, we&#39;ve decided to make the whole stylesheet available from the start, so you don&#39;t need to worry about it ever again. </p>
            
            <p>CSS automatically gets loaded and minified by Meteor, so unlike other static assets it goes into <code>/client</code>, not <code>/public</code>. Go ahead and create a <code>client/stylesheets/</code> directory now, and put this <code>style.css</code> file inside it:</p>
            <div class="highlight"><pre><span class="nc">.grid-block</span><span class="o">,</span> <span class="nc">.main</span><span class="o">,</span> <span class="nc">.post</span><span class="o">,</span> <span class="nc">.comments</span> <span class="nt">li</span><span class="o">,</span> <span class="nc">.comment-form</span> <span class="p">{</span>&#x000A;    <span class="k">background</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>&#x000A;    <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>&#x000A;    <span class="k">padding</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>&#x000A;    <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>&#x000A;    <span class="n">box</span><span class="o">-</span><span class="n">shadow</span><span class="o">:</span> <span class="m">0</span> <span class="m">1px</span> <span class="m">1px</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">15</span><span class="p">);</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nt">body</span> <span class="p">{</span>&#x000A;    <span class="k">background</span><span class="o">:</span> <span class="m">#eee</span><span class="p">;</span>&#x000A;    <span class="k">color</span><span class="o">:</span> <span class="m">#666666</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.navbar</span> <span class="p">{</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span> <span class="p">}</span>&#x000A;<span class="nc">.navbar</span> <span class="nc">.navbar-inner</span> <span class="p">{</span>&#x000A;    <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">3px</span> <span class="m">3px</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nf">#spinner</span> <span class="p">{</span> <span class="k">height</span><span class="o">:</span> <span class="m">300px</span> <span class="p">}</span>&#x000A;<span class="nc">.post</span> <span class="p">{</span>&#x000A;    <span class="o">*</span><span class="n">zoom</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>&#x000A;    <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">transition</span><span class="o">:</span> <span class="n">all</span> <span class="m">300</span><span class="n">ms</span> <span class="m">0</span><span class="n">ms</span><span class="p">;</span>&#x000A;    <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">transition</span><span class="o">-</span><span class="n">delay</span><span class="o">:</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="p">;</span>&#x000A;    <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">transition</span><span class="o">:</span> <span class="n">all</span> <span class="m">300</span><span class="n">ms</span> <span class="m">0</span><span class="n">ms</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="p">;</span>&#x000A;    <span class="o">-</span><span class="n">o</span><span class="o">-</span><span class="n">transition</span><span class="o">:</span> <span class="n">all</span> <span class="m">300</span><span class="n">ms</span> <span class="m">0</span><span class="n">ms</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="p">;</span>&#x000A;    <span class="n">transition</span><span class="o">:</span> <span class="n">all</span> <span class="m">300</span><span class="n">ms</span> <span class="m">0</span><span class="n">ms</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="p">;</span>&#x000A;    <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>&#x000A;    <span class="k">opacity</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.post</span><span class="nd">:before</span><span class="o">,</span> <span class="nc">.post</span><span class="nd">:after</span> <span class="p">{</span>&#x000A;    <span class="k">content</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>&#x000A;    <span class="k">display</span><span class="o">:</span> <span class="n">table</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.post</span><span class="nd">:after</span> <span class="p">{</span> <span class="k">clear</span><span class="o">:</span> <span class="k">both</span> <span class="p">}</span>&#x000A;<span class="nc">.post.invisible</span> <span class="p">{</span> <span class="k">opacity</span><span class="o">:</span> <span class="m">0</span> <span class="p">}</span>&#x000A;<span class="nc">.post</span> <span class="nc">.upvote</span> <span class="p">{</span>&#x000A;    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>&#x000A;    <span class="k">margin</span><span class="o">:</span> <span class="m">7px</span> <span class="m">12px</span> <span class="m">0</span> <span class="m">0</span><span class="p">;</span>&#x000A;    <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.post</span> <span class="nc">.post-content</span> <span class="p">{</span> <span class="k">float</span><span class="o">:</span> <span class="k">left</span> <span class="p">}</span>&#x000A;<span class="nc">.post</span> <span class="nc">.post-content</span> <span class="nt">h3</span> <span class="p">{</span>&#x000A;    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>&#x000A;    <span class="k">line-height</span><span class="o">:</span> <span class="m">1</span><span class="o">.</span><span class="m">4</span><span class="p">;</span>&#x000A;    <span class="k">font-size</span><span class="o">:</span> <span class="m">18px</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.post</span> <span class="nc">.post-content</span> <span class="nt">h3</span> <span class="nt">a</span> <span class="p">{</span>&#x000A;    <span class="k">display</span><span class="o">:</span> <span class="k">inline</span><span class="o">-</span><span class="k">block</span><span class="p">;</span>&#x000A;    <span class="k">margin-right</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.post</span> <span class="nc">.post-content</span> <span class="nt">h3</span> <span class="nt">span</span> <span class="p">{</span>&#x000A;    <span class="k">font-weight</span><span class="o">:</span> <span class="k">normal</span><span class="p">;</span>&#x000A;    <span class="k">font-size</span><span class="o">:</span> <span class="m">14px</span><span class="p">;</span>&#x000A;    <span class="k">display</span><span class="o">:</span> <span class="k">inline</span><span class="o">-</span><span class="k">block</span><span class="p">;</span>&#x000A;    <span class="k">color</span><span class="o">:</span> <span class="m">#aaaaaa</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.post</span> <span class="nc">.post-content</span> <span class="nt">p</span> <span class="p">{</span> <span class="k">margin</span><span class="o">:</span> <span class="m">0</span> <span class="p">}</span>&#x000A;<span class="nc">.post</span> <span class="nc">.discuss</span> <span class="p">{</span>&#x000A;    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>&#x000A;    <span class="k">float</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>&#x000A;    <span class="k">margin-top</span><span class="o">:</span> <span class="m">7px</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.comments</span> <span class="p">{</span>&#x000A;    <span class="k">list-style-type</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>&#x000A;    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.comments</span> <span class="nt">li</span> <span class="nt">h4</span> <span class="p">{</span>&#x000A;    <span class="k">font-size</span><span class="o">:</span> <span class="m">16px</span><span class="p">;</span>&#x000A;    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.comments</span> <span class="nt">li</span> <span class="nt">h4</span> <span class="nc">.date</span> <span class="p">{</span>&#x000A;    <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span>&#x000A;    <span class="k">font-weight</span><span class="o">:</span> <span class="k">normal</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.comments</span> <span class="nt">li</span> <span class="nt">h4</span> <span class="nt">a</span> <span class="p">{</span> <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span> <span class="p">}</span>&#x000A;<span class="nc">.comments</span> <span class="nt">li</span> <span class="nt">p</span><span class="nd">:last-child</span> <span class="p">{</span> <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0</span> <span class="p">}</span>&#x000A;<span class="nc">.dropdown-menu</span> <span class="nt">span</span> <span class="p">{</span>&#x000A;    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>&#x000A;    <span class="k">padding</span><span class="o">:</span> <span class="m">3px</span> <span class="m">20px</span><span class="p">;</span>&#x000A;    <span class="k">clear</span><span class="o">:</span> <span class="k">both</span><span class="p">;</span>&#x000A;    <span class="k">line-height</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span>&#x000A;    <span class="k">color</span><span class="o">:</span> <span class="m">#bbb</span><span class="p">;</span>&#x000A;    <span class="k">white-space</span><span class="o">:</span> <span class="k">nowrap</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.load-more</span> <span class="p">{</span>&#x000A;    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>&#x000A;    <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>&#x000A;    <span class="k">background</span><span class="o">:</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">05</span><span class="p">);</span>&#x000A;    <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>&#x000A;    <span class="k">height</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>&#x000A;    <span class="k">line-height</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>&#x000A;    <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="nc">.load-more</span><span class="nd">:hover</span> <span class="p">{</span>&#x000A;    <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>&#x000A;    <span class="k">background</span><span class="o">:</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">1</span><span class="p">);</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">client/stylesheets/style.css</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 2-3</h4><p>Re-arranged file structure.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter2-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter2-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <div class="note"><h3>A Note on CoffeeScript</h3>
            
            <p>In this book we&#39;ll be writing in pure JavaScript. But if you prefer CoffeeScript, Meteor has you covered. Simply add the CoffeeScript package and you&#39;ll be good to go:</p>
            
            <p><code>mrt add coffeescript</code></p>
            </div>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='deploying'>
              Deploying
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>2.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn how to deploy on Meteor.com.</li>
            <li>Learn how to deploy on Heroku.</li>
            <li>Learn how to deploy on your own server.</li>
            </ul>
            </div>
            
            <div class="note"><h3>This is a <span class="sidebar-marker">sidebar</span> chapter</h3>
            
            <p>Unlike the regular chapters you&#39;ve been reading up to now, sidebars are not really about building Microscope. Instead, they&#39;re more generally applicable chapters that dig deeper into a specific aspect of Meteor.</p>
            
            <p>You don&#39;t need to read the sidebars to understand the rest of the book. So if this is your first time around, feel free to skip them and focus on the more practical chapters for now. </p>
            </div>
            
            <p>Some people like to work quietly on a project until it&#39;s perfect, while others can&#39;t wait to show the world as soon as possible. </p>
            
            <p>If you&#39;re the first kind of person and would rather develop locally for now, feel free to skip this chapter. On the other hand, if you&#39;d rather take the time to learn how to deploy your Meteor app online, we&#39;ve got you covered. </p>
            
            <p>In this chapter, we&#39;ll cover three options for deploying: Meteor.com, Heroku, and deploying on your own server. </p>
            
            <h3>Deploying on Meteor.com</h3>
            
            <p>Deploying on Meteor.com couldn&#39;t be easier. Open the command line, navigate to your app&#39;s directory, and simply type:</p>
            <div class="highlight"><pre><span class="nv">$ </span>meteor deploy myapp.meteor.com</pre></div>
            <p>Alternatively, if you want to use your own domain set its CNAME to redirect to <code>origin.meteor.com</code> and then deploy with:</p>
            <div class="highlight"><pre><span class="nv">$ </span>meteor deploy www.myapp.com</pre></div>
            <p>Hosting on Meteor is free, but is fairly limited since you don&#39;t have access to monitoring tools and can&#39;t control your resources.</p>
            
            <h3>Deploying on Heroku</h3>
            
            <p>Deploying on <a href="http://heroku.com">Heroku</a> is still free (as long as you only use one dyno, which is the only way you can make Meteor work on Heroku anyway), but it gives you a little more control over your app. </p>
            
            <p>We won&#39;t cover installing <a href="http://git-scm.com">Git</a> and the Heroku command line here, but both can be done pretty easily with the <a href="https://toolbelt.herokuapp.com/">Heroku Toolbelt</a>.</p>
            
            <p>You&#39;ll need to use the <a href="https://github.com/oortcloud/heroku-buildpack-meteorite.git">Heroku Buildpack for Meteorite</a>. Heroku Buildpacks contains special instructions for Heroku that specify how to set up a server, in this case in order to run Meteor apps properly. </p>
            
            <p>So if you&#39;re creating a new Heroku app, specify the correct buildpack using this command:</p>
            <div class="highlight"><pre><span class="nv">$ </span>heroku create --stack cedar --buildpack https://github.com/oortcloud/heroku-buildpack-meteorite.git</pre></div>
            <p>Or, you can also add a buildpack to an existing Heroku app like so:</p>
            <div class="highlight"><pre><span class="nv">$ </span>heroku config:add <span class="nv">BUILDPACK_URL</span><span class="o">=</span>https://github.com/oortcloud/heroku-buildpack-meteorite.git</pre></div>
            <p>You&#39;ll also need to provide a MongoDB database for your app. We recommend the <a href="https://www.mongohq.com/home">MongoHQ</a> Heroku add-on (it comes with a nice UI for browsing your data), which you can either add via their web admin, or by using the following command:</p>
            <div class="highlight"><pre><span class="nv">$ </span>heroku addons:add mongohq:small</pre></div>
            <p>Before our Heroku instance is ready, we also need to configure Meteor&#39;s <code>ROOT_URL</code> environment variable to tell the app where it&#39;s running:</p>
            <div class="highlight"><pre><span class="nv">$ </span>heroku config:add <span class="nv">ROOT_URL</span><span class="o">=</span>http://www.domain.com</pre></div>
            <p>This is also a good time to add other config variables, such as <code>MAIL_URL</code>. For example, if you wanted to use <a href="http://mailgun.com">Mailgun</a> to send emails from your app, you would type in the following (while substituting your own Mailgun account credentials):</p>
            <div class="highlight"><pre><span class="nv">$ </span>heroku config:add <span class="nv">MAIL_URL</span><span class="o">=</span>smtp://postmaster%40YOUR_DOMAIN.mailgun.org:YOUR_PASSWORD@smtp.mailgun.org:587/</pre></div>
            <p>Now that our configuration is finished, all that remains is to use Git to push to Heroku:</p>
            <div class="highlight"><pre><span class="nv">$ </span>git push heroku</pre></div>
            <p>Congratulations, your app should now be up and running! And by the way, if you ever need to display your configuration variables (such as your MongoDB database&#39;s URL), just type:</p>
            <div class="highlight"><pre><span class="nv">$ </span>heroku config</pre></div>
            <h3>Deploying On Your Own Server</h3>
            
            <p>Up to now, we&#39;ve only talked about deploying on managed platforms like Meteor.com or Heroku. But let&#39;s see how to take it one step further and configure a server from scratch to run our app on a service like <a href="http://aws.amazon.com/ec2/">EC2</a> or <a href="http://digitalocean.com">Digital Ocean</a>. </p>
            
            <div class="note"><h3>Introducing Meteoric</h3>
            
            <p>We&#39;ve packaged the following process into <a href="https://github.com/julien-c/meteoric.sh">Meteoric</a>, a convenient script you can install on your local environment that will let you deploy Microscope (or your own app) to EC2 with just two commands: <code>meteoric setup</code> and <code>meteoric deploy</code>.</p>
            </div>
            
            <p>Let&#39;s see how to deploy a Meteor app on the latest version of Ubuntu Server (Ubuntu 13.04 Raring) on EC2. Start up an EC2 instance from your Amazon management console, then connect to it in the usual way.</p>
            
            <p>You will first need to install git and MongoDB:</p>
            <div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install git mongodb</pre></div>
            <p>(Note: if you want to make sure you get the latest version of Mongo, install it following <a href="http://docs.mongodb.org/manual/">the official instructions</a> instead.)</p>
            
            <p>Something to keep in mind when deploying a Meteor app to your own server is that Node is still evolving quite quickly (which can sometimes include breaking API changes), and Meteor support for the latest stable Node version can sometimes lag behind.</p>
            
            <p>One solution is to use <code>nvm</code> (<a href="https://github.com/creationix/nvm">Node version manager</a>), but it can be a bit tricky to set up robustly, particularly if you&#39;re going to run node as <code>root</code> (more on that later). </p>
            
            <p>So the easier option on Ubuntu is to add the <code>apt-get</code> repository for the <code>legacy</code> node release (i.e., the last stable release before the current stable release):</p>
            <div class="highlight"><pre><span class="nv">$ </span>sudo add-apt-repository ppa:chris-lea/node.js-legacy&#x000A;<span class="nv">$ </span>sudo apt-get update&#x000A;<span class="nv">$ </span>sudo apt-get install nodejs npm</pre></div>
            <p>Once Node is installed, you can now install Meteor and Meteorite:</p>
            <div class="highlight"><pre><span class="nv">$ </span>curl https://install.meteor.com | /bin/sh&#x000A;<span class="nv">$ </span>sudo -H npm install -g meteorite</pre></div>
            <p>Next, checkout your app&#39;s Git repo, e.g. <code>git clone https://github.com/DiscoverMeteor/microscope.git</code>), in <code>/home/meteor</code>.</p>
            
            <p>The next step is to bundle your app, i.e. generate a fully-contained Node application in a tarball. It is certainly possible to bundle your app in your development environment and then just transmit the tarball, but for now we&#39;d recommend checking out the actual code on the server. This approach has a couple of advantages:</p>
            
            <ul>
            <li>It&#39;s Git-based (just specify your project&#39;s repository)</li>
            <li>It doesn&#39;t require you to have Meteor installed locally</li>
            <li>It doesn&#39;t require re-building packages like Fibers (which are platform-dependent) </li>
            <li>And finally, it should allow for hot code fixes (your Node server won&#39;t stop when deploying your app)</li>
            </ul>
            
            <p>To bundle and untar our app (note that it would actually be handy for Meteor to be able to &ldquo;bundle as a directory, not a tarball&rdquo;), we do:</p>
            <div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>mymeteorapp &#x000A;<span class="nv">$ </span>mrt bundle ../bundle.tgz &#x000A;<span class="nv">$ </span><span class="nb">cd</span> ..&#x000A;<span class="nv">$ </span>tar -zxvf bundle.tgz </pre></div>
            <p>Next, we run the app:</p>
            <div class="highlight"><pre><span class="nv">$ </span>sudo <span class="nv">PORT</span><span class="o">=</span>80 <span class="nv">MONGO_URL</span><span class="o">=</span>mongodb://localhost:27017/myapp <span class="nv">ROOT_URL</span><span class="o">=</span>http://myapp.com node bundle/main.js</pre></div>
            <p>If you&#39;re serving your app on HTTP&#39;s standard port 80, remember to run this command as root, since processes run by non-root users don&#39;t have access to that port. Alternatively, you can also serve the app on another port and forward it to port 80.</p>
            
            <p>You can also specify configuration options (<code>MAIL_URL</code>, <code>ROOT_URL</code>) as environment variables in the same command.</p>
            
            <p>Next, we need to make sure the app runs continuously, i.e. have it restart automatically if it crashes. The simplest way to do that is to use <code>forever</code>:</p>
            <div class="highlight"><pre><span class="nv">$ </span>npm install -g forever&#x000A;<span class="nv">$ </span>forever start bundle/main.js</pre></div>
            <p>Forever preserves environment variables, so you just need to export them before starting the app: <code>export PORT=80 MONGO_URL=mongodb://localhost:27017/myapp ROOT_URL=http://myapp.com</code>.</p>
            
            <p>Finally, something is still missing to obtain a bullet-proof setup: automatic startup of the app on the machine&#39;s reboot. </p>
            
            <p>Using Ubuntu&#39;s Upstart, you can very easily tell your OS that your meteor app should start automatically whenever the server restarts. Put the following snippet into <code>/etc/init/meteor.conf</code>, and then type <code>service meteor start</code>. You don&#39;t need automatic respawns, as <code>forever</code> already takes care of that!</p>
            <div class="highlight"><pre><span class="c"># /etc/init/meteor.conf</span>&#x000A;&#x000A;start on <span class="o">(</span><span class="nb">local</span>-filesystems<span class="o">)</span>&#x000A;stop on shutdown&#x000A;&#x000A;script&#x000A;&#x000A;    <span class="nb">cd</span> /home/ubuntu&#x000A;    <span class="nb">export </span><span class="nv">PORT</span><span class="o">=</span>80 <span class="nv">MONGO_URL</span><span class="o">=</span>mongodb://localhost:27017/myapp <span class="nv">ROOT_URL</span><span class="o">=</span>http://myapp.com&#x000A;    <span class="nb">exec </span>forever start bundle/main.js&#x000A;&#x000A;end script</pre></div>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='templates'>
              Templates
              <span class='number'>3</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn about Meteor&#39;s templating language, Handlebars.</li>
            <li>Create your first three templates.</li>
            <li>Learn how Meteor managers work.</li>
            <li>Get a basic prototype working with static data.</li>
            </ul>
            </div>
            
            <h3>Our First Template</h3>
            
            <p>To ease into Meteor development, we&#39;ll adopt an outside-in approach. In other words we&#39;ll build a &ldquo;dumb&rdquo; HTML/JavaScript outer shell first, and then hook it up to our app&#39;s inner workings later on.  </p>
            
            <p>This means that in this chapter we&#39;ll only concern ourselves with what&#39;s happening inside the <code>/client</code> directory. </p>
            
            <p>Let&#39;s create a new file named <code>main.html</code> inside our <code>/client</code> directory, and fill it with the following code: </p>
            <div class="highlight"><pre><span class="nt">&lt;head&gt;</span>&#x000A;  <span class="nt">&lt;title&gt;</span>Microscope<span class="nt">&lt;/title&gt;</span>&#x000A;<span class="nt">&lt;/head&gt;</span>&#x000A;<span class="nt">&lt;body&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/header&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">class=</span><span class="s">&quot;row-fluid&quot;</span><span class="nt">&gt;</span>&#x000A;      {{&gt; postsList}}&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/body&gt;</span></pre></div>
            <div class="caption">client/main.html</div>
            
            <p>This will be our main app template. As you can see it&#39;s all HTML except for a single <code>{{&gt; postsList}}</code> tag, which is an insertion point for the <code>postsList</code> template as we&#39;ll soon see. For now, let&#39;s create a couple more templates. </p>
            
            <h3>Meteor Templates</h3>
            
            <p>At its core, a social news site is composed of posts organized in lists, and that&#39;s exactly how we&#39;ll organize our templates.  </p>
            
            <p>Let&#39;s create a <code>/views</code> directory inside <code>/client</code>. This will be where we put all our templates, and to keep things tidy we&#39;ll also create <code>/posts</code> inside <code>/views</code> just for our post-related templates. </p>
            
            <div class="note"><h3>Finding Files</h3>
            
            <p>Meteor is great at finding files. No matter where you put your code in the <code>/client</code> directory, Meteor will find it and compile it properly. This means you never need to manually write include paths for JavaScript or CSS files. </p>
            
            <p>It also means you could very well put all your files in the same directory, or even all your code in the same file. But since Meteor will compile everything to a single minified file anyway, we&#39;d rather keep things well-organized and use a cleaner file structure. </p>
            </div>
            
            <p>We&#39;re finally ready to create our second template. Inside <code>client/views/posts</code>, create <code>posts_list.html</code>:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postsList&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;posts&quot;</span><span class="nt">&gt;</span>&#x000A;    {{#each posts}}&#x000A;      {{&gt; postItem}}&#x000A;    {{/each}}&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/posts_list.html</div>
            
            <p>And <code>post_item.html</code>: </p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postItem&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post-content&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url}}&quot;</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_item.html</div>
            
            <p>Note the <code>name=&quot;postsList&quot;</code> attribute of the template element. This is the name that will be used by Meteor to keep track of what template goes where. </p>
            
            <p>It&#39;s time to introduce Meteor&#39;s templating system, <a href="http://handlebarsjs.com">Handlebars</a>. Handlebars is simply HTML, with the addition of three things: <em>partials</em>, <em>expressions</em> and <em>block helpers</em>.</p>
            
            <p><em>Partials</em> use the <code>{{&gt; templateName}}</code> syntax, and simply tell Meteor to replace the partial with the template of the same name (in our case <code>postItem</code>).</p>
            
            <p><em>Expressions</em> such as <code>{{title}}</code> either call a property of the current object, or the return value of a template helper as defined in the current template&#39;s manager (more on this later). </p>
            
            <p>Finally, <em>block helpers</em> are special tags that control the flow of the template, such as <code>{{#each}}…{{/each}}</code> or <code>{{#if}}…{{/if}}</code>.</p>
            
            <div class="note"><h3>Going Further</h3>
            
            <p>You can refer to the <a href="http://handlebarsjs.com">official Handlebars site</a> or <a href="http://javascriptissexy.com/handlebars-js-tutorial-learn-everything-about-handlebars-js-javascript-templating/">this handy tutorial</a> if you&#39;d like to learn more about Handlebars. </p>
            </div>
            
            <p>Armed with this knowledge, we can easily understand what&#39;s going on here. </p>
            
            <p>First, in the <code>postsList</code> template, we&#39;re iterating over a <code>posts</code> object with the <code>{{#each}}…{{/each}}</code> block helper. Then, for each iteration we&#39;re including the <code>postItem</code> template. </p>
            
            <p>Where is this <code>posts</code> object coming from? Good question. It&#39;s actually a template helper, and we&#39;ll define it when we look at template managers. </p>
            
            <p>The <code>postItem</code> template itself is fairly straightforward. It only uses three expressions: <code>{{url}}</code> and <code>{{title}}</code> both return the document&#39;s properties, and <code>{{domain}}</code> calls a template helper. </p>
            
            <p>We&#39;ve mentioned &ldquo;template helpers&rdquo; a lot throughout this chapter without really explaining what they do. But in order to fix this, we must first talk about managers. </p>
            
            <h3>Template Managers</h3>
            
            <p>Up to now we&#39;ve been dealing with Handlebars, which is little more than HTML with a few tags sprinkled in. Unlike other languages like PHP (or even regular HTML pages, which can include JavaScript), Meteor keeps templates and their logic separated, and these templates don&#39;t do much by themselves. </p>
            
            <p>In order to come to life, a template needs a <strong>manager</strong>. You can think of the manager as the chef that takes raw ingredients (your data) and prepares them, before handing out the finished dish to the waiter (the template) who then presents it to you. </p>
            
            <p>In other words, while the template&#39;s role is limited to displaying or looping over variables, the manager is the one who actually does the heavy lifting by assigning a value to each variable. </p>
            
            <div class="note"><h3>Managers?</h3>
            
            <p>When we asked around to see what other Meteor developers called template managers, half said &ldquo;controllers&rdquo;, and half said &ldquo;those files where I put my JavaScript code&rdquo;.</p>
            
            <p>Managers aren&#39;t really controllers (at least, not in the sense of MVC controllers) and &ldquo;TFWIPMJSC&rdquo; isn&#39;t really that catchy, so we rejected both propositions. </p>
            
            <p>Since we still wanted a way to indicate what we were talking about, we came up with the term &ldquo;manager&rdquo; as a handy shortcut that didn&#39;t have any pre-existing meaning as far as web frameworks are concerned.</p>
            </div>
            
            <p>To keep things simple, we&#39;ll adopt the convention of naming the manager after the template, except with a <strong>.js</strong> extension. So let&#39;s create <code>posts_list.js</code> inside <code>/client/views/posts</code> right away and start building our first manager:</p>
            <div class="highlight"><pre><span class="kd">var</span> <span class="nx">postsData</span> <span class="o">=</span> <span class="p">[</span>&#x000A;  <span class="p">{</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Introducing Telescope&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Sacha Greif&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://sachagreif.com/introducing-telescope/&#39;</span>&#x000A;  <span class="p">},</span> &#x000A;  <span class="p">{</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Meteor&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Tom Coleman&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://meteor.com&#39;</span>&#x000A;  <span class="p">},</span> &#x000A;  <span class="p">{</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;The Meteor Book&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Tom Coleman&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://themeteorbook.com&#39;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">];</span>&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">posts</span><span class="o">:</span> <span class="nx">postsData</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/posts_list.js</div>
            
            <p>If you&#39;ve done it right, you should now be seeing something similar to this in your browser:</p>
            
            <figure class="screenshot "><img src="images/screenshots/3-1.png" alt="Our first templates with static data"/><figcaption>Our first templates with static data</figcaption></figure>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 3-1</h4><p>Added basic posts list template and static data.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter3-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter3-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>We&#39;re doing two things here. First we&#39;re setting up some dummy prototype data in the <code>postsData</code> array. That data would normally come from the database, but since we haven&#39;t seen how to do that yet (wait for the next chapter) we&#39;re &ldquo;cheating&rdquo; by using static data. </p>
            
            <p>Second, we&#39;re using Meteor&#39;s <code>Template.myTemplate.helpers()</code> function to define a template helper called <code>posts</code> that simply returns our <code>postsData</code> array.  </p>
            
            <p>Defining the <code>posts</code> helper means it is now available for our template to use:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postsList&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;posts&quot;</span><span class="nt">&gt;</span>&#x000A;    {{#each posts}}&#x000A;      {{&gt; postItem}}&#x000A;    {{/each}}&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/posts_list.html</div>
            
            <p>So our template will be able to iterate over our <code>postsData</code> array, and send each object contained within to the <code>postItem</code> template. </p>
            
            <h3>The Value of &ldquo;this&rdquo;</h3>
            
            <p>We&#39;ll now create the <code>post_item.js</code> manager:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">domain</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>&#x000A;    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>&#x000A;    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_item.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 3-2</h4><p>Setup a domain helper on the postItem.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter3-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter3-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>This time our <code>domain</code> helper&#39;s value is not an array, but an anonymous function. This pattern is much more common (and more useful) compared to our previous simplified dummy data examples. </p>
            
            <figure class="screenshot "><img src="images/screenshots/3-2.png" alt="Displaying domains for each links."/><figcaption>Displaying domains for each links.</figcaption></figure>
            
            <p>The <code>domain</code> helper takes a URL and returns its domain via a bit of JavaScript magic. But where does it take that url from in the first place?</p>
            
            <p>To answer that question we need to go back to our <code>posts_list.html</code> template. The <code>{{#each}}</code> block helper not only iterates over our array, it also <strong>sets the value of <code>this</code> inside the block to the iterated object</strong>. </p>
            
            <p>This means that between both <code>{{#each}}</code> tags, each post is assigned to <code>this</code> successively, and that extends all the way inside the included template&#39;s manager (<code>post_item.js</code>). </p>
            
            <p>We now understand why <code>this.url</code> returns the current post&#39;s URL. And moreover, if we use <code>{{title}}</code> and <code>{{url}}</code> inside our <code>post_item.html</code> template, Meteor knows that we mean <code>this.title</code> and <code>this.url</code> and returns the correct values. </p>
            
            <div class="note"><h3>JavaScript Magic</h3>
            
            <p>Although this is not specific to Meteor, here&#39;s a quick explanation of the above bit of “JavaScript magic”. First, we&#39;re creating an empty anchor (<code>a</code>) HTML element and storing it in memory. </p>
            
            <p>We then set its <code>href</code> attribute to be equal to the current post&#39;s URL (as we&#39;ve just seen, in a helper <code>this</code> is the object currently being acted upon).</p>
            
            <p>Finally, we take advantage of that <code>a</code> element&#39;s special <code>hostname</code> property to get back the link&#39;s domain name without the rest of the URL. </p>
            </div>
            
            <p>If you&#39;ve followed along correctly, you should be seeing a list of posts in your browser. That list is just static data, so it doesn&#39;t take advantage of Meteor&#39;s real-time features just yet. We&#39;ll show you how to change that in the next chapter!</p>
            
            <div class="note"><h3>Hot Code Reload</h3>
            
            <p>You might have noticed that you didn&#39;t even need to manually reload your browser window whenever you changed a file. </p>
            
            <p>This is because Meteor tracks all the files within your project directory, and automatically refreshes your browser for you whenever it detects a modification to one of them. </p>
            
            <p>Meteor&#39;s hot code reload is pretty smart, even preserving the state of your app in between two refreshes!</p>
            </div>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='collections'>
              Collections
              <span class='number'>4</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn about Meteor&#39;s core feature: realtime collections.</li>
            <li>Understand how Meteor&#39;s data synchronization works.</li>
            <li>Integrate collections with our templates.</li>
            <li>Turn our basic prototype into a functioning realtime application!</li>
            </ul>
            </div>
            
            <h3>Introduction to Collections</h3>
            
            <p>In chapter one, we spoke about the core feature of Meteor, the automatic synchronisation of data between client and server. In this chapter, we&#39;ll take a closer look at how that works, and observe the operation of the key piece of technology that enables this, the <code>Meteor.Collection</code>.</p>
            
            <p>We are building a social news app, so the first thing we want to do is make a list of links that people have posted. We&#39;ll call each of these items a &ldquo;post.&rdquo;</p>
            
            <p>Naturally, we need to store these posts somewhere. As of this writing, Meteor comes bundled with a Mongo database which runs on your server and is your <em>persistent</em> data store.</p>
            
            <p>So, although a user&#39;s browser may contain some kind of state (for instance which page they are on, or the comment they are currently typing), the server, and specifically Mongo, contains the permanent, canonical data source. By <em>canonical</em>, we mean that it is the same for all users: each user might be on a different page, but the master list of posts is the same for all.</p>
            
            <p>This data is stored in Meteor in the <strong>Collection</strong>. A collection is a special data structure that, along with publications, takes care of the job of synchronising real-time data to and from each connected user&#39;s browser and into the Mongo database. Let&#39;s see how.</p>
            
            <p>We want our posts to be permanent and shared between users, so we&#39;ll start by creating a collection called <code>Posts</code> to store them in. If you haven&#39;t done so already create a <code>collections/</code> folder at the root of your app, and then a <code>posts.js</code> file inside it. Then add:</p>
            <div class="highlight"><pre><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span></pre></div>
            <div class="caption">collections/posts.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 4-1</h4><p>Added a posts collection</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter4-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter4-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Code inside folders that are not <code>client/</code> or <code>server/</code> will run in <em>both</em> contexts. So the <code>Posts</code> collection is available to both client and server. However, what the collection does in each environment is very different.</p>
            
            <div class="note"><h3>To Var Or Not To Var?</h3>
            
            <p>In Meteor, the <code>var</code> keyword limits the scope of an object to the current file. We want to make the <code>Posts</code> collection available to our whole app, which is why we&#39;re omitting that keyword here. </p>
            </div>
            
            <p>On the server, the collection has the job of talking to the Mongo database, and reading and writing any changes. In this sense, it can be compared to a standard database library. On the client however, the collection is a <em>secure</em> copy of a <em>subset</em> of the real, canonical collection. The client-side collection is constantly and (mostly) transparently kept up to date with that subset in real-time.</p>
            
            <h3>Server-side Collections</h3>
            
            <p>On the server, the collection acts as an API into your Mongo database. In your server-side code, this allows you to write Mongo commands like <code>Posts.insert()</code> or <code>Posts.update()</code>, and they will make changes to the <code>posts</code> collection stored inside Mongo.</p>
            
            <p>To look inside the Mongo database, open up a second terminal window (while <code>meteor</code> is still running in your first), and go to your app&#39;s directory. Then, run the command <code>meteor mongo</code> to initiate a Mongo shell, into which you can type standard Mongo commands (and as usual, you can quit it with the <code>ctrl+c</code> keyboard shortcut). For example, let&#39;s insert a new post:</p>
            <div class="highlight"><pre>&gt; db.posts.insert<span class="o">({</span>title: <span class="s2">&quot;A new post&quot;</span><span class="o">})</span>;&#x000A;&#x000A;&gt; db.posts.find<span class="o">()</span>;&#x000A;<span class="o">{</span> <span class="s2">&quot;_id&quot;</span>: ObjectId<span class="o">(</span><span class="s2">&quot;..&quot;</span><span class="o">)</span>, <span class="s2">&quot;title&quot;</span> : <span class="s2">&quot;A new post&quot;</span><span class="o">}</span>;</pre></div>
            <div class="caption">the Mongo console</div>
            
            <div class="note"><h3>Mongo on Meteor.com</h3>
            
            <p>Note that when hosting your app on *.meteor.com, you can also access your deployed app&#39;s Mongo console with <code>meteor mongo myApp</code>. </p>
            
            <p>And while we&#39;re at it, you can also get your app&#39;s logs by typing <code>meteor logs myApp</code>.</p>
            </div>
            
            <p>Mongo&#39;s syntax is familiar, as it uses a JavaScript interface. We won&#39;t be doing any further data manipulation in the Mongo console, but we might take a peek inside from time to time just to make sure what&#39;s in there.</p>
            
            <h3>Client-side Collections</h3>
            
            <p>Collections get more interesting client-side. When you declare <code>Posts = new Meteor.Collection(&#39;posts&#39;);</code> on the client, what you are creating is a <em>local, in-browser cache</em> of the real Mongo collection. When we talk about a client-side collections being a &ldquo;cache&rdquo;, we mean it in the sense that it contains a <em>subset</em> of your data, and offers very <em>quick</em> access to this data.</p>
            
            <p>It&#39;s important to understand this point as it&#39;s fundamental to the way Meteor works. In general, a client side collection consists of a subset of all the documents stored in the Mongo collection (after all, we generally don&#39;t want to send our <em>whole</em> database to the client). </p>
            
            <p>Secondly, those documents are stored <em>in browser memory</em>, which means that accessing them is basically instantaneous. So there are no slow trips to the server or the database to fetch the data when you call <code>Posts.find()</code> on the client, as the data is already pre-loaded.</p>
            
            <div class="note"><h3>Introducing MiniMongo</h3>
            
            <p>Meteor&#39;s client-side Mongo implementation is called MiniMongo. It&#39;s not a perfect implementation yet, and you may encounter occasional Mongo features that don&#39;t work in MiniMongo. </p>
            
            <p>Nevertheless, all the features we cover in this book work similarly in both Mongo and MiniMongo.</p>
            </div>
            
            <h3>Client-Server Communication</h3>
            
            <p>The key piece of all this is how the client-side collection sychronizes its data with the server-side collection of the same name (<code>&#39;posts&#39;</code> in our case).</p>
            
            <p>Rather than explaining this in detail, let&#39;s just watch what happens.</p>
            
            <p>Start by opening up two browser windows, and accessing the console in each one. Then, open up the Mongo console on the command line. At this point, we should see the single document we created earlier in all three contexts.</p>
            <div class="highlight"><pre>&gt; db.posts.find<span class="o">()</span>;&#x000A;<span class="o">{</span>title: <span class="s2">&quot;A new post&quot;</span>, _id: ObjectId<span class="o">(</span><span class="s2">&quot;..&quot;</span><span class="o">)}</span>;</pre></div>
            <div class="caption">Mongo console</div>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">();</span>&#x000A;<span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;A new post&quot;</span><span class="p">,</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">LocalCollection</span><span class="p">.</span><span class="nx">_ObjectID</span><span class="p">};</span></pre></div>
            <div class="caption">First browser console</div>
            
            <p>Now, let&#39;s create a new post. In one of the browser windows, run an insert command:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>&#x000A;<span class="mi">1</span>&#x000A;<span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;A second post&quot;</span><span class="p">});</span>&#x000A;<span class="s1">&#39;xxx&#39;</span>&#x000A;<span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>&#x000A;<span class="mi">2</span></pre></div>
            <div class="caption">First browser console</div>
            
            <p>Unsurprisingly, the post made it into the local collection. Now let&#39;s check Mongo:</p>
            <div class="highlight"><pre>❯ db.posts.find<span class="o">()</span>;&#x000A;<span class="o">{</span>title: <span class="s2">&quot;A new post&quot;</span>, _id: ObjectId<span class="o">(</span><span class="s2">&quot;..&quot;</span><span class="o">)}</span>;&#x000A;<span class="o">{</span>title: <span class="s2">&quot;A second post&quot;</span>, _id: <span class="s1">&#39;yyy&#39;</span><span class="o">}</span>;</pre></div>
            <div class="caption">Mongo console</div>
            
            <p>So as you can see, the post made it all the way back to the Mongo database, without us writing a single line of code to hook our client up to the server (well, strictly speaking, we did write a <em>single</em> line of code: <code>new Meteor.Collection(&#39;posts&#39;)</code>). You might also notice that Meteor&#39;s given the object a string <code>_id</code>, rather than Mongo&#39;s builtin <code>ObjectId</code>. But that&#39;s not all!</p>
            
            <p>Bring up the second browser window and enter this in the browser console:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>&#x000A;<span class="mi">2</span></pre></div>
            <div class="caption">Second browser console</div>
            
            <p>The post is there too! Even though we never refreshed or even interacted with the second browser, and we certainly didn&#39;t write any code to push updates out. It all happened magically &ndash;and instantly too, although this will become more obvious later.</p>
            
            <p>What happened is that our server-side collection was informed by a client collection of a new post, and took on the task of distributing that post into the Mongo database and back out to all the other connected <code>post</code> collections. </p>
            
            <p>Fetching posts on the browser console isn&#39;t that useful. We will learn how to wire this data into our templates, and in the process turn our simple HTML prototype into a functioning realtime web application.</p>
            
            <div class="note"><h3>Collections vs Caches</h3>
            
            <p>The comparison of a collection to a cache is useful to illustrate how fast it is to access, but don&#39;t take the analogy too far!</p>
            
            <p>Where a client-side collection differs from a cache is in the fact that the data loaded into it is fixed and decided by your application. It can be changed as a user browses around, but if you try to find a document that hasn&#39;t been sent to the browser there is no &ldquo;cache-miss&rdquo;, or subsequent server access. It just appears as if the document <em>does not exist</em>.</p>
            
            <p>You explicitly decide, through publications, which data will be loaded into each collection. We&#39;ll learn more about this mechanism soon.</p>
            </div>
            
            <h3>Keeping it Real-time</h3>
            
            <p>Looking at the contents of our Collections on the browser console is one thing, but what we&#39;d really like to do is display the data, and the changes to that data, on the screen. In doing so we&#39;ll turn our app from a simple web <em>page</em> displaying static data, to a realtime web <em>application</em> with dynamic, changing data.</p>
            
            <p>Let&#39;s find out how.</p>
            
            <h3>Populating the Database</h3>
            
            <p>The first thing we&#39;ll do is put some data into the database. We&#39;ll do so with a fixture file that loads a set of structured data into the <code>Posts</code> collection when the server first starts up. </p>
            
            <p>First, let&#39;s make sure there&#39;s nothing in the database. We&#39;ll use <code>meteor reset</code>, which erases your database and resets your project. Of course, you&#39;ll want to be very careful with this command once you start working on real-world projects. </p>
            
            <p>Stop the Meteor server (by pressing <code>ctrl-c</code>) and then, on the command line, run:</p>
            <div class="highlight"><pre><span class="nv">$ </span>meteor reset</pre></div>
            <p>The reset command completely clears out the Mongo database. It&#39;s a useful command in development, where there&#39;s a strong possibility of our database falling into an inconsistent state. </p>
            
            <p>Now that the database is empty, we can add the following code that will load up three posts whenever the server starts and finds the <code>Posts</code> collection empty:</p>
            <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Introducing Telescope&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Sacha Greif&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://sachagreif.com/introducing-telescope/&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Meteor&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Tom Coleman&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://meteor.com&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;The Meteor Book&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Tom Coleman&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://themeteorbook.com&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">server/fixtures.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 4-2</h4><p>Added data to the posts collection.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter4-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter4-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>We&#39;ve placed this file in the <code>server/</code> directory, so it will never get loaded on any user&#39;s browser. The code will run immediately when the server starts, and make <code>insert</code> calls on the database to add three simple posts in our <code>Posts</code> collection. As we haven&#39;t built any data security yet, there&#39;s no real difference between doing this in a file run on the server or in the browser. </p>
            
            <p>Now run your server again with <code>meteor</code>, and these three posts will get loaded into the database.</p>
            
            <h3>Wiring the data to our HTML with helpers</h3>
            
            <p>Now, if we open up a browser console, we see all three posts loaded up into MiniMongo:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">();</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>To get these posts into rendered HTML, we can use a template helper. In Chapter 3 we saw how Meteor allows us to bind a <em>data context</em> to our Handlebars templates to build HTML views of simple data structures. We can bind in our collection data in the exact same way. We&#39;ll just replace our static <code>postsData</code> JavaScript object by a dynamic collection.</p>
            
            <p>Speaking of which, feel free to delete the <code>postsData</code> code at this point. Here&#39;s what <code>posts_list.js</code> should now look like:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">posts</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/posts_list.js</div><div class="lines-highlight" data-lines="2~4" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 4-3</h4><p>Wired collection into postsList template.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter4-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter4-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <div class="note"><h3>Find &amp; Fetch</h3>
            
            <p>In Meteor, <code>find()</code> returns a <em>cursor</em>, which is a <a href="http://docs.meteor.com/#find">reactive data source</a>. When we want to log its contents, we can then use <code>fetch()</code> on that cursor to transform it into an array . </p>
            
            <p>Within an app, Meteor is smart enough to know how to iterate over cursors without having to explicitly convert them into arrays first. This is why you won&#39;t see <code>fetch()</code> that often in actual Meteor code (and why we didn&#39;t use it in the above example).</p>
            </div>
            
            <p>Now, rather than pulling a list of posts as a static array from a variable, we return a cursor to our <code>posts</code> helper. But what does this do? If we go back to our browser, we see:</p>
            
            <figure class="screenshot "><img src="images/screenshots/4-3.png" alt="Using live data"/><figcaption>Using live data</figcaption></figure>
            
            <p>So we can clearly see that our <code>{{#each}}</code> helper has iterated over all of our <code>Posts</code>, and displayed them on the screen. The server-side collection pulled the posts from Mongo, passed them over the wire to our client-side collection, and our handlebars helper passed them into the template. </p>
            
            <p>Now, we&#39;ll take this one step further; let&#39;s add another post via the console:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Meteor Docs&#39;</span><span class="p">,</span> &#x000A;  <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Tom Coleman&#39;</span><span class="p">,</span> &#x000A;  <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://docs.meteor.com&#39;</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>Look back at the browser &ndash; you should see this:</p>
            
            <figure class="screenshot "><img src="images/screenshots/4-4.png" alt="Adding posts via the console"/><figcaption>Adding posts via the console</figcaption></figure>
            
            <p>You have just seen reactivity in action for the first time. When we told handlebars to iterate over the <code>Posts.find()</code> cursor, it knew how to observe that cursor for changes, and patch the HTML in the simplest way to display the correct data on screen.</p>
            
            <div class="note"><h3>Inspecting DOM Changes</h3>
            
            <p>In this case, the simplest change possible was to add another <code>&lt;div class=&quot;post&quot;&gt;...&lt;/div&gt;</code>. If you want to make sure this is really what happened, open the DOM inspector and select the <code>&lt;div&gt;</code> corresponding to one of the existing posts. </p>
            
            <p>Now, in the JavaScript console, insert another post. When you tab back to the inspector, you&#39;ll see an extra <code>&lt;div&gt;</code>, corresponding to the new post, but you will still have the <em>same</em> existing <code>&lt;div&gt;</code> selected. This is a useful way to tell when elements have been re-rendered and when they have been left alone.</p>
            </div>
            
            <h3>Connecting Collections: Publications and Subscriptions</h3>
            
            <p>So far, we&#39;ve had the <code>autopublish</code> package enabled, which is not intended for production applications. As its name indicates, this package simply says that each collection should be shared in its entirety to each connected client. This isn&#39;t what we really want, so let&#39;s turn it off.</p>
            
            <p>Open a new terminal window, and type:</p>
            <div class="highlight"><pre><span class="nv">$ </span>meteor remove autopublish</pre></div>
            <p>This has an instant effect. If you look in your browser now, you&#39;ll see that all our posts have disappeared! This is because we were relying on <code>autopublish</code> to make sure our client-side collection of posts was a mirror of all the posts in the database.  </p>
            
            <p>Eventually we&#39;ll need to make sure we&#39;re only transferring the posts that the user actually needs to see (taking into account things like pagination). But for now, we&#39;ll just setup <code>Posts</code> to be published in its entirety. </p>
            
            <p>To do so, we create a simple <code>publish()</code> function that returns a cursor referencing all posts:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/publications.js</div>
            
            <p>In the client, we need to <em>subscribe</em> to the publication. We&#39;ll just add the following line to <code>main.js</code>:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span></pre></div>
            <div class="caption">client/main.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 4-4</h4><p>Removed autopublish and set up a basic publication.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter4-4" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter4-4.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>If we check the browser again, our posts are back. Phew! </p>
            
            <h3>Conclusion</h3>
            
            <p>So what have we achieved? Well, although we don&#39;t have a user interface yet, what we have now is a functional web application. We could deploy this application to the Internet, and (using the browser console) start posting new stories and see them appear in other user&#39;s browsers all over the world.</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='publicationsandsubscriptions'>
              Publications and Subscriptions
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>4.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Understand how publications and subscriptions work.</li>
            <li>Learn what the default Autopublish package does.</li>
            <li>See a few more examples of publication patterns.</li>
            </ul>
            </div>
            
            <p>Publications and subscriptions are one of the most fundamental and important concepts in Meteor, but can be the most difficult to understand. This is mostly because what they are doing is foreign to developers who are used to more traditional ways of building for the web. </p>
            
            <p>We are used to defining and thinking about our own APIs for passing data between client and server, through explicitly designed and utilized protocols, but in Meteor data is synchronized for us. We don&#39;t need to think directly about how data makes it from client to server. Instead we use publications to control <em>which</em> data is synchronized.</p>
            
            <p>Part of the reason people find the concept a bit confusing initially is the &ldquo;magic&rdquo; that Meteor does for us. Although this magic is ultimately very useful, it can obscure what&#39;s really going on behind the scenes (as magic tends to do). So let&#39;s strip away the layers of magic to try and understand what&#39;s happening.</p>
            
            <h3>Defining Publications</h3>
            
            <p>Fundamentally, a <strong>publication</strong> (which we connect to using a <strong>subscription</strong>) is a method of transferring data from a server-side (source) collection to a client-side (target) collection. Think of the subscription as a funnel  connecting the canonical data store (the source collection, which talks to the Mongo data-store) and the client-side cache (the target collection, which represents a copy or a subset of that data). </p>
            
            <p>The publication controls exactly what data passes through that funnel, and takes care of synchronizing the data between either end. By attaching multiple subscriptions to the server&#39;s data-store, we are able to keep the browser&#39;s view of the data in-sync <em>efficiently</em>, <em>securely</em> and <em>in real-time</em>.</p>
            
            <p>The protocol that is spoken over that tunnel is called DDP (which stands for Distributed Data Protocol). To learn more about DDP, you can watch <a href="http://2012.realtimeconf.com/video/matt-debergalis">this talk from The Real-time Conference</a> by Matt DeBergalis (one of the founders of Meteor), or <a href="http://www.eventedmind.com/posts/meteor-subscriptions-and-ddp">this screencast</a> by Chris Mather that walks you through this concept in a little more detail.</p>
            
            <p>Now that we&#39;ve established the basics, let&#39;s dive in. </p>
            
            <h3>Autopublish</h3>
            
            <p>If you create a Meteor project from scratch (i.e using <code>meteor create</code>), it will automatically have the <code>autopublish</code> package enabled. As a starting point, let&#39;s talk about what that does exactly.</p>
            
            <p>Depending on how you look at it, <code>autopublish</code> either removes the need for publications or simply takes care of them for you. What autopublish does is automatically mirrors <em>all data</em> from the server on the client.</p>
            
            <figure class="diagram pull-center"><img src="images/diagrams/autopublish@2x.png" alt="Autopublish"/><figcaption>Autopublish</figcaption></figure>
            
            <p>How does this work? Suppose you have a collection called <code>&#39;posts&#39;</code> on the server. Then <code>autopublish</code> will automatically send every post that it finds in the Mongo posts collection into a collection called <code>&#39;posts&#39;</code> on the client (assuming there is one).</p>
            
            <p>So if you are using <code>autopublish</code>, you don&#39;t need to think about publications. Data is ubiquitous, and things are simple. Of course, there are obvious problems with having a complete copy of your app&#39;s database cached on every user&#39;s machine. </p>
            
            <p>For this reason, autopublish is only appropriate when you are starting out, and haven&#39;t yet thought about publications.</p>
            
            <h3>Publishing Full Collections</h3>
            
            <figure class="diagram pull-right"><img src="images/diagrams/fullcollection@2x.png" alt="Publishing a full collection"/><figcaption>Publishing a full collection</figcaption></figure>
            
            <p>Once you remove autopublish, you&#39;ll quickly realize that all your data has vanished from the client. An easy way to get it back is to simply duplicate what autopublish does, and publish a collection in its entirety. For example:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;allPosts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;<span class="p">});</span></pre></div>
            <p>We&#39;re still publishing full collections, but at least we now have control over which collections we publish or not. In this case, we&#39;re publishing the <code>Posts</code> collection but not <code>Comments</code>. </p>
            
            <h3>Publishing Partial Collections</h3>
            
            <p>The next level of control is publishing only <em>part</em> of a collection. For example only the posts that belong to a certain author:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;somePosts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">&#39;author&#39;</span><span class="o">:</span><span class="s1">&#39;Tom&#39;</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <figure class="diagram pull-right"><img src="images/diagrams/partialcollection@2x.png" alt="Publishing a partial collection"/><figcaption>Publishing a partial collection</figcaption></figure>
            
            <p>The code is easy enough, but what is actually going on behind the scenes?</p>
            
            <p>If you&#39;ve read the <a href="http://docs.meteor.com/#publishandsubscribe">Meteor publication documentation</a>, you were perhaps overwhelmed by talk of using <code>added()</code> and <code>ready()</code> to set attributes of records on the client, and struggled to square that with the Meteor apps that you&#39;ve seen that never use those methods.</p>
            
            <p>The reason is that Meteor provides a very important convenience: the <code>_publishCursor()</code> method. You&#39;ve never seen that used either? Perhaps not directly, but if you return a <a href="/chapter/meteor-vocabulary/">cursor</a> (i.e. <code>Posts.find({&#39;author&#39;:&#39;Tom&#39;})</code>) in a publish function, that&#39;s exactly what Meteor is using.</p>
            
            <p>When Meteor sees that the <code>somePosts</code> publication has returned a cursor, it calls <code>_publishCursor()</code> to &ndash; you guessed it &ndash; publish that cursor automatically. </p>
            
            <p>Here&#39;s what <code>_publishCursor()</code> does:</p>
            
            <ul>
            <li>It checks the name of the server-side collection.</li>
            <li>It pulls all matching documents from the cursor and sends it into a client-side collection <em>of the same name</em>. (It uses <code>.added()</code> to do this).</li>
            <li>Whenever a document is added, removed or changed, it sends those changes down to the client-side collection. (It uses <code>.observe()</code> on the cursor and <code>.added()</code>, <code>.updated()</code> and <code>removed()</code> to do this).</li>
            </ul>
            
            <p>So in the example above, we are able to make sure that the user only has the posts that they are interested in (the ones written by Tom) available to them in their client side cache.</p>
            
            <h3>Publishing Partial Properties</h3>
            
            <figure class="diagram pull-right"><img src="images/diagrams/partialproperties@2x.png" alt="Publishing partial properties"/><figcaption>Publishing partial properties</figcaption></figure>
            
            <p>We&#39;ve seen how to only publish some of our posts, but we can keep slicing thinner! Let&#39;s see how to only publish specific <em>properties</em>. </p>
            
            <p>Just like before, we&#39;ll use <code>find()</code> to return a cursor, but this time we&#39;ll exclude certain fields:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;allPosts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="kc">false</span>&#x000A;  <span class="p">}});</span>&#x000A;<span class="p">});</span></pre></div>
            <p>Of course, we can also combine both techniques. For example, if we wanted to return all posts by Tom while leaving aside their dates, we would write:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;allPosts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">&#39;author&#39;</span><span class="o">:</span><span class="s1">&#39;Tom&#39;</span><span class="p">},</span> <span class="p">{</span><span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>&#x000A;    <span class="nx">date</span><span class="o">:</span> <span class="kc">false</span>&#x000A;  <span class="p">}});</span>&#x000A;<span class="p">});</span></pre></div>
            <h3>Summing Up</h3>
            
            <p>So we&#39;ve seen how to go from publishing every property of all documents of every collection (with <code>autopublish</code>) to publishing only <em>some</em> properties of <em>some</em> documents of <em>some</em> collections.</p>
            
            <p>This covers the basics of what you can do with Meteor publications, and these simple techniques should take care of the vast majority of use cases. </p>
            
            <p>Sometimes, you&#39;ll need to go further by combining, linking, or merging publications. We will cover these in a later chapter!</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='routing'>
              Routing
              <span class='number'>5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn about routing in Meteor.</li>
            <li>Create post discussion pages, with unique URLs.</li>
            <li>Learn how to link to those URLs properly.</li>
            </ul>
            </div>
            
            <p>Now that we have a list of posts (which will eventually be user-submitted), we need an individual post page where our users will be able to discuss each post.</p>
            
            <p>We&#39;d like these pages to be accessible via a <em>permalink</em>, a URL of the form <code>http://myapp.com/posts/xyz</code> (where <code>xyz</code> is a MongoDB <code>_id</code> identifier) that is unique to each post. </p>
            
            <p>This means we&#39;ll need some kind of <em>routing</em> to look at what&#39;s inside the browser&#39;s URL bar and display the right content accordingly.</p>
            
            <h3>Adding the Iron Router Package</h3>
            
            <p><a href="https://github.com/EventedMind/iron-router">Iron Router</a> is a routing package that was conceived specifically for Meteor apps. </p>
            
            <p>Not only does it help with routing (setting up paths), but it can also take care of filters (assigning actions to some of these paths) and even manage subscriptions (control which path has access to what data). (Note: Iron Router was developed in part by <em>Discover Meteor</em> co-author Tom Coleman.)</p>
            
            <p>First, let&#39;s install the package from Atmosphere: </p>
            <div class="highlight"><pre><span class="nv">$ </span>mrt add iron-router</pre></div>
            <div class="caption">Terminal</div>
            
            <p>This command downloads and installs the iron-router package into our app, ready to use.</p>
            
            <p>Note that the Iron Router is a third-party package, meaning that you&#39;ll need Meteorite to install it (<code>meteor add iron-router</code> won&#39;t work).</p>
            
            <div class="note"><h3>Router Vocabulary</h3>
            
            <p>We&#39;ll be touching on a lot of different features of the router in this chapter. If you have some experience with a framework such as Rails, you&#39;ll already be familiar with most of these concepts. But if not, here&#39;s a quick glossary to bring you up to speed:</p>
            
            <ul>
            <li><strong>Routes</strong>: A route is the basic building block of routing. It&#39;s basically the set of instructions that tell the app where to go and what to do when it encounters a URL. </li>
            <li><strong>Paths</strong>: A path is a URL within your app. It can be static (<code>/terms_of_service</code>) or dynamic (<code>/posts/xyz</code>), and even include query parameters (<code>/search?keyword=meteor</code>).</li>
            <li><strong>Segments</strong>: The differents parts of a path, delimited by forward slashes (<code>/</code>).</li>
            <li><strong>Hooks</strong>: Hooks are actions that you&#39;d like to perform before, after, or even during the routing process. A typical example would be checking if the user has the proper rights before displaying a page. </li>
            <li><strong>Filters</strong>: Filters are simply hooks that you define globally for one or more routes. </li>
            <li><strong>Route Templates</strong>: Each route needs to point to a template. If you don&#39;t specify one, the router will look for a template with the same name as the route by default.</li>
            <li><strong>Layouts</strong>: You can think of layouts as one of those digital photo frames. They contain all the HTML code that wraps the current template, and will remain the same even if the template changes.</li>
            <li><strong>Controllers</strong>: Sometimes, you&#39;ll realize that a lot of your templates are reusing the same parameters. Rather than duplicate your code, you can let all these routes inherit from a single <em>routing controller</em> which will contain all the routing logic. </li>
            </ul>
            
            <p>For more information about Iron Router, check out <a href="https://github.com/EventedMind/iron-router">the full documentation on GitHub</a>. </p>
            </div>
            
            <h3>Routing: mapping URLs to templates</h3>
            
            <p>So far, we&#39;ve built our layout using hard-coded template includes (such as <code>{{&gt;header}}</code>.  So although the content of our app can change, the page&#39;s basic structure is always the same: a header, with a list of posts below it.</p>
            
            <p>The Iron Router lets us break out of this mold by taking over what renders inside the HTML <code>&lt;body&gt;</code> tag. So we won&#39;t define that tag&#39;s content ourselves, as we would with a regular HTML page. Instead, we will point the router to a special layout template that contains a <code>{{yield}}</code> template helper. </p>
            
            <p>This <code>{{yield}}</code> helper will define a special dynamic zone that will automatically render whichever template corresponds to the current route (as a convention, we&#39;ll designate this special template as the “route templates” from now on):</p>
            
            <figure class="diagram pull-center"><img src="images/diagrams/router-diagram@2x.png" alt="Layouts and templates."/><figcaption>Layouts and templates.</figcaption></figure>
            
            <p>We&#39;ll start by creating our layout and adding the <code>{{yield}}</code> helper. First, we&#39;ll remove our HTML <code>&lt;body&gt;</code> tag and move our layout code to its own template, <code>layout.html</code>:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;layout&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/header&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">class=</span><span class="s">&quot;row-fluid&quot;</span><span class="nt">&gt;</span>&#x000A;    {{yield}}&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/application/layout.html</div>
            
            <p>We&#39;ve replaced the inclusion of the <code>postsList</code> template with a call to <code>yield</code> helper. You&#39;ll notice that after this change, we see nothing on the screen. This is because we haven&#39;t told the router what to do with the <code>/</code> URL yet, so it simply serves up an empty template.</p>
            
            <p>To begin, we can regain our old behaviour by mapping the root <code>/</code> URL to the <code>postsList</code> template. We&#39;ll create a <code>/lib</code> directory at our project&#39;s root, and inside it create <code>router.js</code> :</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/helpers/router.js</div>
            
            <p>We&#39;ve done two important things. First, we&#39;ve told the router to use the layout we just created as the default layout for all routes. Second, we&#39;ve defined a new route called <code>postsList</code> and mapped it to the <code>/</code> path. </p>
            
            <div class="note"><h3>The <code>/lib</code> folder</h3>
            
            <p>Anything you put inside the <code>/lib</code> folder is guaranteed to load first before anything else in your app (with the possible exception of smart packages). This makes it a great place to put any helper code that needs to be available at all times. </p>
            
            <p>A bit of warning though: note that since the <code>/lib</code> folder is neither inside <code>/client</code> or <code>/server</code>, this means its contents will be available to both environments.</p>
            </div>
            
            <h3>Named Routes</h3>
            
            <p>Let&#39;s clear up a bit of ambiguity here. We named our route <code>postsList</code>, but we also have a <em>template</em> called <code>postsList</code>. So what&#39;s going on here?</p>
            
            <p>By default, Iron Router will look for a template with the same name as the route. In fact, it will even look for a <em>path</em> based on the route name, meaning that if we hadn&#39;t defined a custom path (which we did by providing a <code>path</code> option in our route definition), our template would&#39;ve been accessible at URL <code>/postLists</code> by default. </p>
            
            <p>You may be wondering why we even need to name our routes in the first place. Naming routes lets us use a few Iron Router features that make it easier to build links inside our app. The most useful one is the <code>{{pathFor}}</code> Handlebars helper,  which returns the URL path component of any route.</p>
            
            <p>We want our main home link to point us back to the posts list, so instead of specifying a static <code>/</code> URL, we can also use the Handlebars helper. The end result will be the same, but this gives us more flexibility since the helper will always output the right URL even if we change the route&#39;s path in the router. </p>
            <div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postsList&#39;}}&quot;</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/header&gt;</span></pre></div>
            <div class="caption">client/views/application/layout.html</div><div class="lines-highlight" data-lines="3" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 5-1</h4><p>Very basic routing.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter5-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter5-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Waiting on Data</h3>
            
            <p>If you deploy the current version of the app (or launch the instance using the link above), you&#39;ll notice that the list appears empty for a few moments before the posts appear. This is because when the page first loads, there are no posts to display until the <code>posts</code> subscription is done grabbing the post data from the server.</p>
            
            <p>It would be a much better user experience to provide some visual feedback that something is happening, and that the user should wait a moment.</p>
            
            <p>Luckily, Iron Router gives us an easy way to do that &ndash; we&#39;ll <code>waitOn</code> the subscription:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">loadingTemplate</span><span class="o">:</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span> <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="3,4" data-class="added"></div>
            
            <p>Let&#39;s break things down. First, we&#39;ve modified the <code>Router.configure()</code> block to provide the router with the name of a loading template (which we&#39;ll create soon) to redirect to while our app is waiting for data. </p>
            
            <p>Second, we&#39;ve also added a <code>waitOn</code> function, which returns our <code>posts</code> subscription. What this means is that the router will ensure that the <code>posts</code> subscription is loaded before sending the user through to the route they requested.</p>
            
            <p>Note that since we&#39;re defining our <code>waitOn</code> function globally at the router level, this sequence will only happen once when a user first accesses your app. After that, the data will already be loaded in the browser&#39;s memory and the router won&#39;t need to wait for it again. </p>
            
            <p>And since we are now letting the router handle our subscription, you can now safely remove it from <code>main.js</code> (which should now be empty). </p>
            
            <p>It&#39;s usually a good idea to wait on your subscriptions, not just for the user experience, but also because it means you can safely assume that data will always be available from within a template. This eliminates the need to deal with templates being rendered before their underlying data is available, which often requires tricky workarounds. </p>
            
            <p>The final piece of the puzzle is the actual loading template. We&#39;ll use the <code>spin</code> package to create a nice animated loading spinner. Add it with <code>mrt add spin</code>, and then create the <code>loading</code> template as follows:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;loading&quot;</span><span class="nt">&gt;</span>&#x000A;  {{&gt;spinner}}&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/includes/loading.html</div>
            
            <p>Note that <code>{{&gt;spinner}}</code> is a partial contained in the <code>spin</code> package. Even though this partial comes from “outside” our app, we can include it just like any other template. </p>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 5-2</h4><p>Wait on the post subscription.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter5-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter5-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <div class="note"><h3>A First Glance At Reactivity</h3>
            
            <p>Reactivity is a core part of Meteor, and although we&#39;ve yet to really touch on it, our loading template gives us a first glance at this concept. </p>
            
            <p>Redirecting to a loading template if data isn&#39;t loaded yet is all well and good, but how does the router knows when to redirect the user <em>back</em> to the right page once the data comes through?</p>
            
            <p>For now, let&#39;s just say that this is exactly where reactivity comes in, and leave it at this. But don&#39;t worry, you&#39;ll learn more about it very soon!</p>
            </div>
            
            <h3>Routing To A Specific Post</h3>
            
            <p>Now that we&#39;ve seen how to route to the <code>postsList</code> template, let&#39;s set up a route to display the details of a single post. </p>
            
            <p>There&#39;s just one catch: we can&#39;t go ahead and define one route per post, since there might be hundreds of them. So we&#39;ll need to set up a single <em>dynamic</em> route, and make that route display any post we want. </p>
            
            <p>To start with, we&#39;ll create a new template that simply renders the same post template that we used earlier in the list of posts.</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postPage&quot;</span><span class="nt">&gt;</span>&#x000A;  {{&gt; postItem}}&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_page.html</div>
            
            <p>We&#39;ll add more elements to this template later on (such as comments), but for now it&#39;ll simply serve as a shell for our <code>{{&gt; postItem}}</code> include. </p>
            
            <p>We are going to create another named route, this time mapping URL paths of the form <code>/posts/&lt;ID&gt;</code> to the <code>postPage</code> template:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/helpers/router.js</div><div class="lines-highlight" data-lines="4~6" data-class="added"></div>
            
            <p>The special <code>:_id</code> syntax tells the router two things: first, to match any route of the form <code>/posts/xyz/</code>, where “xyz” can be anything at all. Second, to put whatever it finds in this “xyz” spot inside an <code>_id</code> property in the router&#39;s <code>params</code> array. </p>
            
            <p>Note that we&#39;re only using <code>_id</code> for convenience&#39;s sake here. The router has no way of knowing if you&#39;re passing it an actual <code>_id</code>, or just some random string of characters. </p>
            
            <p>We&#39;re now routing to the correct template, but we&#39;re still missing something: the router knows the <code>_id</code> of the post we&#39;d like to display, but the template still has no clue. So how do we bridge that gap?</p>
            
            <p>Thankfully, the router has a clever built-in solution: it lets you specify a template&#39;s <strong>data context</strong>. You can think of the data context as the filling inside a delicious cake made of templates and layouts. Simply put, it&#39;s what you fill up your template with:</p>
            
            <figure class="diagram pull-center"><img src="images/diagrams/router-diagram-2@2x.png" alt="The data context."/><figcaption>The data context.</figcaption></figure>
            
            <p>In our case, we can get the proper data context by looking for our post based on the <code>_id</code> we got from the URL: </p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/helpers/router.js</div><div class="lines-highlight" data-lines="4~7" data-class="added"></div>
            
            <p>So every time a user accesses this route, we&#39;ll find the appropriate post and pass it to the template. Remember that <code>findOne</code> returns a single post that matches a query, and that providing just an <code>id</code> as an argument is a shorthand for <code>{_id: id}</code>. </p>
            
            <p>Within the <code>data</code> function for a route, <code>this</code> corresponds to the currently matched route, and we can use <code>this.params</code> to access the named parts of the route (which we indicated by prefixing them with <code>:</code> inside our <code>path</code>).</p>
            
            <div class="note"><h3>More About Data Contexts</h3>
            
            <p>By setting a template&#39;s <em>data context</em>, you can control the value of <code>this</code> inside template helpers.</p>
            
            <p>This is usually done implicitly with the <code>{{#each}}</code> iterator, which automatically sets the data context of each iteration to the item currently being iterated on:</p>
            
            <pre><code class="html">{{#each widgets}}&#x000A;  {{&gt; widgetItem}}&#x000A;{{/each}}&#x000A;</code></pre>
            
            <p>But we can also do it explicitly using <code>{{#with}}</code>, which simply says &ldquo;take this object, and apply the following template to it&rdquo;. For example, we can write:</p>
            
            <pre><code class="html">{{#with myWidget}}&#x000A;  {{&gt; widgetPage}}&#x000A;{{/with}}&#x000A;</code></pre>
            
            <p>It turns out you can achieve the same result by passing the context as an <em>argument</em> to the template call. So the previous block of code can be rewritten as:</p>
            
            <pre><code class="js">{{&gt; widgetPage myWidget}}&#x000A;</code></pre>
            </div>
            
            <h3>Using a Dynamic Named Route Helper</h3>
            
            <p>Finally, we need to make sure that we&#39;re pointing to the right place whevener we want to link to an individual post. Again, we could do something like <code>&lt;a href=&quot;/posts/{{_id}}&gt;</code>, but using a route helper is just more reliable. </p>
            
            <p>We&#39;ve named the post route <code>postPage</code>, so we can use a <code>{{pathFor &#39;postPage&#39;}}</code> helper:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postItem&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post-content&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url}}&quot;</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postPage&#39;}}&quot;</span> <span class="na">class=</span><span class="s">&quot;discuss btn&quot;</span><span class="nt">&gt;</span>Discuss<span class="nt">&lt;/a&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_item.html</div><div class="lines-highlight" data-lines="6" data-class="added"></div><div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 5-3</h4><p>Routing to a single post page.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter5-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter5-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>But wait, how exactly does the router know where to get the <code>xyz</code> part in <code>/posts/xyz</code>? After all, we&#39;re not passing it any <code>_id</code>. </p>
            
            <p>It turns out that Iron Router is smart enough to figure it out by itself. We&#39;re telling the router to use the <code>postPage</code> route, and the router knows that this route requires an <code>_id</code> of some kind (since that&#39;s how we defined our <code>path</code>) .</p>
            
            <p>So the router will look for this <code>_id</code> in the most logical place available: the data context of the <code>{{pathFor &#39;postPage&#39;}}</code> helper, in other words <code>this</code>. And it so happens that our <code>this</code> corresponds to a post, which (surprise!) does possess an <code>_id</code> property. </p>
            
            <p>Alternatively, you can also explicitely tell the router where you&#39;d like it to look for the <code>_id</code> property, by passing a second argument to the helper (i.e. <code>{{pathFor &#39;postPage&#39; someOtherPost}}</code>). A practical use of this pattern would be getting the link to the previous or next posts in a list, for example. </p>
            
            <p>To see if it works correctly, browse to the post list and click on one of the &#39;Discuss&#39; links. You should see something like this:</p>
            
            <figure class="screenshot "><img src="images/screenshots/5-2.png" alt="A single post page."/><figcaption>A single post page.</figcaption></figure>
            
            <div class="note"><h3>HTML5 pushState</h3>
            
            <p>One thing to realise is that these URL changes are happening using <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/Manipulating_the_browser_history?redirectlocale=en-US&amp;redirectslug=Web%2FGuide%2FDOM%2FManipulating_the_browser_history">HTML5 pushState</a>. </p>
            
            <p>The Router picks up clicks on URLs that are internal to the site, and prevents the browser from browsing away from the app, instead just making the necessary changes to the app&#39;s state. </p>
            
            <p>If everything is working correctly the page should change instantaneously. In fact, sometimes things change so fast that some kind of page transition might be needed. This is outside of the scope of this chapter, but an interesting topic nonetheless.</p>
            </div>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='thesession'>
              The Session
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>5.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn about the Meteor Session</li>
            <li>Learn about the autorun function</li>
            <li>Learn about Hot Code Reload</li>
            </ul>
            </div>
            
            <p>Meteor is a reactive framework. What this means is that as data changes, things in your application change without you having to explicitly do anything. We&#39;ve already seen this in action in how our templates change as the data and the route changes.</p>
            
            <p>We&#39;ll dive deeper into how this works in later chapters, but for now, we&#39;d like to introduce some basic reactive features that are extremely useful in general apps.</p>
            
            <h3>The Meteor Session</h3>
            
            <p>Right now in Microscope, the current state of the the user&#39;s application is completely contained in the URL that they are looking at (and the database). </p>
            
            <p>But in many cases, you&#39;ll need to store some ephemeral state that is only relevant to the current user&#39;s version of the application (for example, if an element is shown or hidden). The Session is a convienent way to do this.</p>
            
            <p>The Session is a global reactive data store. It&#39;s global in the sense of a global singleton object: there&#39;s one session, and it&#39;s accessible everywhere. Global variables are usually seen as a bad thing, but in this case the session is used as a central communication bus for different parts of the application. </p>
            
            <h3>Changing the Session</h3>
            
            <p>The Session is available everywhere as <code>Session</code>. To set a session value, you can call:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">,</span> <span class="s1">&#39;A different title&#39;</span><span class="p">);</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>You can read the data back out again with <code>Session.get(&#39;mySessionProperty&#39;);</code>. This is a reactive data source, which means that if you were to put it in a helper, you would see the helper&#39;s output change reactively as the Session variable is changed.</p>
            
            <p>To try this, add the following code to the layout template:</p>
            <div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postsList&#39;}}&quot;</span><span class="nt">&gt;</span>{{pageTitle}}<span class="nt">&lt;/a&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/header&gt;</span></pre></div>
            <div class="caption">client/views/application/layout.html</div>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">pageTitle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">);</span> <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <p>Meteor&#39;s automatic reload (know as the “hot code reload” or HCR) preserves Session variables, so we should now see &ldquo;A different title&rdquo; displayed in the nav bar. If not, just type the previous <code>Session.set()</code> command again. </p>
            
            <p>Moreover if we change the value once more (again in the browser console), we should see yet another title displayed:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">,</span> <span class="s1">&#39;A brand new title&#39;</span><span class="p">);</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>The Session is globally available, so such changes can be made anywhere in the application. This gives us a lot of power, but can also be a trap if used too much.</p>
            
            <div class="note"><h3>Identical Changes</h3>
            
            <p>If you modify a Session variable with <code>Session.set()</code> but set it to an identical value, Meteor is smart enough to bypass the reactive chain, and avoid unnecessary method calls. </p>
            </div>
            
            <h3>Introducing Autorun</h3>
            
            <p>We&#39;ve looked at an example of a reactive data source, and watched it in action inside a template helper. But while some contexts in Meteor (such as template helpers) are inherently reactive, the majority of a Meteor&#39;s app code is still plain old non-reactive JavaScript. </p>
            
            <p>Let&#39;s suppose we have the following code snippet somewhere in our app:</p>
            <div class="highlight"><pre><span class="nx">helloWorld</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="nx">alert</span><span class="p">(</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">));</span>&#x000A;<span class="p">}</span></pre></div>
            <p>Even though we&#39;re calling a Session variable, the <em>context</em> in which it&#39;s called is not reactive, meaning that we won&#39;t get new <code>alert</code>s every time we change the variable. </p>
            
            <p>This is where <a href="http://docs.meteor.com/#deps_autorun">Autorun</a> comes in. As the name implies, the code inside an <code>autorun</code> block will automatically run and keep running each and every time the reactive data sources used inside it change.</p>
            
            <p>Try typing this into the browser console:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Deps</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Value is: &#39;</span> <span class="o">+</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">));</span>&#x000A;<span class="p">});</span>&#x000A;<span class="nx">Value</span> <span class="nx">is</span><span class="o">:</span> <span class="nx">A</span> <span class="nx">brand</span> <span class="k">new</span> <span class="nx">title</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>As you might expect, the block of code provided inside the <code>autorun</code> runs once, outputting its data to the console. Now, let&#39;s try changing the title:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">,</span> <span class="s1">&#39;Yet another value&#39;</span><span class="p">);</span>&#x000A;<span class="nx">Value</span> <span class="nx">is</span><span class="o">:</span> <span class="nx">Yet</span> <span class="nx">another</span> <span class="nx">value</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>Magic! As the session value changed, the <code>autorun</code> knew it had to run its contents all over again, re-outputting the new value to the console. </p>
            
            <p>So going back to our previous example, if we want to trigger a new alert every time our Session variable changes, all we need to do is wrap our code in an <code>autorun</code> block:</p>
            <div class="highlight"><pre><span class="nx">Deps</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="nx">alert</span><span class="p">(</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">));</span>&#x000A;<span class="p">}</span></pre></div>
            <p>As we&#39;ve just seen, autoruns can be very useful to track reactive datasources and react imperatively to them. </p>
            
            <h3>Hot Code Reload</h3>
            
            <p>During our development of Microscope, we&#39;ve been taking advantage of one of Meteor&#39;s time-saving features: hot code reload (HCR). Whenever we save one of our source code files, Meteor detects the changes and transparently restarts the running Meteor server, informing each client to reload the page.</p>
            
            <p>This is similar to an automatic reload of the page, but with an important difference. </p>
            
            <p>To find out what that is, start by resetting the session variable we&#39;ve been using:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">,</span> <span class="s1">&#39;A brand new title&#39;</span><span class="p">);</span>&#x000A;<span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">);</span>&#x000A;<span class="s1">&#39;A brand new title&#39;</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>If we were to reload our browser window manually, our Session variables would naturally be lost (since this would create a new session). On the other hand, if we trigger a hot code reload (for example, by saving one of our source files) the page will reload, but the session variable will still be set. Try it now!</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">);</span>&#x000A;<span class="s1">&#39;A brand new title&#39;</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>So if we&#39;re using session variables to keep track of exactly what the user is doing, the HCR should be almost transparent to the user, as it will preserve the value of all session variables. This enables us to deploy new production versions of our Meteor application with the confidence that our users will be minimally disrupted.</p>
            
            <p>Consider this for a moment. If we can manage to keep all of our state in the URL and the session, we can transparently change the <em>running source code</em> of each client&#39;s application underneath them with minimal disruption.</p>
            
            <p>Let&#39;s now check what happens when we refresh the page manually:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">);</span>&#x000A;<span class="kc">null</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>When we reloaded the page, we lost the session. On an HCR, Meteor saves the session to local storage in your browser and loads it in again after the reload. However, the alternate behaviour on explicit reload makes sense: if a user reloads the page, it&#39;s as if they&#39;ve browsed to the same URL again, and they should be reset to the starting state that any user would see when they visit that URL.</p>
            
            <p>The important lessons in all this are:</p>
            
            <ol>
            <li>Always store user state in the Session or the URL so that users are minimally disrupted when a hot code reload happens.</li>
            <li>Store any state that you want to be shareable between users <em>within the URL itself</em>.</li>
            </ol>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='addingusers'>
              Adding Users
              <span class='number'>6</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn about user accounts in Meteor.</li>
            <li>Add all the authentication we&#39;ll need for Microscope.</li>
            <li>Use the built-in <code>accounts-ui</code> package to get an instant user interface.</li>
            </ul>
            </div>
            
            <p>So far, we&#39;ve managed to create and display some static fixture data in a sensible fashion and wire it together into a simple prototype. We&#39;ve even seen how our UI is responsive to changes in the data, and inserted or changed data appears immediately. Still, our site is hamstrung by the fact that we can&#39;t enter data. In fact, we don&#39;t even have users yet! </p>
            
            <p>Let&#39;s see how we can fix that.</p>
            
            <h3>Accounts: users made simple</h3>
            
            <p>In most web frameworks, adding user accounts is a familiar drag. Sure, you have to do it on almost every project, but it&#39;s never as easy as it could be. What&#39;s more, as soon as you have to deal with OAuth or other 3rd party authentication schemes, things tend to get ugly fast.</p>
            
            <p>Luckily, Meteor has you covered. Thanks to the way Meteor packages can contribute code on both the server (JavaScript) and client (JavaScript, HTML, and CSS) side, we can get an accounts system almost for free. </p>
            
            <p>We could just use Meteor&#39;s built-in UI for accounts (with <code>mrt add accounts-ui</code>) but since we&#39;ve built our whole app with Bootstrap, we&#39;ll use the <code>accounts-ui-bootstrap-dropdown</code> package instead (don&#39;t worry, the only difference is the styling). On the command line, we type:</p>
            <div class="highlight"><pre><span class="nv">$ </span>mrt add accounts-ui-bootstrap-dropdown&#x000A;<span class="nv">$ </span>mrt add accounts-password</pre></div>
            <div class="caption">Terminal</div>
            
            <p>Those two commands make the special accounts templates available to us; we can include them in our site using the <code>{{loginButtons}}</code> helper. A handy tip: you can control on which side your log-in dropdown shows up using the <code>align</code> attribute (for example: <code>{{loginButtons  align=&quot;right&quot;}}</code>).</p>
            
            <p>We&#39;ll add the buttons to our header. And since that header is starting to grow larger, let&#39;s give it more room in its own template (we&#39;ll put it in <code>client/views/includes/</code>). We&#39;re also using some extra markup and Bootstrap classes to make sure everything looks nice:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;layout&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>&#x000A;    {{&gt;header}}&#x000A;    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">class=</span><span class="s">&quot;row-fluid&quot;</span><span class="nt">&gt;</span>&#x000A;      {{yield}}&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/application/layout.html</div><div class="lines-highlight" data-lines="6" data-class="added"></div>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;header&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;      <span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postsList&#39;}}&quot;</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;nav-collapse collapse&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;li&gt;</span>{{loginButtons}}<span class="nt">&lt;/li&gt;</span>&#x000A;      <span class="nt">&lt;/ul&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/header&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/includes/header.html</div>
            
            <p>Now, when we browse to our app, we see the accounts login buttons in the top right hand corner of our site.</p>
            
            <figure class="screenshot "><img src="images/screenshots/6-1.png" alt="Meteor's built-in accounts UI"/><figcaption>Meteor&rsquo;s built-in accounts UI</figcaption></figure>
            
            <p>We can use these to sign up, log in, request a change of password, and everything else that a simple site needs for password-based accounts.</p>
            
            <p>To tell our accounts system that we want users to log-in via a username, we simply add an <code>Accounts.ui</code> config block in a new <code>config.js</code> file inside <code>client/helpers/</code>:</p>
            <div class="highlight"><pre><span class="nx">Accounts</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>&#x000A;  <span class="nx">passwordSignupFields</span><span class="o">:</span> <span class="s1">&#39;USERNAME_ONLY&#39;</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/helpers/config.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 6-1</h4><p>Added accounts and added template to the header</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter6-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter6-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Creating Our First User</h3>
            
            <p>Go ahead and sign up for an account: the &ldquo;Sign in&rdquo; button will change to show your username. This confirms that a user account has been created for you. But where is that user account data coming from? </p>
            
            <p>By adding the <code>accounts</code> package, Meteor has created a special new collection, which can be accessed at <code>Meteor.users</code>. To see it, open your browser console and type:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">();</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>The console should return an object representing your user object; if you take a look, you can see that your username is in there, as well as an <code>_id</code> that uniquely identifies you. Note that you can also get the currently logged-in user with <code>Meteor.user()</code>.</p>
            
            <p>Now log out and sign up again with a different username. <code>Meteor.user()</code> should now return a second user. But wait, let&#39;s run:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>&#x000A;<span class="mi">1</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>The console returns 1. Hold on, shouldn&#39;t that be 2? Has the first user been deleted? If you try logging in as that first user again, you&#39;ll see that&#39;s not the case.</p>
            
            <p>Let&#39;s make sure and check in the canonical data-store, the Mongo database. We&#39;ll log into Mongo (<code>meteor mongo</code> in your terminal) and check:</p>
            <div class="highlight"><pre>&gt; db.users.count<span class="o">()</span>&#x000A;2</pre></div>
            <div class="caption">Mongo console</div>
            
            <p>There are definitely two users. So why can we only see a single one at a time in the browser?</p>
            
            <h3>A Mystery Publication!</h3>
            
            <p>If you think back to Chapter 4, you might remember that by turning off <code>autopublish</code>, we stopped collections from automatically sending all the data from the server into each connected client&#39;s local version of the collection.  We needed to create a publication and subscripton pair to channel the data across. </p>
            
            <p>Yet we never set up any kind of user publication. So how come we can even see any user data at all?</p>
            
            <p>The answer is that the accounts package actually does &ldquo;auto-publish&rdquo; the currently logged in user&#39;s basic account details no matter what. If it didn&#39;t, then that user could never log in to the site!</p>
            
            <p>The accounts package only publishes the <em>current</em> user though. This explains why one user can&#39;t see another&#39;s account details.</p>
            
            <p>So the publication is only publishing one user object per logged-in user (and none when you are not logged in).</p>
            
            <p>What&#39;s more, documents in our user collection don&#39;t seem to contain the same fields on the server and on the client. In Mongo, a user has a lot of data in it. To see it, just go back to your Mongo terminal and type:</p>
            <div class="highlight"><pre>&gt; db.users.findOne<span class="o">()</span>&#x000A;<span class="o">{</span>&#x000A;    <span class="s2">&quot;createdAt&quot;</span> : 1365649830922,&#x000A;    <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;kYdBd9hr3fWPGPcii&quot;</span>,&#x000A;    <span class="s2">&quot;services&quot;</span> : <span class="o">{</span>&#x000A;        <span class="s2">&quot;password&quot;</span> : <span class="o">{</span>&#x000A;            <span class="s2">&quot;srp&quot;</span> : <span class="o">{</span>&#x000A;                <span class="s2">&quot;identity&quot;</span> : <span class="s2">&quot;qyFCnw4MmRbmGyBdN&quot;</span>,&#x000A;                <span class="s2">&quot;salt&quot;</span> : <span class="s2">&quot;YcBjRa7ArXn5tdCdE&quot;</span>,&#x000A;                <span class="s2">&quot;verifier&quot;</span> : <span class="s2">&quot;df2c001edadf4e475e703fa8cd093abd4b63afccbca48fad1d2a0986ff2bcfba920d3f122d358c4af0c287f8eaf9690a2c7e376d701ab2fe1acd53a5bc3e843905d5dcaf2f1c47c25bf5dd87764d1f58c8c01e4539872a9765d2b27c700dcdedadf5ac82521467356d3f91dbeaf9848158987c6d359c5423e6b9cabf34fa0b45&quot;</span>&#x000A;            <span class="o">}</span>&#x000A;        <span class="o">}</span>,&#x000A;        <span class="s2">&quot;resume&quot;</span> : <span class="o">{</span>&#x000A;            <span class="s2">&quot;loginTokens&quot;</span> : <span class="o">[</span>&#x000A;                <span class="o">{</span>&#x000A;                    <span class="s2">&quot;token&quot;</span> : <span class="s2">&quot;BMHipQqjfLoPz7gru&quot;</span>,&#x000A;                    <span class="s2">&quot;when&quot;</span> : 1365649830922&#x000A;                <span class="o">}</span>&#x000A;            <span class="o">]</span>&#x000A;        <span class="o">}</span>&#x000A;    <span class="o">}</span>,&#x000A;    <span class="s2">&quot;username&quot;</span> : <span class="s2">&quot;tmeasday&quot;</span>&#x000A;<span class="o">}</span></pre></div>
            <div class="caption">Mongo console</div>
            
            <p>On the other hand, in the browser the user object is much more pared down, as you can see by typing the equivalent command:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">();</span>&#x000A;<span class="nb">Object</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;kYdBd9hr3fWPGPcii&quot;</span><span class="p">,</span> <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tmeasday&quot;</span><span class="p">}</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>This example shows us how a local collection can be a <em>secure subset</em> of the real database. The logged-in user only sees enough of the real dataset to get the job done (in this case, signing in). This is a useful pattern to learn from, as you&#39;ll see later on. </p>
            
            <p>That doesn&#39;t mean you can&#39;t make more user data public if you want to. You can refer to the <a href="http://docs.meteor.com/#meteor_users">Meteor docs</a> to see how to optionally publish more fields in the <code>Meteor.users</code> collection.</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='reactivity'>
              Reactivity
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>6.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn about Meteor&#39;s reactive code dependency system.</li>
            <li>Understand the motivations and how it makes code declarative.</li>
            <li>Learn to use advanced code that uses reactive data.</li>
            </ul>
            </div>
            
            <p>If collections are Meteor&#39;s core feature, then <em>reactivity</em> is the shell that makes that core useful.</p>
            
            <p>Collections radically transform the way your application deals with data changes. Rather than having to check for data changes manually (e.g. through an AJAX call) and then patch those changes into your HTML, data changes can instead come in at any time and get applied to your user interface seamlessly by Meteor.</p>
            
            <p>Take a moment to think it through: behind the scenes, Meteor is able to change <em>any</em> part of your user interface when an underlying collection is updated.</p>
            
            <p>The <em>imperative</em> way to do this would be to use <code>.observe()</code>, a cursor function that fires callbacks when documents matching that cursor change. We could then make changes to the DOM (the rendered HTML of our webpage) through those callbacks. The resulting code would look something like this:</p>
            <div class="highlight"><pre><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">observe</span><span class="p">({</span>&#x000A;  <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">// when &#39;added&#39; callback fires, add HTML element</span>&#x000A;    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;ul&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li id=&quot;&#39;</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">changed</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">// when &#39;changed&#39; callback fires, modify HTML element&#39;s text</span>&#x000A;    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;ul li#&#39;</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">removed</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">// when &#39;removed&#39; callback fires, remove HTML element</span>&#x000A;    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;ul li#&#39;</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">detach</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <p>You can probably already see how such code is going to get complex pretty quickly. Imagine dealing with changes to <em>each attribute</em> of the post, and having to change complex HTML within the post&#39;s <code>&lt;li&gt;</code>. Not to mention all the complicated edge cases that can come out when we start relying on multiple sources of information that can all change in realtime. </p>
            
            <div class="note"><h3>When <em>Should</em> We Use <code>observe()</code>?</h3>
            
            <p>Using the above pattern is sometimes necessary, especially when dealing with third-party widgets. For example, let&#39;s imagine we want to add or remove pins on a map in real time based on Collection data (say, to show the locations of currently logged in users).</p>
            
            <p>In such cases, you&#39;ll need to use <code>observe()</code> callbacks in order to get the map to &ldquo;talk&rdquo; with the Meteor collection and know how to react to data changes. For example, you would rely on the <code>added</code> and <code>removed</code> callbacks to call the map API&#39;s own <code>dropPin()</code> or <code>removePin()</code> methods.</p>
            </div>
            
            <h3>A Declarative Approach</h3>
            
            <p>Meteor provides us with a better way: reactivity, which is at its core a <strong>declarative</strong> approach. Being declarative lets us define the relationship between objects once and know they&#39;ll be kept in sync, instead of having to specify behaviors for every possible change. </p>
            
            <p>This is a powerful concept, because a realtime system has many inputs that can all change at unpredictable times. By declaratively stating how we render HTML based on whatever reactive data sources we care about, Meteor can take care of the job of monitoring those sources and transparently take on the messy job of keeping the user interface up to date.</p>
            
            <p>All this to say that instead of thinking about <code>observe</code> callbacks, Meteor lets us write:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postsList&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;ul&gt;</span>&#x000A;    {{#each posts}}&#x000A;      <span class="nt">&lt;li&gt;</span>{{title}}<span class="nt">&lt;/li&gt;</span>&#x000A;    {{/each}}&#x000A;  <span class="nt">&lt;/ul&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <p>And then get our list of posts with:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">posts</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <p>Behind the scenes, Meteor is wiring up <code>observe()</code> callbacks for us, and re-drawing the relevant sections of HTML when the reactive data changes.</p>
            
            <h3>Dependency Tracking in Meteor: Computations</h3>
            
            <p>While Meteor is a real-time, reactive framework, not <em>all</em> of the code inside a Meteor app is reactive. If this were the case, your whole app would re-run every time anything changed. Instead, reactivity is limited to specific areas of your code, and we call these areas <strong>computations</strong>. </p>
            
            <p>In other words, a computation is a block of code that runs every time one of the reactive data sources it depends on changes. If you have a reactive data source (for example, a Session variable) and would like to respond reactively to it, you&#39;ll need to set up a computation for it. </p>
            
            <p>Note that you usually don&#39;t need to do this explicitly because Meteor already gives each template it renders its own special computation (meaning that code in template helpers and callbacks is reactive by default).</p>
            
            <p>Every reactive data source tracks all the computations that are using it so that it can let them know when its own value changes. To do so, it calls the <code>invalidate()</code> function on the computation.</p>
            
            <p>Computations are generally set up to simply re-evaluate their contents on invalidation, and this is what happens to the template computations (although template computations also do some magic to try and redraw the page more efficiently). Although you can have more control on what your computation does on invalidation if you need to, in practice this is almost always the behavior you&#39;ll be using.</p>
            
            <h3>Setting Up a Computation</h3>
            
            <p>Now that we understand the theory behind computations, actually setting one up will seem disproportionately easy. We simply use the <code>Deps.autorun</code> function to enclose a block of code in a computation and make it reactive:</p>
            <div class="highlight"><pre><span class="nx">Deps</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;There are &#39;</span> <span class="o">+</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; posts&#39;</span><span class="p">);</span>&#x000A;<span class="p">});</span></pre></div>
            <p>Behind the scenes, <code>autorun</code> creates a computation, and wires it up to re-evaluate whenever the data sources it depends on change. We&#39;ve set up a very simple computation that simply logs the number of posts to the console. Since <code>Posts.find()</code> is a reactive data source, it will take care of telling the computation to re-evaluate every time the number of posts changes.</p>
            <div class="highlight"><pre><span class="o">&gt;</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;New Post&#39;</span><span class="p">});</span>&#x000A;<span class="nx">There</span> <span class="nx">are</span> <span class="mi">4</span> <span class="nx">posts</span><span class="p">.</span></pre></div>
            <p>The net result of all this is that we can write code that uses reactive data in a very natural way, knowing that behind the scenes the dependency system will take care of re-running it at just the right times.</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='creatingposts'>
              Creating Posts
              <span class='number'>7</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn how to submit a post client-side.</li>
            <li>Implement a simple security check.</li>
            <li>Restrict access to the post submit form.</li>
            <li>Learn to use a server-side Method for added security.</li>
            </ul>
            </div>
            
            <p>We&#39;ve seen how easy it is to create posts via the console, using the <code>Posts.insert</code> database call, but we can&#39;t expect our users to open the console to create a new post! Eventually, we&#39;ll need to build some kind of user interface to let our users post new stories to our app. </p>
            
            <h3>Building the new Post page</h3>
            
            <p>We begin by defining a route for our new page:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postSubmit&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/submit&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/helpers/router.js</div><div class="lines-highlight" data-lines="13~15" data-class="added"></div>
            
            <h3>Adding a Link to the Header</h3>
            
            <p>With that route defined, we can now add a link to our submit page in our header:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;header&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;      <span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postsList&#39;}}&quot;</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;nav-collapse collapse&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postSubmit&#39;}}&quot;</span><span class="nt">&gt;</span>New<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>&#x000A;        <span class="nt">&lt;/ul&gt;</span>&#x000A;        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;li&gt;</span>{{loginButtons}}<span class="nt">&lt;/li&gt;</span>&#x000A;        <span class="nt">&lt;/ul&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/header&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/includes/header.html</div><div class="lines-highlight" data-lines="11~16" data-class="added"></div>
            
            <p>Setting up our route means that if a user browses to the <code>/submit</code> URL, Meteor will display the <code>postSubmit</code> template. So let&#39;s write that template:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postSubmit&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;control-label&quot;</span> <span class="na">for=</span><span class="s">&quot;url&quot;</span><span class="nt">&gt;</span>URL<span class="nt">&lt;/label&gt;</span>&#x000A;        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;            <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;Your URL&quot;</span><span class="nt">/&gt;</span>&#x000A;        <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;control-label&quot;</span> <span class="na">for=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;</span>&#x000A;        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;            <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;Name your post&quot;</span><span class="nt">/&gt;</span>&#x000A;        <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;control-label&quot;</span> <span class="na">for=</span><span class="s">&quot;message&quot;</span><span class="nt">&gt;</span>Message<span class="nt">&lt;/label&gt;</span>&#x000A;        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;            <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;message&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>&#x000A;        <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span> &#x000A;&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="nt">/&gt;</span>&#x000A;        <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/form&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_submit.html</div>
            
            <p>Note: that &#39;s a lot of markup, but it simply comes from using Twitter Bootstrap. While only the form elements are essential, the extra markup will help  make our app look a little bit nicer. It should now look similar to this:</p>
            
            <figure class="screenshot "><img src="images/screenshots/7-1.png" alt="The post submit form"/><figcaption>The post submit form</figcaption></figure>
            
            <p>This is a simple form. We don&#39;t need to worry about an action for it, as we&#39;ll be intercepting submit events on the form and updating data via JavaScript. (It doesn&#39;t make sense to provide a non-JS fallback when you consider that a Meteor app is completely non-functional with JavaScript disabled).</p>
            
            <h3>Creating Posts</h3>
            
            <p>Let&#39;s bind an event handler to the form <code>submit</code> event. It&#39;s best to use the <code>submit</code> event (rather than say a <code>click</code> event on the button), as that will cover all possible ways of submitting (such as hitting enter in URL field for instance).</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;submit form&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>&#x000A;      <span class="nx">url</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=url]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">title</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=title]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">message</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=message]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>&#x000A;    <span class="p">}</span>&#x000A;&#x000A;    <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>&#x000A;    <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_submit.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 7-1</h4><p>Added a submit post page and linked to it in the header.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter7-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>This function uses <a href="http://jquery.com">jQuery</a> to parse out the values of our various form fields, and populate a new post object from the results. We need to ensure we <code>preventDefault</code> on the <code>event</code> argument to our handler to make sure the browser doesn&#39;t go ahead and try to submit the form. </p>
            
            <p>Finally, we can route to our new post&#39;s page. The <code>insert()</code> function on a collection returns the generated <code>id</code> for the object that has been inserted into the database, which the Router&#39;s <code>go()</code> function will use to construct a URL for us to browse to.</p>
            
            <p>The net result is the user hits submit, a post is created, and the user is instantly taken to the discussion page for that new post.</p>
            
            <h3>Adding Some Security</h3>
            
            <p>Creating posts is all very well, but we don&#39;t want to let any random visitor do it: we want them to have to be logged in to do so. Of course, we can start by hiding the new post form from logged out users. Still, a user could conceivably create a post in the browser console without being logged in, and we can&#39;t have that.</p>
            
            <p>Thankfully data security is baked right into Meteor collections; it&#39;s just that it&#39;s turned off by default when you create a new project. This enables you to get started easily and start building out your app while leaving the boring stuff for later.</p>
            
            <p>Our app no longer needs these training wheels, so let&#39;s take them off! We&#39;ll remove the <code>insecure</code> package:</p>
            <div class="highlight"><pre><span class="nv">$ </span>meteor remove insecure</pre></div>
            <div class="caption">Terminal</div>
            
            <p>After doing so, you&#39;ll notice that the post form no longer works. This is because without the <code>insecure</code> package, client-side inserts into the posts collection <em>are no longer allowed</em>. We need to either give some explicit rules telling Meteor when it&#39;s OK for a client to insert posts, or else do our post insertions server-side.</p>
            
            <h3>Allowing Post Inserts</h3>
            
            <p>To begin with, we&#39;ll show how to allow client-side post inserts in order to get our form working again. As it turns out, we&#39;ll eventually settle on a different technique, but for now, the following will get things working again easily enough:</p>
            <div class="highlight"><pre><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>&#x000A;&#x000A;<span class="nx">Posts</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>&#x000A;  <span class="nx">insert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">// only allow posting if you are logged in</span>&#x000A;    <span class="k">return</span> <span class="o">!!</span> <span class="nx">userId</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="3~8" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 7-2</h4><p>Removed insecure, and allowed certain writes to posts.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter7-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>We call <code>Posts.allow</code>, which tells Meteor &ldquo;this is a set of circumstances under which clients are allowed to do things to the <code>Posts</code> collection&rdquo;. In this case, we are saying &ldquo;clients are allowed to insert posts as long as they have a <code>userId</code>&rdquo;. </p>
            
            <p>The <code>userId</code> of the user doing the modification is passed to the <code>allow</code> and <code>deny</code> calls (or returns <code>null</code> if no user is logged in), which is almost always useful. And as user accounts are tied into the core of Meteor, we can rely on <code>userId</code> always being correct. </p>
            
            <p>We&#39;ve managed to ensure that you need to be logged in to create a post. Try logging out and creating a post; you should see this in your console:</p>
            
            <figure class="screenshot "><img src="images/screenshots/7-2.png" alt="Insert failed: Access denied "/><figcaption>Insert failed: Access denied </figcaption></figure>
            
            <p>However, we still have to deal with a couple of issues:</p>
            
            <ul>
            <li>Logged out users can still reach the create post form.</li>
            <li>The post is not tied to the user in any way (and there&#39;s no code on the server to enforce this).</li>
            <li>Multiple posts can be created that point to the same URL.</li>
            </ul>
            
            <p>Let&#39;s fix these problems.</p>
            
            <h3>Securing Access To The New Post Form</h3>
            
            <p>Let&#39;s start by preventing logged out users from seeing the post submit form. We&#39;ll do that at the router level, by defining a <em>route hook</em>. </p>
            
            <p>A hook intercepts the routing process and potentially changes the action that the router takes. You can think of it as a security guard that checks your credentials before letting you in (or turning you away).</p>
            
            <p>What we need to do is check if the user is logged in, and if they&#39;re not render the <code>accessDenied</code> template instead of the expected <code>postSubmit</code> template (we then stop the router from doing anything else). So let&#39;s modify router.js like so:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postSubmit&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/submit&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="kd">var</span> <span class="nx">requireLogin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">())</span> <span class="p">{</span>&#x000A;    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;accessDenied&#39;</span><span class="p">);</span>&#x000A;    <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">requireLogin</span><span class="p">,</span> <span class="p">{</span><span class="nx">only</span><span class="o">:</span> <span class="s1">&#39;postSubmit&#39;</span><span class="p">})</span></pre></div>
            <div class="caption">client/helpers/router.js</div><div class="lines-highlight" data-lines="18~25" data-class="added"></div>
            
            <p>We also create the template for the access denied page:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;accessDenied&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>You can&#39;t get here! Please log in.<span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/includes/access_denied.html</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 7-3</h4><p>Denied access to new posts page when not logged in.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter7-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>If you now head to http://localhost:3000/submit/ without being logged in, you should see this:</p>
            
            <figure class="screenshot "><img src="images/screenshots/7-3.png" alt="The access denied template"/><figcaption>The access denied template</figcaption></figure>
            
            <p>The nice thing about routing hooks is that they are <em>reactive</em>. This means we can be declarative and we don&#39;t need to think about callbacks, or similar, when the user logs in. When the log-in state of the user changes, the Router&#39;s page template instantly changes from <code>accessDenied</code> to <code>postSubmit</code> without us having to write any explicit code to handle it.</p>
            
            <p>Log in, then try refreshing the page. You might notice that the access denied template flashes up for a brief moment before the new post page appears. The reason for this is that Meteor begins rendering templates as soon as possible, before it has talked to the server and checked if the user currently (stored in the browser&#39;s local storage) even exists.</p>
            
            <p>To avoid this problem (which is a common class of problem that you&#39;ll see more of as you deal with the intricacies of latency between client and server), we&#39;ll just display a loading screen for the brief moment that we are waiting to see if the user has access or not. </p>
            
            <p>After all at this stage we don&#39;t know if the user has the correct log-in credentials, and we can&#39;t show either the <code>accessDenied</code> or the <code>postSubmit</code> template until we do.</p>
            
            <p>So we modify our hook to use our loading template whilst <code>Meteor.loggingIn()</code> is true:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postSubmit&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/submit&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="kd">var</span> <span class="nx">requireLogin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">())</span> <span class="p">{</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">loggingIn</span><span class="p">())</span>&#x000A;      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loadingTemplate</span><span class="p">);</span>&#x000A;    <span class="k">else</span>&#x000A;      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;accessDenied&#39;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">requireLogin</span><span class="p">,</span> <span class="p">{</span><span class="nx">only</span><span class="o">:</span> <span class="s1">&#39;postSubmit&#39;</span><span class="p">});</span></pre></div>
            <div class="caption">client/helpers/router.js</div><div class="lines-highlight" data-lines="20~25" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 7-4</h4><p>Show a loading screen while waiting to login.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-4" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter7-4.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Hiding the Link</h3>
            
            <p>The easiest way to prevent users from trying to reach this page by mistake when they are logged out is to hide the link from them. We can do this pretty easily:</p>
            <div class="highlight"><pre><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav&quot;</span><span class="nt">&gt;</span>&#x000A;  {{#if currentUser}}<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postSubmit&#39;}}&quot;</span><span class="nt">&gt;</span>Submit Post<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>{{/if}}&#x000A;<span class="nt">&lt;/ul&gt;</span></pre></div>
            <div class="caption">client/views/includes/header.html</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 7-5</h4><p>Only show submit post link if logged in.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-5" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter7-5.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>The <code>currentUser</code> helper is provided to us by the <code>accounts</code> package and is the handlebars equivalent of <code>Meteor.user()</code>. Since it&#39;s reactive, the link will appear or disappear as you log in and out of the app.</p>
            
            <h3>Meteor Method: Better Abstraction and Security</h3>
            
            <p>We&#39;ve managed to secure access to the new post page for logged out users, and deny such users from creating posts even if they cheat and use the console. Yet there are still a few more things we need to take care of:</p>
            
            <ul>
            <li>Timestamping the posts.</li>
            <li>Ensuring that the same URL can&#39;t be posted more than once.</li>
            <li>Adding details about the post author (ID, username, etc.).</li>
            </ul>
            
            <p>You may be thinking we can do all of that in our <code>submit</code> event handler. Realistically, however, we would quickly run into a range of problems.</p>
            
            <ul>
            <li>For the timestamp, we&#39;d have to rely on the user&#39;s computer&#39;s time being correct, which is not always going to be the case.</li>
            <li>Clients won&#39;t know about <em>all</em> of the URLs ever posted to the site. They&#39;ll only know about the posts that they can currently see (we&#39;ll see how exactly this works later), so there&#39;s no way to enforce URL uniqueness client-side.</li>
            <li>Finally, although we <em>could</em> add the user details client-side, we wouldn&#39;t be enforcing its accuracy, which could open our app up to exploitation by people using the browser console.</li>
            </ul>
            
            <p>For all these reasons, it&#39;s better to keep our event handlers simple and, if we are doing more than the most basic inserts or updates to collections, use a <strong>Method</strong>.</p>
            
            <p>A Meteor Method is a server-side function that is called client-side. We aren&#39;t totally unfamiliar with them &ndash; in fact, behind the scenes, the <code>Collection</code>&#39;s <code>insert</code>, <code>update</code> and <code>remove</code> functions are all Methods. Let&#39;s see how to create our own.</p>
            
            <p>Let&#39;s go back to <code>post_submit.js</code>. Rather than inserting directly into the <code>Posts</code> collection, we&#39;ll call a Method named <code>post</code>:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;submit form&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>&#x000A;      <span class="nx">url</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=url]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">title</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=title]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">message</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=message]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>&#x000A;    <span class="p">}</span>&#x000A;&#x000A;    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>&#x000A;        <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>&#x000A;&#x000A;      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">id</span><span class="p">});</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_submit.js</div>
            
            <p>The <code>Meteor.call</code> function calls a Method named by its first argument. You can provide arguments to the call (in this case, the <code>post</code> object we constructed from the form), and finally attach a callback, which will execute when the server-side Method is done. Here we simply alert the user if there&#39;s a problem, or redirect the user to the freshly created post&#39;s discussion page if not.</p>
            
            <p>We then define the Method in our <code>collections/posts.js</code> file:</p>
            <div class="highlight"><pre><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>&#x000A;  <span class="nx">post</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">(),</span>&#x000A;      <span class="nx">postWithSameLink</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="nx">postAttributes</span><span class="p">.</span><span class="nx">url</span><span class="p">});</span>&#x000A;&#x000A;    <span class="c1">// ensure the user is logged in</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;You need to login to post new stories&quot;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="c1">// ensure the post has a title</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">postAttributes</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">422</span><span class="p">,</span> <span class="s1">&#39;Please fill in a headline&#39;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="c1">// check that there are no previous posts with the same link</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="nx">postAttributes</span><span class="p">.</span><span class="nx">url</span> <span class="o">&amp;&amp;</span> <span class="nx">postWithSameLink</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">302</span><span class="p">,</span> &#x000A;        <span class="s1">&#39;This link has already been posted&#39;</span><span class="p">,</span> &#x000A;        <span class="nx">postWithSameLink</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>&#x000A;    <span class="p">}</span>&#x000A;&#x000A;    <span class="c1">// pick out the whitelisted keys</span>&#x000A;    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">),</span> <span class="p">{</span>&#x000A;      <span class="nx">userId</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> &#x000A;      <span class="nx">author</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> &#x000A;      <span class="nx">submitted</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>&#x000A;    <span class="p">});</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>&#x000A;&#x000A;    <span class="k">return</span> <span class="nx">postId</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">collections/posts.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 7-6</h4><p>Use a method to submit the post.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-6" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter7-6.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>This Method is a little complicated, but hopefully you can follow along.</p>
            
            <p>First, we define our <code>user</code> variable and check if a post with the same link already exists. Then, we check to see that the user is logged in, throwing an error (which will eventually be <code>alert</code>-ed by the browser) if not. We also do some simple validation of the post object to make sure that our posts have titles. </p>
            
            <p>Next, if there&#39;s another post with the same URL, we throw a <code>302</code> error (which means redirect) telling the user that they should just go and look at that previously created post. </p>
            
            <p>Meteor&#39;s <code>Error</code> class takes three arguments. The first one (<code>error</code>) will be the <code>302</code> numeric code, the second one (<code>reason</code>) is a short human-readable explanation of the error, and the last one (<code>details</code>) can be any useful additional information.</p>
            
            <p>In our case, we&#39;ll use this third argument to pass the ID of the post that we just found. Spoiler alert: we&#39;ll use this later on to redirect the user to the pre-existing post.</p>
            
            <p>If all those checks pass, we grab the fields that we want to insert (to ensure a user calling this Method in browser console can&#39;t put spurious data into our database), and include some information about the submitting user &ndash; as well as the current time &ndash; into  the post. </p>
            
            <p>Finally, we insert the post, and return the new post&#39;s <code>id</code> to the user.</p>
            
            <h3>Sorting Posts</h3>
            
            <p>Now that we have a submitted date on all our posts, it makes sense to ensure that they are sorted using this attribute. To do so, we can just use Mongo&#39;s <code>sort</code> operator, which expects an object consisting of the keys to sort by, and a sign indicating whether they are ascending or descending.</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">posts</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/posts_list.js</div><div class="lines-highlight" data-lines="3" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 7-7</h4><p>Sort posts by submitted timestamp.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-7" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter7-7.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>It took a bit of work, but we finally have a user interface to let users securely enter content in our app! </p>
            
            <p>But any app that lets users create content also needs to give them a way to edit or delete it. That&#39;s what the Editing Posts chapter will be all about.</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='latencycompensation'>
              Latency Compensation
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>7.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Understand latency compensation.</li>
            <li>Slow your app down and see what&#39;s going on.</li>
            <li>Learn how Meteor Methods call each other.</li>
            </ul>
            </div>
            
            <p>In the last chapter, we introduced a new concept in the Meteor world: <strong>Methods</strong>. </p>
            
            <figure class="diagram pull-right"><img src="images/diagrams/latency1@2x.png" alt="Without latency compensation"/><figcaption>Without latency compensation</figcaption></figure>
            
            <p>A Meteor Method is a way of executing a series of commands on the server in a structured way. In our example, we used a Method because we wanted to make sure that new posts were tagged with their author&#39;s name and id as well as the current server time. </p>
            
            <p>However, if Meteor executed Methods in the most basic way, we&#39;d have a problem. Consider the following sequence of events (note: the timestamps are random values picked for illustrative purpose only):</p>
            
            <ul>
            <li><em>+0ms:</em> The user clicks a submit button and the browser fires a Method call.</li>
            <li><em>+200ms:</em> The server makes changes to the Mongo database.</li>
            <li><em>+500ms:</em> The client receives these changes, and updates the UI to reflect them.</li>
            </ul>
            
            <p>If this were the way Meteor operated, then there&#39;d be a short lag between performing such actions and seeing the results (that lag being more or less noticeable depending on how close you were to the server). We can&#39;t have that in a modern web application!</p>
            
            <h3>Latency Compensation</h3>
            
            <figure class="diagram pull-right"><img src="images/diagrams/latency2@2x.png" alt="With latency compensation"/><figcaption>With latency compensation</figcaption></figure>
            
            <p>To avoid this problem, Meteor introduces a concept called <strong>Latency Compensation</strong>. When we defined our <code>post</code> Method, we placed it within a file in the <code>collections/</code> directory. This means it is available to both the server <em>and the client</em> &ndash; and it will run on both at the same time!</p>
            
            <p>When you make a Method call, the client sends off the call to the server, but also simultaneously <em>simulates</em> the action of the Method on its local collections. So our workflow now becomes:</p>
            
            <ul>
            <li><em>+0ms:</em> The user clicks a submit button and the browser fires a Method call.</li>
            <li><em>+0ms:</em>  The client simulates the action of the Method call on the local collections and changes the UI to reflect this</li>
            <li><em>+200ms:</em>  The server makes changes to the Mongo database.</li>
            <li><em>+500ms:</em>  The client receives those changes and undoes its simulated changes, replacing them with the server&#39;s changes (which are generally the same). The UI changes to reflect this.</li>
            </ul>
            
            <p>This results in the user seeing the changes instantly. When the server&#39;s response returns a few moments later, there may or may not be noticeable changes as the server&#39;s canonical documents come down the wire. One thing to learn from this is that we should try to make sure we simulate the real documents as closely as we can.</p>
            
            <h3>Observing Latency Compensation</h3>
            
            <p>We can make a little change to the <code>post</code> Method call to see this in action. To do so, we&#39;ll be doing some advanced coding with the <code>futures</code> npm package to delay the insertion of objects in our Method.</p>
            
            <p>We&#39;ll use <code>isSimulation</code> to ask Meteor if the Method is currently being invoked as a stub. A <a href="http://docs.meteor.com/#methods_header">stub</a> is the Method simulation that Meteor runs on the client in parallel, while the &ldquo;real&rdquo; Method is being run on the server.</p>
            
            <p>So we&#39;ll ask Meteor if the code is being executed on the client. If so, we&#39;ll add the string <code>(client)</code> at the end of our post&#39;s title. If not, we&#39;ll add the string <code>(server)</code>:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>&#x000A;  <span class="nx">post</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">// […]</span>&#x000A;&#x000A;    <span class="c1">// pick out the whitelisted keys</span>&#x000A;    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">),</span> <span class="p">{</span>&#x000A;      <span class="nx">title</span><span class="o">:</span> <span class="nx">postAttributes</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isSimulation</span> <span class="o">?</span> <span class="s1">&#39;(client)&#39;</span> <span class="o">:</span> <span class="s1">&#39;(server)&#39;</span><span class="p">),</span>&#x000A;      <span class="nx">userId</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> &#x000A;      <span class="nx">author</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> &#x000A;      <span class="nx">submitted</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>&#x000A;    <span class="p">});</span>&#x000A;&#x000A;    <span class="c1">// wait for 5 seconds</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSimulation</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="kd">var</span> <span class="nx">Future</span> <span class="o">=</span> <span class="nx">Npm</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fibers/future&#39;</span><span class="p">);</span>&#x000A;      <span class="kd">var</span> <span class="nx">future</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Future</span><span class="p">();</span>&#x000A;      <span class="nx">Meteor</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;        <span class="nx">future</span><span class="p">.</span><span class="k">return</span><span class="p">();</span>&#x000A;      <span class="p">},</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>&#x000A;      <span class="nx">future</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>&#x000A;    <span class="p">}</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>&#x000A;&#x000A;    <span class="k">return</span> <span class="nx">postId</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="6, 7, 13~22" data-class="added"></div>
            
            <p>Note: in case you&#39;re wondering, the <code>this</code> in <code>this.isSimulation</code> is a <a href="http://docs.meteor.com/#meteor_methods">Method invocation object</a> that provides access to various useful variables.</p>
            
            <p>Exactly how <a href="https://npmjs.org/package/future">Futures</a> work is outside of the scope of this book, but we&#39;ve basically told Meteor to wait for 5 seconds before doing the insert on the server collection. </p>
            
            <p>We&#39;ll also make a submit redirect directly to the post list:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;submit form&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>&#x000A;      <span class="nx">url</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=url]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">title</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=title]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">message</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=message]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>&#x000A;    <span class="p">}</span>&#x000A;&#x000A;    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>&#x000A;        <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>&#x000A;    <span class="p">});</span>&#x000A;    <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">&#39;postList&#39;</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_submit.js</div><div class="lines-highlight" data-lines="15" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 7-5-1</h4><p>Demonstrate the order that posts appear using a sleep.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar7-5-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-sidebar7-5-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>If we create a post now, we see latency compensation clearly. First, a post is inserted with <code>(client)</code> in the title (the first post in the list, linking to GitHub):</p>
            
            <figure class="screenshot "><img src="images/screenshots/s5-1.png" alt="Our post as first stored in the client collection"/><figcaption>Our post as first stored in the client collection</figcaption></figure>
            
            <p>Then, five seconds later, it is cleanly replaced with the real document that was inserted by the server:</p>
            
            <figure class="screenshot "><img src="images/screenshots/s5-2.png" alt="Our post once the client receives the update from the server collection"/><figcaption>Our post once the client receives the update from the server collection</figcaption></figure>
            
            <h3>Local Collection Methods</h3>
            
            <p>You might think that Methods are complicated after this, but in fact they can be quite simple. We&#39;ve actually seen three very simple Methods already: the collection mutation Methods, <code>insert</code>, <code>update</code> and <code>remove</code>.</p>
            
            <p>When you define a server collection called <code>&#39;posts&#39;</code>, you are implicitly defining three Methods: <code>posts/insert</code>, <code>posts/update</code> and <code>posts/delete</code>. In other words, when you call <code>Posts.insert()</code> on your local collection, you are calling a latency compensated Method that does two things: </p>
            
            <ol>
            <li>Checks to see if we can make the mutation by calling <code>allow</code> and <code>deny</code> callbacks.</li>
            <li>Actually makes the modification to the underlying data store.</li>
            </ol>
            
            <h3>Methods Calling Methods</h3>
            
            <p>If you are keeping up, you might have just realized that our <code>post</code> Method is calling another Method (<code>posts/insert</code>) when we insert our post. How does this work?</p>
            
            <p>When the simulation (client-side version of the Method) is being run, we run <code>insert</code>&#39;s simulation (so we insert into our local collection), but we <em>do not</em> call the real, server-side <code>insert</code>, as we expect that the <em>server-side</em> version of <code>post</code> will do this.</p>
            
            <p>Consequently, when the server-side <code>post</code> Method calls <code>insert</code> there&#39;s no need to worry about simulation, and the insertion goes ahead smoothly.</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='editingposts'>
              Editing Posts
              <span class='number'>8</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Add a form for editing your posts.</li>
            <li>Set up edit permissions.</li>
            <li>Restrict which properties can be edited.</li>
            </ul>
            </div>
            
            <p>Now that we can create posts, the next step is being able to edit and delete them. While the UI code to do so is fairly simple, this is a good time to talk about how Meteor manages user permissions. </p>
            
            <h3>Template &amp; Manager</h3>
            
            <p>Our <code>post_edit.html</code> template will be a fairly standard form:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postEdit&quot;</span><span class="nt">&gt;</span>&#x000A;  {{#with post}}&#x000A;    <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;control-label&quot;</span> <span class="na">for=</span><span class="s">&quot;url&quot;</span><span class="nt">&gt;</span>URL<span class="nt">&lt;/label&gt;</span>&#x000A;          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;              <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;{{url}}&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;Your URL&quot;</span><span class="nt">/&gt;</span>&#x000A;          <span class="nt">&lt;/div&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;control-label&quot;</span> <span class="na">for=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;</span>&#x000A;          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;              <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;{{title}}&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;Name your post&quot;</span><span class="nt">/&gt;</span>&#x000A;          <span class="nt">&lt;/div&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;              <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary submit&quot;</span><span class="nt">/&gt;</span>&#x000A;          <span class="nt">&lt;/div&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;      <span class="nt">&lt;hr/&gt;</span>&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;              <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-danger delete&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Delete post<span class="nt">&lt;/a&gt;</span>&#x000A;          <span class="nt">&lt;/div&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/form&gt;</span>&#x000A;  {{/with}}&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_edit.html</div>
            
            <p>And here&#39;s the <code>post_edit.js</code> manager that goes with it:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postEdit</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">post</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;currentPostId&#39;</span><span class="p">));</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">postEdit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;submit form&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">currentPostId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;currentPostId&#39;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">postProperties</span> <span class="o">=</span> <span class="p">{</span>&#x000A;      <span class="nx">url</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=url]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">title</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=title]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>&#x000A;    <span class="p">}</span>&#x000A;&#x000A;    <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="nx">postProperties</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>&#x000A;        <span class="c1">// display the error to the user</span>&#x000A;        <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>&#x000A;      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>&#x000A;        <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">currentPostId</span><span class="p">});</span>&#x000A;      <span class="p">}</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">},</span>&#x000A;&#x000A;  <span class="s1">&#39;click .delete&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="nx">confirm</span><span class="p">(</span><span class="s2">&quot;Delete this post?&quot;</span><span class="p">))</span> <span class="p">{</span>&#x000A;      <span class="kd">var</span> <span class="nx">currentPostId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;currentPostId&#39;</span><span class="p">);</span>&#x000A;      <span class="nx">Posts</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">);</span>&#x000A;      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">);</span>&#x000A;    <span class="p">}</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_edit.js</div>
            
            <p>By now most of that code should be familiar to you. First, we have our template helper that fetches the current post and passes it on to the template. </p>
            
            <p>We then have two template event callbacks: one for the form&#39;s <code>submit</code> event, and one for the delete link&#39;s <code>click</code> event. </p>
            
            <p>The delete callback is extremely simple: suppress the default click event, then ask for confirmation. If you get it, obtain the current post ID from the Session variable, delete it, and finally redirect the user to the homepage. </p>
            
            <p>The update callback is a little longer, but not much more complicated. After suppressing the default event and getting the current post, we get the new form field values from the page and store them in a <code>postProperties</code> object. </p>
            
            <p>We then pass this object to Meteor&#39;s <code>Collection.update()</code> Method, and use a callback that either displays an error if the update failed, or sends the user back to the post&#39;s page if the update succeeded. </p>
            
            <p>Let&#39;s also hook up our router so that we have a way to access our new template:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postEdit&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id/edit&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postSubmit&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/submit&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="kd">var</span> <span class="nx">requireLogin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">())</span> <span class="p">{</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">loggingIn</span><span class="p">())</span>&#x000A;      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;loading&#39;</span><span class="p">)</span>&#x000A;    <span class="k">else</span>&#x000A;      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;accessDenied&#39;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">requireLogin</span><span class="p">,</span> <span class="p">{</span><span class="nx">only</span><span class="o">:</span> <span class="s1">&#39;postSubmit&#39;</span><span class="p">})</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/helpers/router.js</div><div class="lines-highlight" data-lines="12~15" data-class="added"></div>
            
            <p>We should add edit links to our posts also:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postItem&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post-content&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url}}&quot;</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>&#x000A;      <span class="nt">&lt;p&gt;</span>&#x000A;        submitted by {{author}}&#x000A;        {{#if ownPost}}<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postEdit&#39;}}&quot;</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>{{/if}}&#x000A;      <span class="nt">&lt;/p&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postPage&#39;}}&quot;</span> <span class="na">class=</span><span class="s">&quot;discuss btn&quot;</span><span class="nt">&gt;</span>Discuss<span class="nt">&lt;/a&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_item.html</div><div class="lines-highlight" data-lines="5~8" data-class="added"></div>
            
            <p>Of course, we don&#39;t want to show you an edit link to somebody else&#39;s form. This is where the <code>ownPost</code> helper comes in:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">ownPost</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span> <span class="o">==</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">();</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">domain</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>&#x000A;    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>&#x000A;    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_item.js</div><div class="lines-highlight" data-lines="2~4" data-class="added"></div>
            
            <figure class="screenshot "><img src="images/screenshots/8-1.png" alt="Post edit form."/><figcaption>Post edit form.</figcaption></figure>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 8-1</h4><p>Added edit posts form.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter8-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter8-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Our post edit form is looking good, but you won&#39;t be able to actually edit anything right now. What&#39;s going on?</p>
            
            <h3>Setting Up Permissions</h3>
            
            <p>Since we&#39;ve previously removed the <code>insecure</code> package, all client-side modifications are currently being denied. </p>
            
            <p>To fix this, we&#39;ll set up some permission rules. First, create a new <code>permissions.js</code> file inside <code>lib</code>. This loads our permissions logic first (and is available in both environments):</p>
            <div class="highlight"><pre><span class="c1">// check that the userId specified owns the documents</span>&#x000A;<span class="nx">ownsDocument</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">doc</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">userId</span> <span class="o">===</span> <span class="nx">userId</span><span class="p">;</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">lib/permissions.js</div>
            
            <p>A while back, we got rid of the <code>allow()</code> Methods because we were only inserting new posts via a server Method (which bypasses <code>allow()</code> anyway). </p>
            
            <p>But now that we&#39;re editing and deleting posts from the client, let&#39;s go back to <code>posts.js</code> and add this <code>allow()</code> block:</p>
            <div class="highlight"><pre><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>&#x000A;&#x000A;<span class="nx">Posts</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>&#x000A;  <span class="nx">update</span><span class="o">:</span> <span class="nx">ownsDocument</span><span class="p">,</span>&#x000A;  <span class="nx">remove</span><span class="o">:</span> <span class="nx">ownsDocument</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>&#x000A;  <span class="p">...</span></pre></div>
            <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="3~6" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 8-2</h4><p>Added basic permission to check the post&rsquo;s owner.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter8-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter8-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Limiting Edits</h3>
            
            <p>Just because you can edit your own posts, doesn&#39;t mean you should be able to edit <em>every</em> property. For example, we don&#39;t want users to be able to create a post and then assign it to somebody else. </p>
            
            <p>We use Meteor&#39;s <code>deny()</code> callback to ensure users can only edit specific fields: </p>
            <div class="highlight"><pre><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>&#x000A;&#x000A;<span class="nx">Posts</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>&#x000A;  <span class="nx">update</span><span class="o">:</span> <span class="nx">ownsDocument</span><span class="p">,</span>&#x000A;  <span class="nx">remove</span><span class="o">:</span> <span class="nx">ownsDocument</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Posts</span><span class="p">.</span><span class="nx">deny</span><span class="p">({</span>&#x000A;  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="nx">fieldNames</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">// may only edit the following two fields:</span>&#x000A;    <span class="k">return</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">without</span><span class="p">(</span><span class="nx">fieldNames</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="8~13" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 8-3</h4><p>Only allow changing certain fields of posts.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter8-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter8-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>We&#39;re taking the <code>fieldNames</code> array that contains a list of the fields being modified, and using Underscore&#39;s <code>without()</code> Method to return a sub-array containing the fields that are <em>not</em> <code>url</code> or <code>title</code>. </p>
            
            <p>If everything&#39;s normal, that array should be empty and its length should be 0. If someone is trying anything funky, that array&#39;s length will be 1 or more, and the callback will return <code>true</code> (thus denying the update).</p>
            
            <div class="note"><h3>Method Calls vs Client-side Data Manipulation</h3>
            
            <p>To create posts, we are using a <code>post</code> Method, whereas to edit and delete them, we are calling <code>update</code> and <code>remove</code> directly on the client and limiting access via <code>allow</code> and <code>deny</code>. </p>
            
            <p>When it is appropriate to do one and not the other?</p>
            
            <p>When things are relatively straightforward and you can adequately express your rules via <code>allow</code> and <code>deny</code>, it&#39;s usually simpler to do things directly from the client. </p>
            
            <p>Directly manipulating the database from the client creates the perception of immediacy, and can make for a better user experience as long as you remember to handle failure cases gracefully (i.e. when the server comes back saying the change didn&#39;t succeed after all).</p>
            
            <p>However, as soon as you start needing to do things that should be outside the user&#39;s control (such as timestamping a new post or assigning it to the correct user), it&#39;s probably better to use a Method.</p>
            
            <p>Method calls are also more appropriate in a few other scenarios:</p>
            
            <ul>
            <li>When you need to know or return values via callback rather than waiting for the reactivity and synchronization to propagate. </li>
            <li>For heavy database functions that would be too expensive to ship a large collection over. </li>
            <li>To summarize or aggregate data (e.g. count, average, sum). </li>
            </ul>
            </div>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='allowanddeny'>
              Allow and Deny
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>8.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn about Allow and Deny callbacks.</li>
            <li>Understand in which order callbacks are called.</li>
            </ul>
            </div>
            
            <p>Meteor&#39;s security system allows us to control database modification without having to define Methods every time we want to make changes.</p>
            
            <p>Because we needed to do auxiliary tasks like decorating the post with extra properties and taking special action when the post&#39;s URL had already been posted, using a specific <code>post</code> Method made a lot of sense when creating a post.</p>
            
            <p>On the other hand, we didn&#39;t really need to create new Methods for updating and deleting posts. We just needed to check if the user had permission to do these actions, and this was made easy by <code>allow</code> and <code>deny</code> callbacks. </p>
            
            <p>Using these callbacks lets us be more declarative about database modifications, and say what kind of updates can be used. The fact that they integrate with the accounts system is an added bonus.</p>
            
            <h3>Multiple callbacks</h3>
            
            <p>We can define as many <code>allow</code> callbacks as required. We just need <em>at least one</em> of them to return <code>true</code> for the given change that is happening. So when <code>Posts.insert</code> is called in a browser (no matter if it&#39;s from our app&#39;s client-side code or from the console), the server will in turn call whatever allowed-<code>insert</code> checks it can until it finds one that returns true. If it does not find any, it will not allow the insert, and will return a <code>403</code> error to the client.</p>
            
            <p>Similarly, we can define one or more <code>deny</code> callbacks. If <em>any</em> of those callbacks return <code>true</code>, the change will be cancelled and a <code>403</code> will be returned. The logic of this means that for a successful <code>insert</code>, one or more <code>allow</code> <code>insert</code> callback as well as <em>every</em> <code>deny</code> <code>insert</code> callback will be executed.</p>
            
            <figure class="diagram "><img src="images/diagrams/allow_deny@2x.png" alt="Note: n/e stands for Not Executed"/><figcaption>Note: n/e stands for Not Executed</figcaption></figure>
            
            <p>In other words, Meteor moves down the callback list starting first with <code>deny</code>, then with <code>allow</code>, and executes every callback until one of them returns <code>true</code>. </p>
            
            <p>A practical example of this pattern could be having two <code>allow()</code> callbacks, one that checks if a post belongs to the current user, and a second one that checks if the current user has admin rights. If the current user is an admin, this ensures they will be able to update any post, since at least one of those callbacks will return true.</p>
            
            <h3>Latency Compensation</h3>
            
            <p>Remember that database mutation Methods (such as <code>.update()</code>) are latency compensated, just like any other Method. So for instance, if you try to delete a post that does not belong to you via the browser console, you&#39;ll see the post briefly disappear as your local collection loses the document, but then re-appear as the server informs it that, no, in fact the document wasn&#39;t deleted.</p>
            
            <p>Of course this behaviour is not a problem when triggered from the console (after all, if users are going to try and mess with data on the console, it&#39;s not really your problem what happens in <em>their</em> browser). However, you need to make sure that this doesn&#39;t happen in your user interface. For instance, you need to take pains to ensure that you&#39;re not showing users delete buttons for documents that they&#39;re not allowed to delete.</p>
            
            <p>Thankfully, since you can share permissions code between the client and server (for instance, you could write a library function <code>canDeletePost(user, post)</code> and put it in the shared <code>/lib</code> directory), doing so usually doesn&#39;t require too much extra code.</p>
            
            <h3>Server-side permissions</h3>
            
            <p>Remember that the permission system only applies to database mutations initiated from the client. On the server, Meteor assumes that <em>all</em> operations are permitted.</p>
            
            <p>This means that if you were to write a server-side <code>deletePost</code> Meteor Method that could be called from the client, anybody would be able to delete any post. So you probably don&#39;t want to do that unless you checked user permissions within that Method as well.</p>
            
            <h3>Using deny as a callback</h3>
            
            <p>Finally, one trick you can do with <code>deny</code> is to use it as an &ldquo;onX&rdquo; callback. For instance, you could achieve a <code>lastModified</code> timestamp with the following code:</p>
            <div class="highlight"><pre><span class="nx">Posts</span><span class="p">.</span><span class="nx">deny</span><span class="p">({</span>&#x000A;  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">doc</span><span class="p">.</span><span class="nx">lastModified</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>&#x000A;    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <p>As <code>deny</code> callbacks are run for <em>every</em> successful <code>update</code>, we know this callback will be run and can make changes to the document in a structured way.</p>
            
            <p>Admittedly, this technique is a bit of a hack, so you might want to perform updates using a Method instead. Nevertheless, it is still useful to know, and in the future we can hope that some kind of <code>beforeUpdate</code> callback will become available.</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='errors'>
              Errors
              <span class='number'>9</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Create a better mechanism for displaying errors and messages.</li>
            <li>Learn how to use <code>Template.rendered</code> to know when a user has seen an error.</li>
            <li>Use a router filter to make sure errors are only seen once.</li>
            </ul>
            </div>
            
            <p>Merely using the browser&#39;s standard <code>alert()</code> dialog to warn the user when there&#39;s problem with their submission is a bit dissatisfying, and it certainly doesn&#39;t make for great UX. We can do better. </p>
            
            <p>Instead, let&#39;s build a more versatile error reporting mechanism that will do a better job of telling the user what&#39;s going on without breaking up their flow.</p>
            
            <h3>Introducing Local Collections</h3>
            
            <p>We are going to implement a simple system which keeps track of which errors a user has seen and displays the new ones in a &ldquo;flash&rdquo; area of the site. This UX pattern is useful when we want to inform a user that something has happened without disrupting their workflow too much.</p>
            
            <p>What we will create is similar to the flash messages often found in Ruby on Rails apps, but is more subtle in that it&#39;s implemented client side and knows when a user has seen a message.</p>
            
            <p>To start off with, we create a collection to store our errors in. Given that the errors are only relevant to the current session and don&#39;t need to be persistent in any way, we are going to do something new, and create a <em>local collection</em>. What this means is that the <code>Errors</code> collection will only exist in the browser, and will make no attempt to synchronize with the server.</p>
            
            <p>To achieve this, we simply create the error in a client-only file, with the collection name set to <code>null</code>. We create a <code>throwError</code> function that simply inserts an error into our new local collection:</p>
            <div class="highlight"><pre><span class="c1">// Local (client-only) collection</span>&#x000A;<span class="nx">Errors</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span></pre></div>
            <div class="caption">client/helpers/errors.js</div>
            
            <p>Now that the collection has been created, we can add a <code>throwError</code> function which we&#39;ll call to add errors to it. We don&#39;t need to worry about <code>allow</code> or <code>deny</code> or anything like that, as this is a local collection and will not be saved to the Mongo database.</p>
            <div class="highlight"><pre><span class="nx">throwError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">Errors</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">})</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">client/helpers/errors.js</div>
            
            <p>The advantage of using a local collection to store the errors is that, like all collections, it&#39;s reactive &ndash; meaning we can declaratively display the errors in the same way we display any other collection data.</p>
            
            <h3>Displaying errors</h3>
            
            <p>We are going to display the errors at the top of our main layout:</p>
            <div class="highlight"><pre><span class="nt">&lt;head&gt;</span>&#x000A;  <span class="nt">&lt;title&gt;</span>Microscope<span class="nt">&lt;/title&gt;</span>&#x000A;<span class="nt">&lt;/head&gt;</span>&#x000A;<span class="nt">&lt;body&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>&#x000A;    {{&gt; header}}&#x000A;    {{&gt; errors}}&#x000A;    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">class=</span><span class="s">&quot;row-fluid&quot;</span><span class="nt">&gt;</span>&#x000A;      {{renderPage}}&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/body&gt;</span></pre></div>
            <div class="caption">client/main.html</div><div class="lines-highlight" data-lines="7" data-class="added"></div>
            
            <p>Let&#39;s now create the <code>errors</code> and <code>error</code> templates in <code>errors.html</code>:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;errors&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;errors row-fluid&quot;</span><span class="nt">&gt;</span>    &#x000A;    {{#each errors}}&#x000A;      {{&gt; error}}&#x000A;    {{/each}}&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span>&#x000A;&#x000A;<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;error&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;alert&quot;</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/button&gt;</span>&#x000A;    {{message}}&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/includes/errors.html</div>
            
            <div class="note"><h3>2 Templates 1 File</h3>
            
            <p>You&#39;ll notice we&#39;re putting two templates in a single file. Up to now we&#39;ve tried to adhere to a &ldquo;one file, one template&rdquo; convention, but as far as Meteor is concerned putting all our templates in a single file works just as well (although it would make for a very confusing <code>main.html</code>!).</p>
            
            <p>In this case, since both error templates are fairly short, we&#39;ll make an exception and put them in the same file to make our repo a bit cleaner. </p>
            </div>
            
            <p>We just need to integrate our template helper, and we&#39;ll be good to go!</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">errors</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Errors</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/includes/errors.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 9-1</h4><p>Basic error reporting.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter9-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter9-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Creating errors</h3>
            
            <p>We now know how to display errors, but we still need to create some before we&#39;ll see anything. Errors are most commonly triggered by users entering new content, so we&#39;ll check for errors in our post creation callback, and display a message for any errors that get raised.</p>
            
            <p>In addition, if we get the <code>302</code> error (which indicates that a post with the same URL already exists), we&#39;ll redirect the user to the existing post. We obtain the existing post&#39;s <code>_id</code> from <code>error.details</code> (remember we passed that post&#39;s <code>_id</code> as the third <code>details</code> argument of our <code>Error</code> class in chapter 7). </p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;submit form&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>&#x000A;      <span class="nx">url</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=url]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">title</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=title]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">message</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=message]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>&#x000A;    <span class="p">}</span>&#x000A;&#x000A;    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>&#x000A;        <span class="c1">// display the error to the user</span>&#x000A;        <span class="nx">throwError</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>&#x000A;&#x000A;        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">error</span> <span class="o">===</span> <span class="mi">302</span><span class="p">)</span>&#x000A;          <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">details</span><span class="p">})</span>&#x000A;      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>&#x000A;        <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">id</span><span class="p">});</span>&#x000A;      <span class="p">}</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_submit.js</div><div class="lines-highlight" data-lines="12~14, 16~21" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 9-2</h4><p>Actually use the error reporting.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter9-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter9-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Give it a try: try creating a post and entering the URL <code>http://meteor.com</code>. As this URL is already attached to a post in the fixtures, you should see:</p>
            
            <figure class="screenshot "><img src="images/screenshots/9-1.png" alt="Triggering an error"/><figcaption>Triggering an error</figcaption></figure>
            
            <h3>Clearing Errors</h3>
            
            <p>Now you might have tried clicking the error&#39;s close button. If you did, you would see the error disappear, only to return as soon as you loaded another page. What&#39;s going on?</p>
            
            <p>That close button triggers Twitter Bootstrap&#39;s embedded JavaScript: it has nothing to do with Meteor! So what&#39;s happening is that Bootstrap is removing the error <code>&lt;div&gt;</code> from the DOM, but not from the Meteor collection. Meaning the error will of course pop right back up as soon as Meteor re-renders the page. </p>
            
            <p>So unless we want errors relentlessly coming back from the dead to remind users of past mistakes and slowly drive them to insanity, we better add a way to remove errors from the collection, too.  </p>
            
            <p>First, we&#39;ll modify the <code>throwError</code> function to include a <code>seen</code> property. This will be useful later on to keep track of whether an error has been actually seen by the user. </p>
            
            <p>Once that&#39;s done, we can code up a simple <code>clearErrors</code> function that clears those &ldquo;seen&rdquo; errors:</p>
            <div class="highlight"><pre><span class="c1">// Local (client-only) collection</span>&#x000A;<span class="nx">Errors</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>&#x000A;&#x000A;<span class="nx">throwError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">Errors</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">seen</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="nx">clearErrors</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="nx">Errors</span><span class="p">.</span><span class="nx">remove</span><span class="p">({</span><span class="nx">seen</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">client/helpers/errors.js</div><div class="lines-highlight" data-lines="5,8~10" data-class="added"></div>
            
            <p>Next, we&#39;ll clear errors in the router so that navigating to another page will make these errors vanish forever:</p>
            <div class="highlight"><pre><span class="c1">// ...</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">requireLogin</span><span class="p">,</span> <span class="p">{</span><span class="nx">only</span><span class="o">:</span> <span class="s1">&#39;postSubmit&#39;</span><span class="p">})</span>&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">clearErrors</span><span class="p">()</span> <span class="p">});</span></pre></div>
            <div class="caption">client/helpers/router.js</div><div class="lines-highlight" data-lines="4" data-class="added"></div>
            
            <p>In order for our <code>clearErrors()</code> function to do its job, errors need to be marked as <code>seen</code>. To do this properly, there&#39;s one edge case we need to take care of: when we throw up an error and then redirect the user somewhere else (as we do when they try to post a duplicate link), the redirection happens instantly. This means that the user never has the chance to actually see the error before it&#39;s cleared. </p>
            
            <p>This is where our <code>seen</code> property will come in handy. We need to ensure that it&#39;s only set to <code>true</code> if the user has actually seen the error. </p>
            
            <p>To achieve this, we&#39;ll use <code>Meteor.defer()</code>. This function tells Meteor to execute its callback &ldquo;just after&rdquo; whatever&#39;s going on now. If it helps, you can consider that <code>defer()</code> is like telling the browser to wait 1 millisecond before proceeding. </p>
            
            <p>What we&#39;re doing is telling Meteor to set <code>seen</code> to <code>true</code> 1 millisecond after the <code>errors</code> template has been rendered. But remember how we said that redirection happens instantly? This means that the redirection will kick in before the <code>defer</code> callback, which will never have a chance to be executed.</p>
            
            <p>This is exactly what we want: if it&#39;s not executed our error will not be marked as <code>seen</code>, which means it won&#39;t be cleared, which means it&#39;ll appear on the page our user is redirected to just like we wanted!</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">errors</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Errors</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">rendered</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>&#x000A;  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">Errors</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">seen</span><span class="o">:</span> <span class="kc">true</span><span class="p">}});</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">};</span></pre></div>
            <div class="caption">client/views/includes/errors.js</div><div class="lines-highlight" data-lines="7~12" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 9-3</h4><p>Monitor which errors have been seen, and clear on routing.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter9-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter9-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>The <code>rendered</code> callback triggers once our template has been rendered in the browser. Inside the callback, <code>this</code> refers to the current template instance, and <code>this.data</code> lets us access the data of the object that is currently being rendered (in our case, an error).</p>
            
            <p>Whew! That was a lot of work for something users will hopefully never see!</p>
            
            <div class="note"><h3>The <code>rendered</code> callback</h3>
            
            <p>A template&#39;s <code>rendered</code> callback triggers every time it&#39;s rendered in the browser. This of course includes the first time it pops up on the screen, but it&#39;s important to remember that the callback will also fire every time the template is re-rendered, e.g. every time any of its data changes.</p>
            
            <p>Rendered callbacks will typically fire at least twice: first when the app initially loads, and a second time once collection data has been loaded. So you should be careful when putting any code that shouldn&#39;t fire twice (such as an alert, or analytics event tracking code) in them.</p>
            </div>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='creatingameteoritepackage'>
              Creating a Meteorite Package
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>9.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Write a local in-app package.</li>
            <li>Write some tests for your package. </li>
            <li>Release your package on Atmosphere.</li>
            </ul>
            </div>
            
            <p>We&#39;ve built a re-usable pattern with our errors work, so why not package it up into a smart package and share it with the rest of the Meteor community?</p>
            
            <p>It&#39;s easier than you think!</p>
            
            <h3>Getting set up</h3>
            
            <p>First we need to create some structure for our package to reside in.</p>
            
            <p>We put the package in a directory named <code>packages/errors/</code>. This creates a custom package that&#39;s automatically used. (You might have noticed that Meteorite installs packages via symlinks in the <code>packages/</code> directory).</p>
            
            <p>Second, we&#39;ll create <code>package.js</code> in that folder, the file that informs Meteor of how the package should be used, and the symbols that it exports.</p>
            <div class="highlight"><pre><span class="nx">Package</span><span class="p">.</span><span class="nx">describe</span><span class="p">({</span>&#x000A;  <span class="nx">summary</span><span class="o">:</span> <span class="s2">&quot;A pattern to display application errors to the user&quot;</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Package</span><span class="p">.</span><span class="nx">on_use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">where</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">([</span><span class="s1">&#39;minimongo&#39;</span><span class="p">,</span> <span class="s1">&#39;mongo-livedata&#39;</span><span class="p">,</span> <span class="s1">&#39;templating&#39;</span><span class="p">],</span> <span class="s1">&#39;client&#39;</span><span class="p">);</span>&#x000A;&#x000A;  <span class="nx">api</span><span class="p">.</span><span class="nx">add_files</span><span class="p">([</span><span class="s1">&#39;errors.js&#39;</span><span class="p">,</span> <span class="s1">&#39;errors_list.html&#39;</span><span class="p">,</span> <span class="s1">&#39;errors_list.js&#39;</span><span class="p">],</span> <span class="s1">&#39;client&#39;</span><span class="p">);</span>&#x000A;&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="kr">export</span><span class="p">)</span> &#x000A;    <span class="nx">api</span><span class="p">.</span><span class="kr">export</span><span class="p">(</span><span class="s1">&#39;Errors&#39;</span><span class="p">);</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">packages/errors/package.js</div>
            
            <p>Let&#39;s add three files to the package. We can pull these files from Microscope without much change except for some proper namespacing and a slightly cleaner API:</p>
            <div class="highlight"><pre><span class="nx">Errors</span> <span class="o">=</span> <span class="p">{</span>&#x000A;  <span class="c1">// Local (client-only) collection</span>&#x000A;  <span class="nx">collection</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>&#x000A;&#x000A;  <span class="k">throw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">seen</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">clearSeen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">({</span><span class="nx">seen</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">};</span></pre></div>
            <div class="caption">packages/errors/errors.js</div>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;meteorErrors&quot;</span><span class="nt">&gt;</span>&#x000A;  {{#each errors}}&#x000A;    {{&gt; meteorError}}&#x000A;  {{/each}}&#x000A;<span class="nt">&lt;/template&gt;</span>&#x000A;&#x000A;<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;meteorError&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss=</span><span class="s">&quot;alert&quot;</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/button&gt;</span>&#x000A;    {{message}}&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">packages/errors/errors_list.html</div>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">meteorErrors</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">errors</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">meteorError</span><span class="p">.</span><span class="nx">rendered</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>&#x000A;  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">seen</span><span class="o">:</span> <span class="kc">true</span><span class="p">}});</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">};</span></pre></div>
            <div class="caption">packages/errors/errors_list.js</div>
            
            <h3>Testing the package out with Microscope</h3>
            
            <p>We will now test things locally with Microscope to ensure our changed code works. To link the package into our project, we run <code>meteor add errors</code>. Then, we need to delete the existing files that have been made redundant by the new package:</p>
            <div class="highlight"><pre><span class="nv">$ </span>rm client/helpers/errors.js&#x000A;<span class="nv">$ </span>rm client/views/includes/errors.html&#x000A;<span class="nv">$ </span>rm client/views/includes/errors.js</pre></div>
            <div class="caption">removing old files on the bash console</div>
            
            <p>One other thing we need to do is to make some minor updates to use the correct API:</p>
            <div class="highlight"><pre><span class="s1">&#39;clearErrors&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">Errors</span><span class="p">.</span><span class="nx">clearSeen</span><span class="p">();</span>&#x000A;  <span class="k">return</span> <span class="nx">page</span><span class="p">;</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">lib/router.js</div>
            <div class="highlight"><pre>  {{&gt; header}}&#x000A;  {{&gt; meteorErrors}}</pre></div>
            <div class="caption">client/views/application/layout.html</div>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">// display the error to the user</span>&#x000A;    <span class="nx">Errors</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span></pre></div>
            <div class="caption">client/views/posts/post_submit.js</div>
            <div class="highlight"><pre><span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="nx">postProperties</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">// display the error to the user</span>&#x000A;    <span class="nx">Errors</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span></pre></div>
            <div class="caption">client/views/posts/post_edit.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 9-5-1</h4><p>Created basic errors package and linked it in.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar9-5-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-sidebar9-5-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Once these changes have been made, we should get our original pre-package behaviour back.</p>
            
            <h3>Writing tests</h3>
            
            <p>The first step in developing a package is testing it against an application, but the next is to write a test suite that properly tests the package&#39;s behaviour. Meteor itself comes with Tinytest (a built in package tester), which makes it easy to run such tests and maintain peace of mind when sharing our package with others.</p>
            
            <p>Let&#39;s create a test file that uses Tinytest to run some tests against the errors codebase:</p>
            <div class="highlight"><pre><span class="nx">Tinytest</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;Errors collection works&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">test</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>&#x000A;&#x000A;  <span class="nx">Errors</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">&#39;A new error!&#39;</span><span class="p">);</span>&#x000A;  <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>&#x000A;&#x000A;  <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">({});</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Tinytest</span><span class="p">.</span><span class="nx">addAsync</span><span class="p">(</span><span class="s2">&quot;Errors template works&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>  &#x000A;  <span class="nx">Errors</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">&#39;A new error!&#39;</span><span class="p">);</span>&#x000A;  <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">seen</span><span class="o">:</span> <span class="kc">false</span><span class="p">}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>&#x000A;&#x000A;  <span class="c1">// render the template</span>&#x000A;  <span class="nx">OnscreenDiv</span><span class="p">(</span><span class="nx">Spark</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Template</span><span class="p">.</span><span class="nx">meteorErrors</span><span class="p">();</span>&#x000A;  <span class="p">}));</span>&#x000A;&#x000A;  <span class="c1">// wait a few milliseconds</span>&#x000A;  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">seen</span><span class="o">:</span> <span class="kc">false</span><span class="p">}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>&#x000A;    <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>&#x000A;    <span class="nx">Errors</span><span class="p">.</span><span class="nx">clearSeen</span><span class="p">();</span>&#x000A;&#x000A;    <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">seen</span><span class="o">:</span> <span class="kc">true</span><span class="p">}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>&#x000A;    <span class="nx">done</span><span class="p">();</span>&#x000A;  <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">packages/errors/errors_tests.js</div>
            
            <p>In these tests we&#39;re checking the basic <code>Meteor.Errors</code> functions work, as well as double checking that the <code>rendered</code> code in the template is still functioning.</p>
            
            <p>We won&#39;t cover the specifics of writing Meteor package tests here (as the API is not yet finalized and highly in flux), but hopefully it&#39;s fairly self explanatory how it works.</p>
            
            <p>To tell Meteor how to run the tests in <code>package.js</code>, use the following code:</p>
            <div class="highlight"><pre><span class="nx">Package</span><span class="p">.</span><span class="nx">on_test</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">);</span>&#x000A;  <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">([</span><span class="s1">&#39;tinytest&#39;</span><span class="p">,</span> <span class="s1">&#39;test-helpers&#39;</span><span class="p">],</span> <span class="s1">&#39;client&#39;</span><span class="p">);</span>  &#x000A;&#x000A;  <span class="nx">api</span><span class="p">.</span><span class="nx">add_files</span><span class="p">(</span><span class="s1">&#39;errors_tests.js&#39;</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">);</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">packages/errors/package.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 9-5-2</h4><p>Added tests to the package.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar9-5-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-sidebar9-5-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Then we can run the tests with:</p>
            <div class="highlight"><pre><span class="nv">$ </span>meteor <span class="nb">test</span>-packages errors</pre></div>
            <div class="caption">Terminal</div>
            
            <figure class="screenshot "><img src="images/screenshots/s7-1.png" alt="Passing all tests"/><figcaption>Passing all tests</figcaption></figure>
            
            <h3>Releasing the package</h3>
            
            <p>Now, we want to release the package and make it available to the world. We do this by putting it on Atmosphere.</p>
            
            <p>First, we need to add a <code>smart.json</code>, to tell Meteorite and Atmosphere the important details about the package:</p>
            <div class="highlight"><pre><span class="p">{</span>&#x000A;  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;errors&quot;</span><span class="p">,</span>&#x000A;  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A pattern to display application errors to the user&quot;</span><span class="p">,</span>&#x000A;  <span class="nt">&quot;homepage&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/tmeasday/meteor-errors&quot;</span><span class="p">,</span>&#x000A;  <span class="nt">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;Tom Coleman &lt;tom@thesnail.org&gt;&quot;</span><span class="p">,</span>&#x000A;  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>&#x000A;  <span class="nt">&quot;git&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/tmeasday/meteor-errors.git&quot;</span><span class="p">,</span>&#x000A;  <span class="nt">&quot;packages&quot;</span><span class="p">:</span> <span class="p">{</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">packages/errors/smart.json</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 9-5-3</h4><p>Added a smart.json</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar9-5-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-sidebar9-5-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>We put in some basic metadata to provide information about the package, including what it does, the git location where we&#39;re going to host it, and an initial version number. If our package was relying on other Atmosphere packages, we could also use a <code>&quot;packages&quot;</code> section to outline its dependencies.</p>
            
            <p>Once all this is in place, releasing is easy. We&#39;ll need to create a git repository, push to a remote git server somewhere, and link to that location in our <code>smart.json</code>.</p>
            
            <p>The process for doing this for <a href="http://github.com">GitHub</a> is to first create a new repository, then follow the standard practice to get the package&#39;s code within that repository. Then, we use the <code>mrt release</code> command to publish it:</p>
            <div class="highlight"><pre><span class="nv">$ </span>git init&#x000A;<span class="nv">$ </span>git add -A&#x000A;<span class="nv">$ </span>git commit -m <span class="s2">&quot;Created Errors Package&quot;</span>&#x000A;<span class="nv">$ </span>git remote add origin https://github.com/tmeasday/meteor-errors.git&#x000A;<span class="nv">$ </span>git push origin master&#x000A;<span class="nv">$ </span>mrt release .&#x000A;Done!</pre></div>
            <div class="caption">Terminal (run from within packages/errors)</div>
            
            <p>Note: package names have to be unique. If you are following along word-for-word and use the same package name, there will be a conflict and it won&#39;t work. In the future though Atmosphere will be name-spaced by author, so you can expect this to change.</p>
            
            <p>Now that the package is released, we can now delete it from the project and then add it back in directly using Meteorite:</p>
            <div class="highlight"><pre><span class="nv">$ </span>rm -r packages/errors&#x000A;<span class="nv">$ </span>mrt add errors</pre></div>
            <div class="caption">Terminal (run from the top level of the app)</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 9-5-4</h4><p>Removed package from development tree.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar9-5-4" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-sidebar9-5-4.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Now we should see Meteorite download our package for the very first time. Well done!</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='comments'>
              Comments
              <span class='number'>10</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Display existing comments.</li>
            <li>Add a comment posting form.</li>
            <li>Learn how to load only the current post&#39;s comments.</li>
            <li>Add a comment count property to posts.</li>
            </ul>
            </div>
            
            <p>The goal of a social news site is to create a community of users, and it will be hard to do that without providing a way for people to talk to each other. So in this chapter, let&#39;s add comments!</p>
            
            <h3>Getting started</h3>
            
            <p>We&#39;ll begin by creating a new collection to store comments in, and adding some basic fixture data into that collection.</p>
            <div class="highlight"><pre><span class="nx">Comments</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">);</span></pre></div>
            <div class="caption">collections/comments.js</div>
            <div class="highlight"><pre><span class="c1">// Fixture data </span>&#x000A;<span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>&#x000A;&#x000A;  <span class="c1">// create two users</span>&#x000A;  <span class="kd">var</span> <span class="nx">tomId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">profile</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Tom Coleman&#39;</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;  <span class="kd">var</span> <span class="nx">tom</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">tomId</span><span class="p">);</span>&#x000A;  <span class="kd">var</span> <span class="nx">sachaId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">profile</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Sacha Greif&#39;</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;  <span class="kd">var</span> <span class="nx">sacha</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">sachaId</span><span class="p">);</span>&#x000A;&#x000A;  <span class="kd">var</span> <span class="nx">telescopeId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Introducing Telescope&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://sachagreif.com/introducing-telescope/&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">postId</span><span class="o">:</span> <span class="nx">telescopeId</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Interesting project Sacha, can I get involved?&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">postId</span><span class="o">:</span> <span class="nx">telescopeId</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;You sure can Tom!&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Meteor&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://meteor.com&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;The Meteor Book&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://themeteorbook.com&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">server/fixtures.js</div>
            
            <p>Let&#39;s not forget to publish and subscribe to our new collection:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="5,6,7" data-class="added"></div>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">loadingTemplate</span><span class="o">:</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> &#x000A;    <span class="k">return</span> <span class="p">[</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">),</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)];</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js.js</div><div class="lines-highlight" data-lines="4~6" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 10-1</h4><p>Added comments collection, pub/sub and fixtures.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter10-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Note that to trigger this fixture code, you&#39;ll need to <code>meteor reset</code> to clear your database. After resetting, don&#39;t forget to create a new account and log back in!</p>
            
            <p>First, we created a couple of (completely fake) users, inserting them into the database and using their <code>id</code>s to select them out of the database afterwards. Then we added a comment for each user on the first post, linking the comment to the post (with <code>postId</code>), and the user (with <code>userId</code>). We also added a submission date and body to each comment, along with <code>author</code>, a denormalized field.</p>
            
            <p>Also, we augmented our router to wait on both the comments and the posts.</p>
            
            <h3>Displaying comments</h3>
            
            <p>It&#39;s all very well putting comments into the database, but we also need to show them on the discussion page. Hopefully this process should be familiar to you by now, and you have an idea of the steps involved:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postPage&quot;</span><span class="nt">&gt;</span>&#x000A;  {{#with currentPost}}&#x000A;    {{&gt; postItem}}&#x000A;&#x000A;    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;comments&quot;</span><span class="nt">&gt;</span>&#x000A;      {{#each comments}}&#x000A;        {{&gt; comment}}&#x000A;      {{/each}}&#x000A;    <span class="nt">&lt;/ul&gt;</span>&#x000A;  {{/with}}&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_page.html</div><div class="lines-highlight" data-lines="5,6,7,8,9" data-class="added"></div>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postPage</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">comments</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">postId</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_page.js</div><div class="lines-highlight" data-lines="2~4" data-class="added"></div>
            
            <p>We put the <code>{{#each comments}}</code> block inside the post template, so <code>this</code> is a post within the <code>comments</code> helper. To find the relevant comments, we check those that are linked to that post via the <code>postId</code> attribute.</p>
            
            <p>Given what we&#39;ve learnt about helpers and handlebars, rendering a comment is fairly straightforward. We&#39;ll create a new <code>comments</code> directory inside <code>views</code> to store all our comment information:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;comment&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;li&gt;</span>&#x000A;    <span class="nt">&lt;h4&gt;</span>&#x000A;      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;author&quot;</span><span class="nt">&gt;</span>{{author}}<span class="nt">&lt;/span&gt;</span>&#x000A;      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;date&quot;</span><span class="nt">&gt;</span>on {{submittedText}}<span class="nt">&lt;/span&gt;</span>&#x000A;    <span class="nt">&lt;/h4&gt;</span>&#x000A;    <span class="nt">&lt;p&gt;</span>{{body}}<span class="nt">&lt;/p&gt;</span>&#x000A;  <span class="nt">&lt;/li&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/comments/comment.html</div>
            
            <p>Let&#39;s set up a quick template helper to format our <code>submitted</code> date in a human-readable format (unless you&#39;re one of those people who can understand UNIX timestamps and hexadecimal color codes fluently?)</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">comment</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">submittedText</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">submitted</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/comments/comment.js</div>
            
            <p>Then, we&#39;ll show the number of comments on each post:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postItem&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post-content&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url}}&quot;</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>&#x000A;      <span class="nt">&lt;p&gt;</span>&#x000A;        submitted by {{author}},&#x000A;        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postPage&#39;}}&quot;</span><span class="nt">&gt;</span>{{commentsCount}} comments<span class="nt">&lt;/a&gt;</span>&#x000A;        {{#if ownPost}}<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postEdit&#39;}}&quot;</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>{{/if}}&#x000A;      <span class="nt">&lt;/p&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postPage&#39;}}&quot;</span> <span class="na">class=</span><span class="s">&quot;discuss btn&quot;</span><span class="nt">&gt;</span>Discuss<span class="nt">&lt;/a&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_item.html</div><div class="lines-highlight" data-lines="6,7" data-class="added"></div>
            
            <p>And add the <code>commentsCount</code> helper to our <code>postItem</code> manager:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">ownPost</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span> <span class="o">==</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">();</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">domain</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>&#x000A;    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>&#x000A;    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">commentsCount</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">postId</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">}).</span><span class="nx">count</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_item.js</div><div class="lines-highlight" data-lines="9,10,11" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 10-2</h4><p>Display comments on postPage.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter10-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>You should now be able to display our fixture comments and see something like this:</p>
            
            <figure class="screenshot "><img src="images/screenshots/10-1.png" alt="Displaying comments"/><figcaption>Displaying comments</figcaption></figure>
            
            <h3>Submitting comments</h3>
            
            <p>Let&#39;s add a way for our users to create new comments. The process we&#39;ll follow will be pretty similar to how we&#39;ve already allowed users to create new posts.</p>
            
            <p>We&#39;ll start by adding a submit box at the bottom of each post:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postPage&quot;</span><span class="nt">&gt;</span>&#x000A;  {{#with currentPost}}&#x000A;    {{&gt; postItem}}&#x000A;&#x000A;    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;comments&quot;</span><span class="nt">&gt;</span>&#x000A;      {{#each comments}}&#x000A;        {{&gt; comment}}&#x000A;      {{/each}}&#x000A;    <span class="nt">&lt;/ul&gt;</span>&#x000A;&#x000A;    {{#if currentUser}}&#x000A;      {{&gt; commentSubmit}}&#x000A;    {{else}}&#x000A;      <span class="nt">&lt;p&gt;</span>Please log in to leave a comment.<span class="nt">&lt;/p&gt;</span>&#x000A;    {{/if}}&#x000A;  {{/with}}&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_page.html</div><div class="lines-highlight" data-lines="11~15" data-class="added"></div>
            
            <p>And then create the comment form template:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;commentSubmit&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;form</span> <span class="na">name=</span><span class="s">&quot;comment&quot;</span> <span class="na">class=</span><span class="s">&quot;comment-form&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;body&quot;</span><span class="nt">&gt;</span>Comment on this post<span class="nt">&lt;/label&gt;</span>&#x000A;            <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;body&quot;</span><span class="nt">&gt;&lt;/textarea&gt;</span>&#x000A;        <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>&#x000A;            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span><span class="nt">&gt;</span>Add Comment<span class="nt">&lt;/button&gt;</span>&#x000A;        <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/form&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/comments/comment_submit.html</div>
            
            <figure class="screenshot "><img src="images/screenshots/10-2.png" alt="The comment submit form"/><figcaption>The comment submit form</figcaption></figure>
            
            <p>To submit our comments, we call a <code>comment</code> Method in the <code>commentSubmit</code> manager that operates in a similar way to the <code>postSubmit</code> manager:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">commentSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;submit form&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">template</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">$body</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[name=body]&#39;</span><span class="p">);</span>&#x000A;    <span class="kd">var</span> <span class="nx">comment</span> <span class="o">=</span> <span class="p">{</span>&#x000A;      <span class="nx">body</span><span class="o">:</span> <span class="nx">$body</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span>&#x000A;      <span class="nx">postId</span><span class="o">:</span> <span class="nx">template</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_id</span>&#x000A;    <span class="p">};</span>&#x000A;&#x000A;    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">commentId</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">){</span>&#x000A;        <span class="nx">throwError</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>&#x000A;      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>&#x000A;        <span class="nx">$body</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>&#x000A;      <span class="p">}</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/comments/comment_submit.js</div>
            
            <p>Just like we previously set up a <code>post</code> server-side Meteor Method, we&#39;ll set up a <code>comment</code> Meteor Method to create our comments, check that everything is legit, and finally insert the new comment into the comments collection.</p>
            <div class="highlight"><pre><span class="nx">Comments</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">);</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>&#x000A;  <span class="nx">comment</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>&#x000A;    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">.</span><span class="nx">postId</span><span class="p">);</span>&#x000A;    <span class="c1">// ensure the user is logged in</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;You need to login to make comments&quot;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">commentAttributes</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">422</span><span class="p">,</span> <span class="s1">&#39;Please write some content&#39;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">commentAttributes</span><span class="p">.</span><span class="nx">postId</span><span class="p">)</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">422</span><span class="p">,</span> <span class="s1">&#39;You must comment on a post&#39;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="nx">comment</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">,</span> <span class="s1">&#39;postId&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">),</span> <span class="p">{</span>&#x000A;      <span class="nx">userId</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;      <span class="nx">author</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>&#x000A;      <span class="nx">submitted</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>&#x000A;    <span class="p">});</span>&#x000A;&#x000A;    <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">collections/comments.js</div><div class="lines-highlight" data-lines="3~25" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 10-3</h4><p>Created a form to submit comments.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter10-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>This is not doing anything too fancy, just checking that the user is logged in, that the comment has a body, and that it&#39;s linked to a post. </p>
            
            <h3>Controlling the Comments Subscription</h3>
            
            <p>As things stand, we are publishing all comments across all posts to all connected clients. That seems a little wasteful. After all, we&#39;re only actually using a small subset of this data at any given time. So let&#39;s improve our publication and subscription to control exactly which comments are published. </p>
            
            <p>If we think about it, the only time we need to subscribe to our <code>comments</code> publication is when a user accesses a post&#39;s individual page, and we only need to load the subset of comments related to that particular post. </p>
            
            <p>The first step will be changing the way we subscribe to comments. Up to now, we&#39;ve been subscribing at the <em>router</em> level, which means we load all our data once when the router is initialized. </p>
            
            <p>But we now want our subscription to depend on a path parameter, and that parameter can obviously change at any point. So we&#39;ll need to move our subscription code from the <em>router</em> level to the <em>route</em> level. </p>
            
            <p>This has another consequence: instead of loading our data when we initialize our app, we&#39;ll now be loading it whenever we hit our <em>route</em>. This means that you&#39;ll now get loading times while browsing within the app, but it&#39;s an unavoidable downside unless you intend to front-load the entirety of your data set forever. </p>
            
            <p>Here&#39;s what our new route-level <code>waitOn</code> function looks like:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;&#x000A;  <span class="c1">//...</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>&#x000A;    <span class="p">},</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="c1">//...</span>&#x000A;&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="7~9" data-class="added"></div>
            
            <p>TODO: code change: waitOn before data</p>
            
            <p>You&#39;ll notice we&#39;re passing <code>this.params._id</code> as an argument to the publication. So let&#39;s use that new information to make sure we restrict our data set to comments belonging to the current post:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">postId</span><span class="o">:</span> <span class="nx">postId</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="5~7" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 10-4</h4><p>Made a simple publication/subscription for comments.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-4" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter10-4.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>There&#39;s only one problem: when we return to the homepage, it claims that all our posts have 0 comments:</p>
            
            <figure class="screenshot "><img src="images/screenshots/10-3.png" alt="Our comments are gone!"/><figcaption>Our comments are gone!</figcaption></figure>
            
            <h3>Counting Comments</h3>
            
            <p>The reason for this will quickly become clear: we only ever have at most <em>one</em> of our post&#39;s comments loaded, so when we call <code>Comments.find({postId: this._id})</code> in the <code>commentsCount</code> helper in the <code>post_item</code> manager, Meteor can&#39;t find the necessary client-side data to provide us with a result. </p>
            
            <p>The best way to deal with this is to <em>denormalize</em> the number of comments onto the post (if you&#39;re not sure what that means don&#39;t worry, the next sidebar has got you covered!). Although as we&#39;ll see, there&#39;s a minor addition of complexity in our code, the performance benefit we gain from not having to publish <em>all</em> the comments to display the post list is worth it.</p>
            
            <p>We&#39;ll achieve this by adding a <code>commentsCount</code> property to the <code>post</code> data structure. To begin with, we update our post fixtures (and <code>meteor reset</code> to reload them &ndash; don&#39;t forget to recreate your user account after):</p>
            <div class="highlight"><pre><span class="kd">var</span> <span class="nx">telescopeId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Introducing Telescope&#39;</span><span class="p">,</span>&#x000A;  <span class="p">..</span>&#x000A;  <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">2</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Meteor&#39;</span><span class="p">,</span>&#x000A;  <span class="p">...</span>&#x000A;  <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;The Meteor Book&#39;</span><span class="p">,</span>&#x000A;  <span class="p">...</span>&#x000A;  <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/fixtures.js</div>
            
            <p>Then, we make sure that all new posts start with 0 comments:</p>
            <div class="highlight"><pre><span class="c1">// pick out the whitelisted keys</span>&#x000A;<span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">),</span> <span class="p">{</span>&#x000A;  <span class="nx">userId</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> &#x000A;  <span class="nx">author</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> &#x000A;  <span class="nx">submitted</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>&#x000A;  <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span></pre></div>
            <div class="caption">collections/posts.js</div>
            
            <p>And then we update the relevant <code>commentsCount</code> when we make a new comment using Mongo&#39;s <code>$inc</code> operator (which increments a numeric field by one):</p>
            <div class="highlight"><pre><span class="c1">// update the post with the number of comments</span>&#x000A;<span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">,</span> <span class="p">{</span><span class="nx">$inc</span><span class="o">:</span> <span class="p">{</span><span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">1</span><span class="p">}});</span>&#x000A;&#x000A;<span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span></pre></div>
            <div class="caption">collections/comments.js </div>
            
            <p>Finally, we can just simply remove the <code>commentsCount</code> helper from <code>client/views/posts/post_item.js</code>, as the field is now directly available on the post.</p>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 10-5</h4><p>Denormalized the number of comments into the post.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-5" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter10-5.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Now that users can talk to each other, it would be a shame if they missed out on new comments. And what do you know, the next chapter will show you how to implement notifications to prevent just this!</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='denormalization'>
              Denormalization
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>10.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Understand what denormalization is. </li>
            <li>Compare Mongo with traditional relational databases.</li>
            <li>Learn when you should <em>not</em> denormalize your data. </li>
            </ul>
            </div>
            
            <p><em>Denormalizing</em> data means not storing that data in a &ldquo;normal&rdquo; form &ndash; in other words, having multiple copies of the same piece of data hanging about. </p>
            
            <p>In the last chapter, we denormalized the count of the number of comments into the post object to avoid having to load all the comments all the time. In a data modelling sense this is redundant, as we could instead just count the correct set of comments at any time to figure out that value (leaving out performance considerations).</p>
            
            <p>Denormalizing often means extra work for the developer. In our example, every time we add or remove a comment we&#39;ll also need to remember to update the relevant post to ensure that the <code>commentsCount</code> field stays accurate. This is exactly why relational databases such as MySQL frown upon this approach.</p>
            
            <p>However, the normal approach also has its drawbacks: without a <code>commentsCount</code> property, we&#39;d need to send <em>all</em> comments down the wire at all times just to be able to count them, which is what we were doing in the beginning. Denormalizing lets us avoid this entirely.</p>
            
            <div class="note"><h3>A Special Publication</h3>
            
            <p>It <em>would</em> be possible to create a special publication that only sends down the comment counts that we are interested in (i.e. comment counts of posts that we can currently see, via aggregate queries on the server). </p>
            
            <p>But it&#39;s worth considering if the complexity of such publication code would not outweigh the difficulties created by denormalizing…</p>
            </div>
            
            <p>Of course, such considerations are application-specific: if you are writing code where data integrity is of paramount importance, then avoiding data inconsistencies is far more important and of a higher priority to you than performance gains.</p>
            
            <h3>Embedding documents or using multiple collections</h3>
            
            <p>If you are experienced with Mongo, you might have been surprised to see that we created a second collection just for comments: why not just embed the comments in a list within the post document?</p>
            
            <p>It turns out that many of the tools Meteor gives us work a lot better when operating at the collection level. For example:</p>
            
            <ol>
            <li>The <code>{{#each}}</code> helper is very efficient when iterating over a cursor (the result of <code>collection.find()</code>). The same is not true when it iterates over an array of objects within a larger document.</li>
            <li><code>allow</code> and <code>deny</code> operate at the document level, and thus make it easy to ensure that any modifications of individual comments are correct in a way that would be more complex if we operated at a post level.</li>
            <li>DDP operates at the level of attributes of a document&ndash;this would mean if <code>comments</code> was a property of a <code>post</code>, every time a comment was created on a post, the server would send the entire updated comment list of that post out to each connected client.</li>
            <li>Publications and subscriptions are a lot easier to control at the level of documents. For example, if we wanted to paginate comments on a post we would find it difficult to do so unless comments were in their own collection.</li>
            </ol>
            
            <p>Mongo suggests embedding documents in order to reduce the number of expensive queries to fetch documents. However, this is less of an issue when we take into account Meteor&#39;s architecture: most of the time we are querying comments on the <em>client</em>, where database access is essentially free.</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='notifications'>
              Notifications
              <span class='number'>11</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Add a notifications collection to notify users of other user&#39;s actions.</li>
            <li>Learn how to only share the relevant notifications with a given user.</li>
            <li>Learn more about Meteor publications and subscriptions.</li>
            </ul>
            </div>
            
            <p>Now that users can comment on each other&#39;s posts, it&#39;d be good to let them know that a conversation has begun. To do so, we&#39;ll notify the post&#39;s owner that there&#39;s been a comment on their post, and provide them with a link to view that comment.</p>
            
            <p>This is the kind of feature where Meteor really shines: because Meteor is realtime by default, we&#39;ll be displaying those notifications <em>instantly</em>. We don&#39;t need to wait for the user to refresh the page or check in any way, we can simply pop new notifications up without ever writing any special code. </p>
            
            <h3>Creating notifications</h3>
            
            <p>We&#39;ll create a notification when someone comments on your posts. In the future, notifications could be extended to cover many other scenarios, but for now this will be enough to keep users informed of what&#39;s going on.</p>
            
            <p>Let&#39;s create our <code>Notifications</code> collection, as well as a <code>createCommentNotification</code> function that will insert a matching notification for each new comment on one of your own posts:</p>
            <div class="highlight"><pre><span class="nx">Notifications</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">);</span>&#x000A;&#x000A;<span class="nx">Notifications</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>&#x000A;  <span class="nx">update</span><span class="o">:</span> <span class="nx">ownsDocument</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">createCommentNotification</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">comment</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">);</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">userId</span> <span class="o">!==</span> <span class="nx">post</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">Notifications</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;      <span class="nx">userId</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>&#x000A;      <span class="nx">postId</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;      <span class="nx">commentId</span><span class="o">:</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;      <span class="nx">commenterName</span><span class="o">:</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">author</span><span class="p">,</span>&#x000A;      <span class="nx">read</span><span class="o">:</span> <span class="kc">false</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">};</span></pre></div>
            <div class="caption">collections/notifications.js</div>
            
            <p>Just like posts or comments, this <code>Notifications</code> collection will be shared by both client and server. As we need to update notifications once a user has seen them, we also enable updates, ensuring as usual that we restrict update permissions to a user&#39;s own data.</p>
            
            <p>We&#39;ve also created a simple function that looks at the post that the user is commenting on, discovers who should be notified from there, and inserts a new notification. </p>
            
            <p>We are already creating comments in a server-side Method, so we can just augment that Method to call our function. We&#39;ll replace <code>return Comments.insert(comment);</code> by <code>comment._id = Comments.insert(comment)</code> in order to save the <code>_id</code> of the newly created comment in a variable, then call our <code>createCommentNotification</code> function:</p>
            <div class="highlight"><pre><span class="nx">Comments</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">);</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>&#x000A;  <span class="nx">comment</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">)</span> <span class="p">{</span>&#x000A;&#x000A;    <span class="c1">// [...]</span>&#x000A;&#x000A;    <span class="c1">// create the comment, save the id</span>&#x000A;    <span class="nx">comment</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span>&#x000A;&#x000A;    <span class="c1">// now create a notification, informing the user that there&#39;s been a comment</span>&#x000A;    <span class="nx">createCommentNotification</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span>&#x000A;&#x000A;    <span class="k">return</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">collections/comments.js</div><div class="lines-highlight" data-lines="8~14" data-class="added"></div>
            
            <p>Let&#39;s also publish the notifications, and subscribe on the client:</p>
            <div class="highlight"><pre><span class="c1">// [...]</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/publications.js</div>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">loadingTemplate</span><span class="o">:</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> &#x000A;    <span class="k">return</span> <span class="p">[</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">),</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">)]</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 11-1</h4><p>Added basic notifications collection.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter11-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter11-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Displaying Notifications</h3>
            
            <p>Now we can go ahead and add a list of notifications to the header.</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;header&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;      <span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postsList&#39;}}&quot;</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;nav-collapse collapse&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav&quot;</span><span class="nt">&gt;</span>&#x000A;          {{#if currentUser}}&#x000A;            <span class="nt">&lt;li&gt;</span>&#x000A;              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postSubmit&#39;}}&quot;</span><span class="nt">&gt;</span>Submit Post<span class="nt">&lt;/a&gt;</span>&#x000A;            <span class="nt">&lt;/li&gt;</span>&#x000A;            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>&#x000A;              {{&gt; notifications}}&#x000A;            <span class="nt">&lt;/li&gt;</span>&#x000A;          {{/if}}&#x000A;        <span class="nt">&lt;/ul&gt;</span>&#x000A;        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;li&gt;</span>{{loginButtons}}<span class="nt">&lt;/li&gt;</span>&#x000A;        <span class="nt">&lt;/ul&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/header&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/includes/header.html</div><div class="lines-highlight" data-lines="12~19" data-class="added"></div>
            
            <p>And create the <code>notifications</code> and <code>notification</code> templates (they&#39;ll share a single <code>notifications.html</code> file):</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;notifications&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>&#x000A;    Notifications&#x000A;    {{#if notificationCount}}&#x000A;      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;badge badge-inverse&quot;</span><span class="nt">&gt;</span>{{notificationCount}}<span class="nt">&lt;/span&gt;</span>&#x000A;    {{/if}}&#x000A;    <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>&#x000A;  <span class="nt">&lt;/a&gt;</span>&#x000A;  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;notification dropdown-menu&quot;</span><span class="nt">&gt;</span>&#x000A;    {{#if notificationCount}}&#x000A;      {{#each notifications}}&#x000A;        {{&gt; notification}}&#x000A;      {{/each}}&#x000A;    {{else}}&#x000A;      <span class="nt">&lt;li&gt;&lt;span&gt;</span>No Notifications<span class="nt">&lt;/span&gt;&lt;/li&gt;</span>&#x000A;    {{/if}}&#x000A;  <span class="nt">&lt;/ul&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span>&#x000A;&#x000A;<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;notification&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;li&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{notificationPostPath}}&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;strong&gt;</span>{{commenterName}}<span class="nt">&lt;/strong&gt;</span> commented on your post&#x000A;    <span class="nt">&lt;/a&gt;</span>&#x000A;  <span class="nt">&lt;/li&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/notifications/notifications.html</div>
            
            <p>We can see that the plan is for each notification to contain a link to the post that was commented on, and the name of the user that commented on it. </p>
            
            <p>Next, we need to make sure we select the right list of notifications in our manager, and update the notifications as &ldquo;read&rdquo; when the user clicks on the link to which they point. </p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">notifications</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">notifications</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">userId</span><span class="o">:</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">(),</span> <span class="nx">read</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">notificationCount</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;    <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">userId</span><span class="o">:</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">(),</span> <span class="nx">read</span><span class="o">:</span> <span class="kc">false</span><span class="p">}).</span><span class="nx">count</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">notification</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">notificationPostPath</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">postPage</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postId</span><span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">})</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">notification</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;click a&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">Notifications</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">read</span><span class="o">:</span> <span class="kc">true</span><span class="p">}});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">})</span></pre></div>
            <div class="caption">client/views/notifications/notifications.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 11-2</h4><p>Display notifications in the header.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter11-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter11-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>You may think that the notifications are not too different from the errors, and it&#39;s true that their structure is very similar. There is one key difference though: we&#39;ve created a proper client-server synchronised collection. This means that our notifications are <em>persistent</em> and, as long as we use the same user account, will exist across browser refreshes and different devices.</p>
            
            <p>Give it a try: open up a second browser (let&#39;s say Firefox), create a new user account, and comment on a post that you&#39;ve created with your main account (which you&#39;ve left open in Chrome). You should see something like this:</p>
            
            <figure class="screenshot "><img src="images/screenshots/11-1.png" alt="Displaying notifications."/><figcaption>Displaying notifications.</figcaption></figure>
            
            <h3>Controlling access to notifications</h3>
            
            <p>Notifications are working well. However there&#39;s just a small problem: our notifications are public. </p>
            
            <p>If you still have your second browser open, try running the following code in the browser console:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>&#x000A;<span class="mi">1</span></pre></div>
            <div class="caption">Browser console</div>
            
            <p>This new user (the one that <em>commented</em>) shouldn&#39;t have any notifications. The notification they can see in the <code>Notifications</code> collection actually belongs to our <em>original</em> user. </p>
            
            <p>Aside from potential privacy issues, we simply can&#39;t afford to have every user&#39;s notifications loaded in every other user&#39;s browser. On a big enough site, this could overload the browser&#39;s available memory and start causing serious performance problems.</p>
            
            <p>We solve this issue with <strong>publications</strong>. We can use our publications to specify precisely which part of our collection we want to share with each browser.</p>
            
            <p>To accomplish this, we need to return a different cursor in our publication than <code>Notifications.find()</code>. Namely, we want to return a cursor that corresponds to the current user&#39;s notifications. </p>
            
            <p>Doing so is straightforward enough, as a <code>publish</code> function has the current user&#39;s <code>_id</code> available at <code>this.userId</code>:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">userId</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/publications.js</div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 11-3</h4><p>Only sync notifications that are relevant to the user.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter11-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter11-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Now if we check in our two browser windows, we should see two different notifications collections:</p>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>&#x000A;<span class="mi">1</span></pre></div>
            <div class="caption">Browser console (user 1)</div>
            <div class="highlight"><pre><span class="err">❯</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>&#x000A;<span class="mi">0</span></pre></div>
            <div class="caption">Browser console (user 2)</div>
            
            <p>In fact, the list of Notifications should even change as you log in and out of the app. This is because publications automatically re-publish whenever the user account changes.</p>
            
            <p>Our app is becoming more and more functional, and as more users join and start posting links we run the risk of ending up with a never-ending homepage. We&#39;ll address this in the next chapter by implementing pagination.</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='advancedreactivity'>
              Advanced Reactivity
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>11.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn about how to create reactive data sources in Meteor.</li>
            <li>Create a simple example of a reactive data source.</li>
            <li>See how Deps compares to AngularJS.</li>
            </ul>
            </div>
            
            <p>It&#39;s rare to need to write dependency tracking code yourself, but it&#39;s certainly useful to understand it to trace the way that the flow of dependency resolution works.</p>
            
            <p>Imagine we wanted to track how many of the current user&#39;s Facebook friends have &ldquo;liked&rdquo; each post on Microscope. Let&#39;s assume we&#39;ve already worked out the details of how to authenticate the user with Facebook, make the appropriate API calls, and parse the relevant data. We now have an asynchronous client-side function that returns the number of likes, <code>getFacebookLikeCount(user, url, callback)</code>.</p>
            
            <p>The important thing remember about such a function is that it is very much <em>non-reactive</em> and non-realtime. It will make an HTTP request to Facebook, retrieve some data, and make it available to the application in an asynchronous callback, but the function won&#39;t re-run by itself when that count changes over at Facebook, and our UI won&#39;t change when the underlying data does.</p>
            
            <p>To fix this, we can start by using <code>setInterval</code> to call our function every few seconds:</p>
            <div class="highlight"><pre><span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="kd">var</span> <span class="nx">postId</span><span class="p">;</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;currentPostId&#39;</span><span class="p">))</span> <span class="p">{</span>&#x000A;    <span class="nx">getFacebookLikeCount</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">(),</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">),</span> &#x000A;      <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>&#x000A;        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span>&#x000A;          <span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>&#x000A;      <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">},</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span></pre></div>
            <p>Any time we check that <code>currentLikeCount</code> variable, we can expect to get the correct number with a five seconds margin of error. We can now use this variable in a helper like so: </p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">likeCount</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">currentLikeCount</span><span class="p">;</span>&#x000A;<span class="p">}</span></pre></div>
            <p>However, nothing yet tells our template to re-draw when <code>currentLikeCount</code> changes. Although the variable is now pseudo-realtime in that it changes by itself, it&#39;s not <em>reactive</em> so it still can&#39;t quite communicate properly with the rest of the Meteor ecosystem.</p>
            
            <h3>Tracking Reactivity: Computations</h3>
            
            <p>Meteor&#39;s reactivity is mediated by <em>dependencies</em>, data structures that track a set of computations. </p>
            
            <p>As we saw in the earlier reactivity sidebar, a computation is a section of code that uses reactive data. In our case, there&#39;s a computation that&#39;s been implicitly created for the <code>postItem</code> template. Every helper on that template&#39;s manager is working within that computation. </p>
            
            <p>You can think of the computation as the section of code that &ldquo;cares&rdquo; about the reactive data. When the data changes, it will be this computation that is informed (via <code>invalidate()</code>), and it&#39;s the computation that decides whether something needs to be done.</p>
            
            <h3>Turning a Variable Into a Reactive Function</h3>
            
            <p>To turn our <code>currentLikeCount</code> variable into a reactive data source, we need to track all of the computations that use it in a dependency. This requires changing it from a variable into a function (which will return a value):</p>
            <div class="highlight"><pre><span class="kd">var</span> <span class="nx">_currentLikeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>&#x000A;<span class="kd">var</span> <span class="nx">_currentLikeCountListeners</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Deps</span><span class="p">.</span><span class="nx">Dependency</span><span class="p">();</span>&#x000A;&#x000A;<span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="nx">_currentLikeCountListeners</span><span class="p">.</span><span class="nx">depend</span><span class="p">();</span>&#x000A;  <span class="k">return</span> <span class="nx">_currentLikeCount</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="kd">var</span> <span class="nx">postId</span><span class="p">;</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;currentPostId&#39;</span><span class="p">))</span> <span class="p">{</span>&#x000A;    <span class="nx">getFacebookLikeCount</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">(),</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">),</span> &#x000A;      <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>&#x000A;        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">count</span> <span class="o">!==</span> <span class="nx">_currentLikeCount</span><span class="p">)</span> <span class="p">{</span>&#x000A;          <span class="nx">_currentLikeCount</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>&#x000A;          <span class="nx">_currentLikeCountListeners</span><span class="p">.</span><span class="nx">changed</span><span class="p">();</span>&#x000A;        <span class="p">}</span>&#x000A;      <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">},</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span></pre></div>
            <div class="lines-highlight" data-lines="1~7,14~17" data-class="added"></div>
            
            <p>What we&#39;ve done is setup a <code>_currentLikeCountListeners</code> dependency, which tracks all the computations within which <code>currentLikeCount()</code> has been used. When the value of <code>_currentLikeCount</code> changes, we call the <code>changed()</code> function on that dependency, which invalidates all the tracked computations.</p>
            
            <p>These computations can then go ahead and deal with the change on a case-by-case basis. In the case of a template&#39;s computation, it means that the template re-draws itself.</p>
            
            <h3>Template Computation and Controlling Redraws</h3>
            
            <p>The reason why each template has its own computation is to control the amount of redrawing that happens onscreen.</p>
            
            <p>When we call one template from within another, we&#39;re setting up a second computation inside the first. So when the reactive data used by the inner template changes, that inner template is redrawn yet the <em>outer</em> template remains the unchanged. In this way, computations are used to control the scope of reactive changes. </p>
            
            <p>Meteor also gives us a little bit of extra help to augment the basic mechanisms of nesting templates. </p>
            
            <p>First, the <code>{{#constant}}</code> block helper <em>kills</em> reactivity within itself. So any data that is gathered by helpers within the block is only ever used once. And even if the containing template is redrawn, the HTML of the constant area is left unchanged as it would render again the exact same way. This makes constant regions a great way to manage third party widgets that aren&#39;t expecting Meteor to re-draw the DOM from under them.</p>
            
            <p>The second feature that can help us control reactivity is the <code>{{#isolate}}</code> block helper, which sets up a <em>new</em> computation within a template. In other words, it has the same effect as moving that section of template into a sub-template in terms of reactivity and redrawing. </p>
            
            <p>So if one of the reactive data sources within the isolate block changes, the isolated area will re-draw, but the remainder of the containing template will not. If the containing template re-draws however, the isolated area will redraw as well.</p>
            
            <h3>Comparing Deps to Angular</h3>
            
            <p><a href="http://angularjs.org/">Angular</a> is a client-side only reactive rendering library, developed by the good folks at Google. It&#39;s illustrative to compare Meteor&#39;s approach to dependency tracking to Angular&#39;s, as the approaches are quite different.</p>
            
            <p>We&#39;ve seen that Meteor&#39;s model uses blocks of code called computations. These computations are tracked by special &ldquo;reactive&rdquo; data sources (functions) that take care of invalidating them when appropriate. So the data source <em>explicitly</em> informs all of it&#39;s dependencies when they need to call <code>invalidate()</code>. Note that although this is generally when data has changed, the data source could potentially also decide to trigger invalidation for other reasons.</p>
            
            <p>Additionally, although computations usually just re-run when invalidated, you can set them up to behave any way you want. All this gives us a high level of control over reactivity.</p>
            
            <p>In Angular, reactivity is mediated by the <code>scope</code> object. A scope can be thought of as plain JavaScript object with a couple of special methods. </p>
            
            <p>When you want to reactively depend on a value in a scope, you call <code>scope.$watch</code>, providing the expression that you are interested in (i.e. which parts of the scope you care about) and a listener function that will run every time that expression changes. So you explicitly state exactly what you want to do every time the value of the expression changes.</p>
            
            <p>Going back to our Facebook example, we would write:</p>
            <div class="highlight"><pre><span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="s1">&#39;currentLikeCount&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">likeCount</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Current like count is &#39;</span> <span class="o">+</span> <span class="nx">likeCount</span><span class="p">);</span>&#x000A;<span class="p">});</span></pre></div>
            <p>Of course, just like you rarely set up computations in Meteor, you don&#39;t often call <code>$watch</code> explicitly in Angular as <code>ng-model</code> directives and <code>{{expressions}}</code> automatically set up watches that then take care of re-rendering on change.</p>
            
            <p>When such a reactive value has changed, <code>scope.$apply()</code> must then be called. This re-evaluates every watcher of the scope, but only calls the listener function of watchers whose expression&#39;s value has <em>changed</em>. </p>
            
            <p>So <code>scope.$apply()</code> is similar to <code>dependency.changed()</code>, except that it acts at the level of the scope, rather than giving you the control to say precisely which listeners should be re-evaluated. That being said, this slight lack of control gives Angular the ability to be very smart and efficient in the way it determines precisely which listeners need to be re-evaluated.</p>
            
            <p>With Angular, our <code>getFacebookLikeCount()</code> function code would&#39;ve looked something like this:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="nx">getFacebookLikeCount</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">(),</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">),</span> &#x000A;    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>&#x000A;        <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>&#x000A;        <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">();</span>&#x000A;      <span class="p">}</span>&#x000A;    <span class="p">});</span>&#x000A;<span class="p">},</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span></pre></div>
            <div class="lines-highlight" data-lines="5~6" data-class="added"></div>
            
            <p>Admittedly, Meteor takes care of most of the heavy lifting for us and lets us benefit from reactivity without much work on our part. But hopefully, learning about these patterns will prove helpful if you ever need to push things further. </p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='pagination'>
              Pagination
              <span class='number'>12</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn more about Meteor&#39;s subscriptions, and how we can use them to control data.</li>
            <li>Implement infinite-style pagination.</li>
            <li>Use the <code>iron-router-progress</code> package to implement a nifty iOS-style progress bar.</li>
            <li>Create a special subscription to deal with direct links to posts page.</li>
            </ul>
            </div>
            
            <p>Things are looking great with Microscope, and we can expect a hit reception when it&#39;s released to the world. So we should probably think a little about the performance implication of the number of new posts that will be entered into the site as it takes off!</p>
            
            <p>We&#39;ve spoken before about how a client-side collection should contain a subset of the data on the server, and we&#39;ve even managed to achieve this for our notification and comments collections. </p>
            
            <p>At present though, we are still publishing all of our posts in one go, to all connected users. Eventually, if thousands of links are posted, this will become problematic. To solve this, we need to paginate our posts.</p>
            
            <h3>Adding More Posts</h3>
            
            <p>First, in our fixture data, let&#39;s load up enough posts so that pagination actually makes sense:</p>
            <div class="highlight"><pre><span class="c1">// Fixture data </span>&#x000A;<span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>&#x000A;&#x000A;  <span class="c1">//...</span>&#x000A;&#x000A;  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;The Meteor Book&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://themeteorbook.com&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;    <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Test post #&#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span>&#x000A;      <span class="nx">author</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;      <span class="nx">userId</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;      <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://google.com/?q=test-&#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span>&#x000A;      <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;      <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">server/fixtures.js</div><div class="lines-highlight" data-lines="15~24" data-class="added"></div>
            
            <p>After running <code>meteor reset</code>, you should now get something like this: </p>
            
            <figure class="screenshot "><img src="images/screenshots/12-1.png" alt="Displaying dummy data. "/><figcaption>Displaying dummy data. </figcaption></figure>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 12-1</h4><p>Added enough posts that pagination is necessary.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter12-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Infinite Pagination</h3>
            
            <p>We&#39;ll be implementing an &ldquo;infinite&rdquo; style pagination. What we mean by that is that we&#39;ll first show, say, 10 posts on the screen, with a “load more” link pinned at the bottom. Clicking this link will add 10 more posts to the lists, and so on <em>ad infinitum</em>. This means we can control our entire pagination system with a single parameter representing the number of posts to display onscreen. </p>
            
            <p>Now we&#39;ll need a way to tell the server about this parameter so that it knows how many posts to send up to the client. It so happens that we&#39;re already subscribing to the <code>posts</code> publication in the router, so we&#39;ll take advantage of this and let the router handle our pagination as well. </p>
            
            <p>The easiest way to set this up is simply to make the posts limit parameter part of the path, giving us URLs of the form <code>http://localhost:3000/25</code>. An added bonus of using the URL over other methods is that if you are currently displaying 25 posts and happen to reload the browser window by mistake, you&#39;ll still be seeing 25 posts once the page loads again.</p>
            
            <p>In order to do this properly, we&#39;ll need to change the way we subscribe to posts. Just like we previously did in the <em>Comments</em> chapter, we&#39;ll need to move our subscription code from the <em>router</em> level to the <em>route</em> level. </p>
            
            <p>This might all be a lot to take in at once, but it will become clearer with the code.</p>
            
            <p>First, we&#39;ll stop subscribing to the <code>posts</code> publication in the <code>Router.configure()</code> block. Just delete <code>Meteor.subscribe(&#39;posts&#39;),</code>, leaving only the <code>notifications</code> subscription:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">loadingTemplate</span><span class="o">:</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> &#x000A;    <span class="k">return</span> <span class="p">[</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">)]</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5" data-class="added"></div>
            
            <p>We&#39;ll then add a <code>postsLimit</code> parameter to the route&#39;s path. Adding a <code>?</code> after the parameter name means that it&#39;s optional. So our route will not only match <code>http://localhost:3000/50</code>, but also plain old <code>http://localhost:3000</code>. </p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="c1">//...</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/:postsLimit?&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5" data-class="added"></div>
            
            <p>We also move the route to the bottom of the routing map so that it doesn&#39;t clobber our existing URLs (it pretty much matches everything after all).</p>
            
            <p>It&#39;s now time to tackle the tough problem of subscribing and finding the right data. We need to deal with the case where the <code>postsLimit</code> parameter isn&#39;t present, so we&#39;ll assign it a default value. We&#39;ll use “5” to really give us enough room to play around with pagination.</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="c1">//..</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/:postsLimit?&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="kd">var</span> <span class="nx">postsLimit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span> &#x000A;      <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="nx">postsLimit</span><span class="p">});</span>&#x000A;    <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="6~9" data-class="added"></div>
            
            <p>You&#39;ll notice we&#39;re now passing a JavaScript object ({limit: postsLimit}) along with the name of our <code>posts</code> publication. This object will serve as the <code>options</code> parameter for the server side <code>Posts.find()</code> statement. Let&#39;s switch over to our server-side code to implement this:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="nx">options</span><span class="p">);</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">postId</span><span class="o">:</span> <span class="nx">postId</span><span class="p">});</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">userId</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="1~3" data-class="added"></div>
            
            <div class="note"><h3>Passing Parameters</h3>
            
            <p>Our publications code is in effect telling the server it can trust any JavaScript object sent by the client (in our case, <code>{limit: postsLimit}</code>) to serve as the <code>find()</code> statement&#39;s <code>options</code>. This makes it possible for users to submit any options they&#39;d like via the browser console.</p>
            
            <p>In our case, this is relatively harmless, since all a user could do is reorder posts differently, or change the limit (which is what we want to enable in the first place). </p>
            
            <p>But you shouldn&#39;t use this pattern when storing private data on unpublished fields, since the user could manipulate the <code>fields</code> option to access it, and you should probably also avoid using it for the <code>find()</code> statement&#39;s selector argument for the same security reasons. </p>
            
            <p>A more secure pattern could be passing the individual parameters themselves instead of the whole object, to make sure you stay in control of your data:</p>
            
            <pre><code class="js">Meteor.publish(&#39;posts&#39;, function(sort, limit) {&#x000A;  return Posts.find({}, {sort: sort, limit: limit});&#x000A;});&#x000A;</code></pre>
            </div>
            
            <p>Now that we&#39;re subscribing at the route level, it would also make sense to set the data context in the same place. We&#39;ll deviate a bit from our previous pattern and make the <code>data</code> function return a JavaScript object instead of simply returning a cursor. This lets us create a <em>named</em> data context, which we&#39;ll call <code>posts</code>. </p>
            
            <p>What this means is simply that instead of being implicitely available as <code>this</code> inside the template, our data context will be available at <code>posts</code>. Apart from this small element, the code should feel familiar:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/:postsLimit?&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span> &#x000A;      <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="nx">limit</span><span class="p">});</span>&#x000A;    <span class="p">},</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span> &#x000A;      <span class="k">return</span> <span class="p">{</span>&#x000A;        <span class="nx">posts</span><span class="o">:</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="nx">limit</span><span class="p">})</span>&#x000A;      <span class="p">};</span>&#x000A;    <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="c1">//..</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="8~13" data-class="added"></div>
            
            <p>Now that we&#39;re setting the data context at the template level we can safely get rid of the <code>posts</code> template helper inside the <code>posts_list.js</code> file. And since we named our data context <code>posts</code> (the same name as the helper), we don&#39;t even need to touch our <code>postsList</code> template!</p>
            
            <p>Let&#39;s recap. Here&#39;s what our new and improved <code>router.js</code> code should look like:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>&#x000A;  <span class="nx">layoutTemplate</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">loadingTemplate</span><span class="o">:</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> &#x000A;    <span class="k">return</span> <span class="p">[</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">)]</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="c1">//...</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/:postsLimit?&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span> &#x000A;      <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="nx">limit</span><span class="p">});</span>&#x000A;    <span class="p">},</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span> &#x000A;      <span class="k">return</span> <span class="p">{</span>&#x000A;        <span class="nx">posts</span><span class="o">:</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="nx">limit</span><span class="p">})</span>&#x000A;      <span class="p">};</span>&#x000A;    <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5, 11~21" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 12-2</h4><p>Augmented the postsList route to take a limit.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter12-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Let&#39;s give our brand new pagination system a try. We now have the ability to display an arbitrary number of posts on the homepage simply by changing the URL parameter. For example, try accessing <code>http://localhost:3000/3</code>. You should now see something like this:</p>
            
            <figure class="screenshot "><img src="images/screenshots/12-2.png" alt="Controlling the number of posts on the homepage. "/><figcaption>Controlling the number of posts on the homepage. </figcaption></figure>
            
            <div class="note"><h3>Why Not Pages?</h3>
            
            <p>Why are using an infinite pagination approach instead of showing successive pages with 10 posts each, like for example Google search results? This is actually due to a limitation of Meteor&#39;s publication model, at least as it stands. </p>
            
            <p>Let&#39;s say we&#39;re publishing posts 10 to 20 from the <code>Posts</code> collection. How would you find those posts on the client side? You can&#39;t pick posts 10 to 20, as there are only ten posts altogether in the client-side data set. </p>
            
            <p>One solution would simply to publish those 10 posts on the server, and then do a <code>Posts.find()</code> client-side to pick up <em>all</em> published posts.</p>
            
            <p>This works if you only have a single subscription. But what if you start to have more than one post subscription, as we&#39;ll do soon? </p>
            
            <p>Let&#39;s say one subscription asks for posts 10 to 20, and another one for posts 30 to 40. You now have 20 posts loaded client-side in total, with no way of knowing which ones belong to which subscription. </p>
            
            <p>The best way to solve this problem would be some kind of framework-level solution. But until that comes, we&#39;ll have to settle for infinite pagination. </p>
            </div>
            
            <h3>Creating a Route Controller</h3>
            
            <p>You might have noticed that we&#39;re repeating the <code>var limit = parseInt(this.params.postsLimit) || 5;</code> line twice. Plus, hard-coding the number “5” isn&#39;t exactly ideal. This is not the end of the world, but since it&#39;s always better to follow the DRY (Don&#39;t Repeat Yourself) principle if you can, let&#39;s see how we can refactor things a bit. </p>
            
            <p>We&#39;ll introduce a new aspect of Iron Router, <em>Route Controllers</em>. A route controller is simply a way to group routing features together in a nifty reusable package that any route can inherit from. Right now we&#39;ll only use it for a single route, but you&#39;ll see in the next chapter how this feature will come in handy. </p>
            <div class="highlight"><pre><span class="nx">PostsListController</span> <span class="o">=</span> <span class="nx">RouteController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>&#x000A;  <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;postsList&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">increment</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> &#x000A;  <span class="nx">postsLimit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> &#x000A;    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">;</span> &#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">findOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()};</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="p">{</span><span class="nx">posts</span><span class="o">:</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">())};</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="c1">//...</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postsList&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/:postsLimit?&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">controller</span><span class="o">:</span> <span class="nx">PostsListController</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div>
            
            <p>Let&#39;s go through step. First, we&#39;re creating our controller by extending <code>RouteController</code>. We then set the <code>template</code> property just like we did before, and then a new <code>increment</code> property. </p>
            
            <p>We then define a new <code>postsLimit</code> function which will return the current limit, and a <code>findOptions</code> function which will return an options object. This might seem like an extra step, but we&#39;ll make use of it later on.</p>
            
            <p>Next, we define our <code>waitOn</code> and <code>data</code> functions just like before, except they&#39;re now making use of our new <code>findOptions</code> function. </p>
            
            <p>The last thing to do is to tell the <code>postsList</code> route to route to our brand new controller, with the <code>controller</code> property. </p>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 12-3</h4><p>Refactored postsLists route into a RouteController.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter12-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Adding A Load More Link</h3>
            
            <p>We have a working pagination, and our code is looking good. There&#39;s just one problem: there&#39;s no way to actually <em>use</em> that pagination except by changing the URL manually. This definitely doesn&#39;t make for great user experience, so let&#39;s get to work on fixing this. </p>
            
            <p>What we want to do is simple enough. We&#39;ll add a “load more” button at the bottom of our posts list, which will increment the number of posts currently displayed by 5 every time it&#39;s clicked. So if I&#39;m currently on the URL <code>http://localhost:3000/5</code>, clicking “load more” should bring me to <code>http://localhost:3000/10</code>. If you&#39;ve made it this far in the book, we trust you can handle a little arithmetic!</p>
            
            <p>As before, we&#39;ll add our pagination logic in our route. Remember when we explicitely named our data context rather than just use an anonymous cursor? Well, there&#39;s no rule that says the <code>data</code> function can only pass cursors, so we&#39;ll use the same technique to generate the URL of our “load more” button.</p>
            <div class="highlight"><pre><span class="nx">PostsListController</span> <span class="o">=</span> <span class="nx">RouteController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>&#x000A;  <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;postsList&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">increment</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> &#x000A;  <span class="nx">postsLimit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> &#x000A;    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">;</span> &#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">findOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="p">{</span><span class="nx">sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">_id</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="nx">limit</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()};</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="p">{</span>&#x000A;      <span class="nx">posts</span><span class="o">:</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">()),</span>&#x000A;      <span class="nx">nextPath</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="nx">postsLimit</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">})</span>&#x000A;    <span class="p">};</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="16" data-class="added"></div>
            
            <p>Let&#39;s take a deeper look at this bit of router magic. Remember that the <code>postsList</code> route (which will inherit from the <code>PostsListController</code> controller we&#39;re currently working on) takes a <code>postsLimit</code> parameter.</p>
            
            <p>So when we feed <code>{postsLimit: this.postsLimit() + this.increment}</code> to <code>this.route.path()</code>, we&#39;re telling the <code>postsList</code> route to build its own path using that JavaScript object as data context. </p>
            
            <p>In other words, this is exactly the same thing as using the <code>{{pathFor &#39;postsList&#39;}}</code> Handlebars helper, except we&#39;re replacing the implicit <code>this</code> by our own custom-made data context.</p>
            
            <p>All that&#39;s left to do is to add the “load more” link at the bottom of our posts list, making sure to only show it if we actually have more posts to load:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postsList&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;posts&quot;</span><span class="nt">&gt;</span>&#x000A;    {{#each posts}}&#x000A;      {{&gt; postItem}}&#x000A;    {{/each}}&#x000A;&#x000A;    {{#if hasMorePosts}}&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;load-more&quot;</span> <span class="na">href=</span><span class="s">&quot;{{nextPath}}&quot;</span><span class="nt">&gt;</span>Load more<span class="nt">&lt;/a&gt;</span>&#x000A;    {{/if}}&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/posts_list.html</div><div class="lines-highlight" data-lines="7~10" data-class="added"></div>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">hasMorePosts</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;    <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">rewind</span><span class="p">();</span>&#x000A;    <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">limit</span><span class="p">()</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/posts_list.js</div>
            
            <p>Here&#39;s what your post list should now look like:</p>
            
            <figure class="screenshot "><img src="images/screenshots/12-3.png" alt="The “load more” button. "/><figcaption>The “load more” button. </figcaption></figure>
            
            <p>The <code>hasMorePosts</code> helper is a bit tricky. We know that <code>Router.current().limit()</code> returns the current number of posts we&#39;d like to show, which can either be the value in the current URL, or our default value (5) if the URL doesn&#39;t contain any parameter. </p>
            
            <p>On the other hand, <code>this.posts</code> refers to the current cursor, so <code>this.posts.fetch().length</code> refers to the number of posts that are actually in the cursor. </p>
            
            <p>So what we&#39;re saying here is that if we ask for <code>n</code> posts and we get <code>n</code> back, we&#39;ll keep showing the “load more” button. But if we ask for <code>n</code> and we get <em>less</em> than <code>n</code> back, then it means we&#39;ve hit the limit and we should stop showing that button. </p>
            
            <p>That being said, our system fails in one case: when the number of items in our database is <em>exactly</em> <code>n</code>. If that happens, the client will ask for <code>n</code> posts and get <code>n</code> posts back and keep showing the “load more” button, unaware that there are no more items left.</p>
            
            <p>Sadly, there are no simple workarounds to this problem, so for now we&#39;ll have to settle with this less-than-perfect implementation.</p>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 12-4</h4><p>Refactored postsLists route into a RouteController.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-4" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter12-4.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <div class="note"><h3>Count vs Length</h3>
            
            <p>You might be wondering why we used <code>this.posts.fetch().length</code> instead of the saner <code>this.posts.count()</code>. This is simply a temporary workaround to deal with <a href="https://github.com/meteor/meteor/issues/654">a bug</a> present in Meteor at the time of writing. Let&#39;s hope it&#39;s fixed soon!</p>
            </div>
            
            <h3>A Better Progress Bar</h3>
            
            <p>Our pagination is now working properly, but it suffers from an annoying quirk: every time we click “load more” and the router asks for more posts, we&#39;re sent to the <code>loading</code> template while we wait for the new data to come in. The result is that we&#39;re sent back to the top of the page every time and need to scroll all the way back down to resume our browsing. </p>
            
            <p>It would be much, much better if we could stay on the same page all throughout the operation, while still providing some kind of indication that new data is currently being loaded. Thankfully, that&#39;s precisely what the <code>iron-router-progress</code> package is for. </p>
            
            <p>Similar to iOS&#39;s Safari or sites like Medium and YouTube, <code>iron-router-progress</code> adds a thin loading bar at the top of the screen. Implementing it is as easy as adding the package to your app:</p>
            <div class="highlight"><pre>mrt add iron-router-progress</pre></div>
            <div class="caption">bash console</div>
            
            <p>Through the magic of smart packages, our new progress indicator will work perfectly right out of the box! The progress bar will activate for each route, and automatically complete once the route&#39;s required data is done loading. </p>
            
            <p>We&#39;ll just do a single tweak. Let&#39;s disable <code>iron-router-progress</code> for the <code>postSubmit</code> route since it doesn&#39;t need to wait for any subscription data (after all, it&#39;s just an empty form):</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;&#x000A;  <span class="c1">//...</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postSubmit&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/submit&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">disableProgress</span><span class="o">:</span> <span class="kc">true</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/posts_submit.html</div><div class="lines-highlight" data-lines="7" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 12-5</h4><p>Use the iron-router-progress package to make pagination n&hellip;</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-5" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter12-5.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <h3>Accessing Any Post</h3>
            
            <p>We&#39;re currently loading the five newest post by default, but what happens once someone browses to a post&#39;s individual page?</p>
            
            <figure class="screenshot "><img src="images/screenshots/12-4.png" alt="An empty template."/><figcaption>An empty template.</figcaption></figure>
            
            <p>If you try it, you&#39;ll be faced with an empty post template. This makes sense: we&#39;ve told the router to subscribe to the <code>posts</code> publication when loading the <code>postsList</code> route, but we haven&#39;t told it what to do about the <code>postPage</code> route. </p>
            
            <p>But so far, all we know how to do is subscribe to a list of the <code>n</code> latest posts. How do we ask the server for a single specific post? We&#39;ll let you in on a little secret here: you can have more than one publication for each collection! </p>
            
            <p>So to get our missing posts back, we&#39;ll simply make a new, separate <code>singlePost</code> publication that only publishes one post, identified by <code>_id</code>. </p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="nx">options</span><span class="p">);</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;singlePost&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="5~7" data-class="added"></div>
            
            <p>Now, let&#39;s subscribe to the right posts client-side. We were already subscribing to the <code>comments</code> publication on the <code>postPage</code> route&#39;s <code>waitOn</code> function, so we can simply add the subscription to <code>singlePost</code> in there. And let&#39;s not forget to also add our subscription to the <code>postEdit</code> route, since it also needs the same data:</p>
            <div class="highlight"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;&#x000A;  <span class="c1">//...</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postPage&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="k">return</span> <span class="p">[</span>&#x000A;        <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;singlePost&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">),</span>&#x000A;        <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span>&#x000A;      <span class="p">];</span>&#x000A;    <span class="p">},</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;postEdit&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/posts/:_id/edit&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> &#x000A;      <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;singlePost&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>&#x000A;    <span class="p">},</span>&#x000A;    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>    &#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="err">/...</span>&#x000A;&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="7~12,18~20" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 12-6</h4><p>Use a single post subscription to ensure that we can alwa&hellip;</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-6" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter12-6.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>With pagination done, our app no longer suffers from scaling problems, and users are sure to contribute even more links than before. So wouldn&#39;t it be nice to have a way to somehow rank those links? This is precisely the topic of the next chapter, <em>Voting</em>. </p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='voting'>
              Voting
              <span class='number'>13</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Build a system where users can vote on posts.</li>
            <li>Rank our posts by vote on a &ldquo;best&rdquo; post page.</li>
            <li>Learn how to write a general handlebars helper.</li>
            <li>Learn a little more about data security in Meteor.</li>
            <li>Cover some interesting performance considerations in MongoDB.</li>
            </ul>
            </div>
            
            <p>Now that our site is getting more popular, finding the best links is quickly going to get tricky. What we need is some kind of ranking system to order our posts by.</p>
            
            <p>We could build a complex ranking system with karma, time-based decay of points, and many other things (most of which are implemented in <a href="http://telesc.pe">Telescope</a>, Microscope&#39;s big brother). But for our app, we&#39;ll keep things simple and just rate posts by the number of votes they&#39;ve received.</p>
            
            <p>Let&#39;s start by giving users a way to vote on posts. </p>
            
            <h3>Data Model</h3>
            
            <p>We&#39;ll store a list of upvoters on each post so we know whether to show the upvote button to users, as well as to prevent people from voting twice. </p>
            
            <div class="note"><h3>Data Privacy &amp; Publications</h3>
            
            <p>We&#39;ll be publishing these lists of upvoters to all users, which will also automatically make that data publicly accessible via the browser console. </p>
            
            <p>This is the kind of data privacy problem that can arise from the way collections work. For example, do we want people to be able to find out who has voted for their posts? In our case making that information publicly available won&#39;t really have any consequences, but it&#39;s important to at least acknowledge the issue. </p>
            
            <p>Also note that if we <em>did</em> want to restrict some of this information, we&#39;d have to make sure that the client can&#39;t tamper with the <code>fields</code> options of our publication, either by removing that property server-side, or by not passing the whole options object from client to server. </p>
            </div>
            
            <p>We&#39;ll also denormalize the total number of upvoters on a post to make it easier to retrieve that figure. So we&#39;ll be adding two attributes to our posts, <code>upvoters</code> and <code>votes</code>. Let&#39;s start by adding them to our fixtures file:</p>
            <div class="highlight"><pre><span class="c1">// Fixture data </span>&#x000A;<span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>&#x000A;&#x000A;  <span class="c1">// create two users</span>&#x000A;  <span class="kd">var</span> <span class="nx">tomId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">profile</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Tom Coleman&#39;</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;  <span class="kd">var</span> <span class="nx">tom</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">tomId</span><span class="p">);</span>&#x000A;  <span class="kd">var</span> <span class="nx">sachaId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">profile</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Sacha Greif&#39;</span> <span class="p">}</span>&#x000A;  <span class="p">});</span>&#x000A;  <span class="kd">var</span> <span class="nx">sacha</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">sachaId</span><span class="p">);</span>&#x000A;&#x000A;  <span class="kd">var</span> <span class="nx">telescopeId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Introducing Telescope&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://sachagreif.com/introducing-telescope/&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;    <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>&#x000A;    <span class="nx">upvoters</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">votes</span><span class="o">:</span> <span class="mi">0</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">postId</span><span class="o">:</span> <span class="nx">telescopeId</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Interesting project Sacha, can I get involved?&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">postId</span><span class="o">:</span> <span class="nx">telescopeId</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;You sure can Tom!&#39;</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Meteor&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://meteor.com&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;    <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>&#x000A;    <span class="nx">upvoters</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">votes</span><span class="o">:</span> <span class="mi">0</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;The Meteor Book&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">userId</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;    <span class="nx">author</span><span class="o">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://themeteorbook.com&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;    <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>&#x000A;    <span class="nx">upvoters</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">votes</span><span class="o">:</span> <span class="mi">0</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>&#x000A;      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Test post #&#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span>&#x000A;      <span class="nx">author</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>&#x000A;      <span class="nx">userId</span><span class="o">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>&#x000A;      <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://google.com/?q=test-&#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span>&#x000A;      <span class="nx">submitted</span><span class="o">:</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>&#x000A;      <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>&#x000A;      <span class="nx">upvoters</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">votes</span><span class="o">:</span> <span class="mi">0</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">server/fixtures.js</div><div class="lines-highlight" data-lines="22, 48, 58, 69" data-class="added"></div>
            
            <p>As usual, stop your app, run <code>meteor reset</code>, restart your app, and create a new user account. Let&#39;s then also make sure these two properties are initialized when posts are created:</p>
            <div class="highlight"><pre><span class="c1">//...</span>&#x000A;&#x000A;<span class="c1">// check that there are no previous posts with the same link</span>&#x000A;<span class="k">if</span> <span class="p">(</span><span class="nx">postAttributes</span><span class="p">.</span><span class="nx">url</span> <span class="o">&amp;&amp;</span> <span class="nx">postWithSameLink</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">302</span><span class="p">,</span> &#x000A;    <span class="s1">&#39;This link has already been posted&#39;</span><span class="p">,</span> &#x000A;    <span class="nx">postWithSameLink</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="c1">// pick out the whitelisted keys</span>&#x000A;<span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">),</span> <span class="p">{</span>&#x000A;  <span class="nx">userId</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> &#x000A;  <span class="nx">author</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> &#x000A;  <span class="nx">submitted</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>&#x000A;  <span class="nx">commentsCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>&#x000A;  <span class="nx">upvoters</span><span class="o">:</span> <span class="p">[],</span> &#x000A;  <span class="nx">votes</span><span class="o">:</span> <span class="mi">0</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>&#x000A;&#x000A;<span class="k">return</span> <span class="nx">postId</span><span class="p">;</span>&#x000A;&#x000A;<span class="c1">//...</span></pre></div>
            <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="16~17" data-class="added"></div>
            
            <h3>Building our Voting Templates</h3>
            
            <p>First off, we&#39;ll add an upvote button to our post partial:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postItem&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;upvote btn&quot;</span><span class="nt">&gt;</span>⬆<span class="nt">&lt;/a&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post-content&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url}}&quot;</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>&#x000A;      <span class="nt">&lt;p&gt;</span>&#x000A;        {{votes}} Votes,&#x000A;        submitted by {{author}},&#x000A;        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postPage&#39;}}&quot;</span><span class="nt">&gt;</span>{{commentsCount}} comments<span class="nt">&lt;/a&gt;</span>&#x000A;        {{#if ownPost}}<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postEdit&#39;}}&quot;</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>{{/if}}&#x000A;      <span class="nt">&lt;/p&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postPage&#39;}}&quot;</span> <span class="na">class=</span><span class="s">&quot;discuss btn&quot;</span><span class="nt">&gt;</span>Discuss<span class="nt">&lt;/a&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_item.html</div><div class="lines-highlight" data-lines="3,7" data-class="added"></div>
            
            <figure class="screenshot "><img src="images/screenshots/13-1.png" alt="The upvote button"/><figcaption>The upvote button</figcaption></figure>
            
            <p>Next, we&#39;ll call a server upvote Method when the user clicks on the button:</p>
            <div class="highlight"><pre><span class="c1">//...</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;click .upvote&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;upvote&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_item.js</div><div class="lines-highlight" data-lines="3~8" data-class="added"></div>
            
            <p>Finally, we&#39;ll go back to our <code>collections/posts.js</code> file and add a Meteor server-side Method that will upvote posts:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>&#x000A;  <span class="nx">post</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">//...</span>&#x000A;  <span class="p">},</span>&#x000A;&#x000A;  <span class="nx">upvote</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>&#x000A;    <span class="c1">// ensure the user is logged in</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;You need to login to upvote&quot;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">postId</span><span class="p">);</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">)</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">422</span><span class="p">,</span> <span class="s1">&#39;Post not found&#39;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">upvoters</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">))</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">422</span><span class="p">,</span> <span class="s1">&#39;Already upvoted this post&#39;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="p">{</span>&#x000A;      <span class="nx">$addToSet</span><span class="o">:</span> <span class="p">{</span><span class="nx">upvoters</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span>&#x000A;      <span class="nx">$inc</span><span class="o">:</span> <span class="p">{</span><span class="nx">votes</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="6~23" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 13-1</h4><p>Added basic upvoting algorithm.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter13-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>This Method is fairly straightforward. We do some defensive checks to ensure that the user is logged in and that the post really exists. Then we double check that the user hasn&#39;t already voted for the post, and if they haven&#39;t we increment the vote&#39;s total score and add the user to the set of upvoters.</p>
            
            <p>This final step is interesting, as we&#39;ve used a couple of special Mongo operators. There are many more to learn, but these two are extremely helpful: <code>$addToSet</code> adds an item to an array property as long as it doesn&#39;t already exist, and <code>$inc</code> simply increments an integer field.</p>
            
            <h3>User Interface Tweaks</h3>
            
            <p>If the user is not logged in, or has already upvoted a post, they won&#39;t be able to vote. To reflect this in our UI, we&#39;ll use a helper to conditionally add a <code>disabled</code> CSS class to the upvote button.</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postItem&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;upvote btn {{upvotedClass}}&quot;</span><span class="nt">&gt;</span>⬆<span class="nt">&lt;/a&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;post-content&quot;</span><span class="nt">&gt;</span>&#x000A;      //...&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_item.html</div><div class="lines-highlight" data-lines="3" data-class="added"></div>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">ownPost</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="c1">//...</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">domain</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="c1">//...</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">upvotedClass</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">();</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upvoters</span><span class="p">,</span> <span class="nx">userId</span><span class="p">))</span> <span class="p">{</span>&#x000A;      <span class="k">return</span> <span class="s1">&#39;btn-primary upvotable&#39;</span><span class="p">;</span>&#x000A;    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>&#x000A;      <span class="k">return</span> <span class="s1">&#39;disabled&#39;</span><span class="p">;</span>&#x000A;    <span class="p">}</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="s1">&#39;click .upvotable&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>&#x000A;    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;upvote&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/views/posts/post_item.js</div><div class="lines-highlight" data-lines="8~15, 19" data-class="added"></div>
            
            <p>We&#39;re changing our class from <code>.upvote</code> to <code>.upvotable</code>, so don&#39;t forget to change the click event handler too.</p>
            
            <figure class="screenshot "><img src="images/screenshots/13-2.png" alt="Greying out upvote buttons."/><figcaption>Greying out upvote buttons.</figcaption></figure>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 13-2</h4><p>Grey out upvote link when not logged in / already voted.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter13-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Next, you may notice that posts with a single vote are labelled &ldquo;1 vote<strong>s</strong>&rdquo;, so let&#39;s take the time to pluralize those labels properly. Pluralization can be a complicated process, but for now we&#39;ll do it in a fairly simplistic way. We&#39;ll make a general Handlebars helper that we can use anywhere:</p>
            <div class="highlight"><pre><span class="nx">Handlebars</span><span class="p">.</span><span class="nx">registerHelper</span><span class="p">(</span><span class="s1">&#39;pluralize&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">thing</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="c1">// fairly stupid pluralizer</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="s1">&#39;1 &#39;</span> <span class="o">+</span> <span class="nx">thing</span><span class="p">;</span>&#x000A;  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">n</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">thing</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/helpers/handlebars.js</div>
            
            <p>The helpers we&#39;ve created before have been tied to the manager and template that they apply to. But by using <code>Handlebars.registerHelper</code>, we&#39;ve created a <em>global</em> helper that can be used within any template:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postItem&quot;</span><span class="nt">&gt;</span>&#x000A;//...&#x000A;<span class="nt">&lt;p&gt;</span>&#x000A;  {{votes}} Votes,&#x000A;  submitted by {{author}},&#x000A;  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postPage&#39;}}&quot;</span><span class="nt">&gt;</span>{{commentsCount}} comments<span class="nt">&lt;/a&gt;</span>&#x000A;  {{#if ownPost}}<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postEdit&#39;}}&quot;</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>{{/if}}&#x000A;<span class="nt">&lt;/p&gt;</span>&#x000A;//...&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/posts/post_item.html</div><div class="lines-highlight" data-lines="4" data-class="added"></div>
            
            <figure class="screenshot "><img src="images/screenshots/13-3.png" alt="Perfecting Proper Pluralization (now say that 10 times)"/><figcaption>Perfecting Proper Pluralization (now say that 10 times)</figcaption></figure>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 13-3</h4><p>Added pluralize helper to format text better.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-3" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter13-3.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>We should now see &ldquo;1 vote&rdquo;.</p>
            
            <h3>Smarter Voting Algorithm</h3>
            
            <p>Our upvoting code is looking good, but we can still do better. In the upvote Method, we make two calls to Mongo: one to grab the post, then another to update it. </p>
            
            <p>There are two issues with this. Firstly, it&#39;s somewhat inefficient to go to the database twice. But more importantly, it introduces a race condition. We are following the following algorithm:</p>
            
            <ol>
            <li>Grab the post from the database.</li>
            <li>Check if the user has voted.</li>
            <li>If not, do a vote by the user.</li>
            </ol>
            
            <p>What if the same user voted for the post again in between steps 1 and 3? Our current code opens the door to the user being able to vote for the same post twice. Thankfully, Mongo allows us to be smarter and combine steps 1-3 into a single Mongo command:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>&#x000A;  <span class="nx">post</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="c1">//...</span>&#x000A;  <span class="p">},</span>&#x000A;&#x000A;  <span class="nx">upvote</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>&#x000A;    <span class="c1">// ensure the user is logged in</span>&#x000A;    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span>&#x000A;      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;You need to login to upvote&quot;</span><span class="p">);</span>&#x000A;&#x000A;    <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>&#x000A;      <span class="nx">_id</span><span class="o">:</span> <span class="nx">postId</span><span class="p">,</span> &#x000A;      <span class="nx">upvoters</span><span class="o">:</span> <span class="p">{</span><span class="nx">$ne</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">}</span>&#x000A;    <span class="p">},</span> <span class="p">{</span>&#x000A;      <span class="nx">$addToSet</span><span class="o">:</span> <span class="p">{</span><span class="nx">upvoters</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span>&#x000A;      <span class="nx">$inc</span><span class="o">:</span> <span class="p">{</span><span class="nx">votes</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="12~15" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 13-4</h4><p>Better upvoting algorithm.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-4" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter13-4.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>What we are saying is &ldquo;find all the posts with this <code>id</code> that this user hasn&#39;t yet voted for, and update them in this way&rdquo;. If the user <em>hasn&#39;t</em> yet voted, it will of course find the post with that <code>id</code>. On the other hand if the user <em>has</em> voted, then the query will match no documents, and consequently nothing will happen.</p>
            
            <p>The only downside is that now we can&#39;t tell the user that they&#39;ve already voted for the post (since we got rid of the database call that checked this). But they should know that from the &ldquo;upvote&rdquo; button being disabled in the user interface anyway.</p>
            
            <div class="note"><h3>Latency Compensation</h3>
            
            <p>Let&#39;s say you tried to cheat and send one of your posts to the top of the list by tweaking its number of votes:</p>
            
            <pre><code class="js">&gt; Posts.update(postId, {$set: {votes: 10000}});&#x000A;</code></pre>
            
            <div class="caption">Browser console</div>
            
            <p>(Where <code>postId</code> is the id of one of your posts)</p>
            
            <p>This brazen attempt at gaming the system would be caught by our <code>deny()</code> callback (in <code>collections/posts.js</code>, remember?) and immediately negated.</p>
            
            <p>But if you look carefully, you might be able to see latency compensation in action. It may be quick, but the post will briefly jump to the top of the list before shooting back into position. </p>
            
            <p>What&#39;s happened? In your local <code>Posts</code> collection, the <code>update</code> was applied without incident. This happens instantly, so the post shot to the top of the list. Meanwhile, on the server, the <code>update</code> was being denied. So some time later (measured in the milliseconds if you are running Meteor on your own machine), the server returned an error, telling the local collection to revert itself. </p>
            
            <p>The end result: while waiting for the server to respond, the user interface can&#39;t help but trust the local collection. As soon as the server comes back and denies the modification, the user interfaces adapts to reflect that. </p>
            </div>
            
            <h3>Ranking the Front Page Posts</h3>
            
            <p>Now that we have a score for each post based on the number of votes, let&#39;s display a list of the best posts. To do so, we&#39;ll see how to manage two separate subscriptions against the post collection, and make our <code>postsList</code> template a bit more general.</p>
            
            <p>To start off, we&#39;ll want to have <em>two</em> subscriptions, one for each sort order. The trick here is that both subscriptions will subscribe to the <em>same</em> <code>posts</code> publication, only with different arguments!</p>
            
            <p>We&#39;ll also create two new routes called <code>newPosts</code> and <code>bestPosts</code>, accessible at the URLs <code>/new</code> and <code>/best</code> respectively (along with <code>/new/5</code> and <code>/best/5</code> for our pagination, of course).</p>
            
            <p>To do this, we&#39;ll <em>extend</em> our <code>PostsListController</code> into two distinct <code>NewPostsListController</code> and <code>BestPostsListController</code> controllers. This will let us re-use the exact same route options for both the <code>home</code> and <code>newPosts</code> routes, by giving us a single <code>NewPostsListController</code> to inherit from. And additionally, it&#39;s just a nice illustration of how flexible Iron Router can be. </p>
            <div class="highlight"><pre><span class="nx">PostsListController</span> <span class="o">=</span> <span class="nx">RouteController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>&#x000A;  <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;postsList&#39;</span><span class="p">,</span>&#x000A;  <span class="nx">increment</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> &#x000A;  <span class="nx">limit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> &#x000A;    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">;</span> &#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">findOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="p">{</span><span class="nx">sort</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sort</span><span class="p">,</span> <span class="nx">limit</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">()};</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">waitOn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="p">{</span>&#x000A;      <span class="nx">posts</span><span class="o">:</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">()),</span>&#x000A;      <span class="nx">nextPath</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nextPath</span><span class="p">()</span>&#x000A;    <span class="p">};</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">NewPostsListController</span> <span class="o">=</span> <span class="nx">PostsListController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>&#x000A;  <span class="nx">sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">_id</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>&#x000A;  <span class="nx">nextPath</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">newPosts</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="nx">postsLimit</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">})</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">BestPostsListController</span> <span class="o">=</span> <span class="nx">PostsListController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>&#x000A;  <span class="nx">sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">votes</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">_id</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>&#x000A;  <span class="nx">nextPath</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">bestPosts</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="nx">postsLimit</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">})</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">controller</span><span class="o">:</span> <span class="nx">NewPostsListController</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;newPosts&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/new/:postsLimit?&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">controller</span><span class="o">:</span> <span class="nx">NewPostsListController</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;bestPosts&#39;</span><span class="p">,</span> <span class="p">{</span>&#x000A;    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/best/:postsLimit?&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">controller</span><span class="o">:</span> <span class="nx">BestPostsListController</span>&#x000A;  <span class="p">});</span>&#x000A;  <span class="c1">// ..</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">client/helpers/router.js</div><div class="lines-highlight" data-lines="8,16,21~34,36~49" data-class="added"></div>
            
            <p>Note that now that we have more than one route, we&#39;re taking the <code>nextPath</code> logic out of <code>PostsListController</code> and into <code>NewPostsListController</code> and <code>BestPostsListController</code>, since the path will be different in either case. </p>
            
            <p>Additionally, when we sort by <code>votes</code>, we have a secondary sort by submitted timestamp to ensure that the ordering is correct.</p>
            
            <p>We&#39;ll also add links in the header:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;header&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#x000A;      <span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;home&#39;}}&quot;</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;nav-collapse collapse&quot;</span><span class="nt">&gt;</span>&#x000A;        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;li&gt;</span>&#x000A;            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;newPosts&#39;}}&quot;</span><span class="nt">&gt;</span>New<span class="nt">&lt;/a&gt;</span>&#x000A;          <span class="nt">&lt;/li&gt;</span>&#x000A;          <span class="nt">&lt;li&gt;</span>&#x000A;            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;bestPosts&#39;}}&quot;</span><span class="nt">&gt;</span>Best<span class="nt">&lt;/a&gt;</span>&#x000A;          <span class="nt">&lt;/li&gt;</span>&#x000A;          {{#if currentUser}}&#x000A;            <span class="nt">&lt;li&gt;</span>&#x000A;              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{pathFor &#39;postSubmit&#39;}}&quot;</span><span class="nt">&gt;</span>Submit Post<span class="nt">&lt;/a&gt;</span>&#x000A;            <span class="nt">&lt;/li&gt;</span>&#x000A;            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>&#x000A;              {{&gt; notifications}}&#x000A;            <span class="nt">&lt;/li&gt;</span>&#x000A;          {{/if}}&#x000A;        <span class="nt">&lt;/ul&gt;</span>&#x000A;        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>&#x000A;          <span class="nt">&lt;li&gt;</span>{{loginButtons}}<span class="nt">&lt;/li&gt;</span>&#x000A;        <span class="nt">&lt;/ul&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/header&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">client/views/include/header.html</div><div class="lines-highlight" data-lines="15~21" data-class="added"></div>
            
            <p>With all this done, we now gain a best posts list:</p>
            
            <figure class="screenshot "><img src="images/screenshots/13-4.png" alt="Ranking by points"/><figcaption>Ranking by points</figcaption></figure>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 13-5</h4><p>Added routes for post lists, and pages to display them.
            .</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-5" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter13-5.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            ### A Better Header
            
            Now that we have two post list pages, it can be hard to know just which list you&rsquo;re currently viewing. So let&rsquo;s revisit our header to make it more obvious. We&rsquo;ll create a header.js manager and create a helper that uses the current path and one or more named routes to set an active class on our navigation items:
            
            The reason why we want to support multiple named routes is that both our home and newPosts routes (which correspond to the / and /new URLs respectively) bring up the same template. Meaning that our activeRouteClass should be smart enough to make the <li> tag active in both cases. 
            
            ~~~html
            <template name="header">
              <header class="navbar">
                <div class="navbar-inner">
                  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                  </a>
                  <a class="brand" href="{{pathFor 'home'}}">Microscope</a>
                  <div class="nav-collapse collapse">
                    <ul class="nav">
                      <li class="{{activeRouteClass 'home' 'newPosts'}}">
                        <a href="{{pathFor 'newPosts'}}">New</a>
                      </li>
                      <li class="{{activeRouteClass 'bestPosts'}}">
                        <a href="{{pathFor 'bestPosts'}}">Best</a>
                      </li>
                      {{#if currentUser}}
                        <li class="{{activeRouteClass 'postSubmit'}}">
                          <a href="{{pathFor 'postSubmit'}}">Submit Post</a>
                        </li>
                        <li class="dropdown">
                          {{> notifications}}
                        </li>
                      {{/if}}
                    </ul>
                    <ul class="nav pull-right">
                      <li>{{loginButtons}}</li>
                    </ul>
                  </div>
                </div>
              </header>
            </template>
            ~~~
            <div class="caption">client/views/includes/header.html</div><div class="lines-highlight" data-lines="12,15,19" data-class="added"></div>
            ~~~js
            Template.header.helpers({
              activeRouteClass: function(/* route names */) {
                var args = Array.prototype.slice.call(arguments, 0);
                args.pop();
                
                var active = _.any(args, function(name) {
                  return Router.current().route.name === name
                });
                
                return active && &lsquo;active&rsquo;;
              }
            });
            ~~~
            <div class="caption">client/views/includes/header.js</div>
            <figure class="screenshot "><img src="images/screenshots/13-5.png" alt="Showing the active page"/><figcaption>Showing the active page</figcaption></figure>
            <div class="note"><h3>Helper Arguments</h3>
            
            <p>We haven&#39;t used that specific pattern up to now, but just like any other Handlebars tags, template helper tags can take arguments. </p>
            
            <p>And while you can of course pass specific named arguments to your function, you can also pass an unspecified number of anonymous parameters and retrieve them by calling the <code>arguments</code> object inside a function. </p>
            
            <p>In this last case, you will probably want to convert the <code>arguments</code> object to a regular JavaScript array and then call <code>pop()</code> on it to get rid of the hash added at the end by Handlebars.</p>
            </div>
            
            <p>For each navigation item, the <code>activeRouteClass</code> helper takes a list of route names, and then uses Underscore&#39;s <code>any()</code> helper to see if any of the routes pass the test (i.e. their corresponding URL being equal to the current path). </p>
            
            <p>If any of the routes do match up with the current path, <code>any()</code> will return <code>true</code>. Finally, we&#39;re taking advantage of the <code>boolean &amp;&amp; string</code> JavaScript pattern where <code>false &amp;&amp; myString</code> returns <code>false</code>, but <code>true &amp;&amp; myString</code> returns <code>myString</code>. </p>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 13-6</h4><p>Added active classes to the header.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-6" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter13-6.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Now that users can vote on posts in real-time, you will see items jumping up and down the homepage as their ranking change. but wouldn&#39;t it be nice if there was a way to smooth out all this with a few well-timed animations?</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='advancedpublications'>
              Advanced Publications
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>13.5</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>Learn more advanced patterns for manipulating publications.</li>
            <li>See just how flexible publications and subscriptions can get. </li>
            </ul>
            </div>
            
            <p>By now you should have a good grasp of how publications and subscriptions interact. So let&#39;s get rid of the training wheels and examine a few more advanced scenarios.</p>
            
            <h3>Publishing a Collection Multiple Times</h3>
            
            <p>In <a href="/chapter/publications-and-subscriptions/">our first sidebar about publications</a>, we saw some of the more common publication and subscription patterns, and we learned how the <code>_publishCursor</code> function made them very easy to implement for our own sites.</p>
            
            <p>First, let&#39;s recall what <code>_publishCursor</code> does for us exactly: it takes all the documents that match a given cursor, and pushes them down into the client-side collection <em>of the same name</em>. Notice that the name of the <em>publication</em> is in no way involved.</p>
            
            <figure class="diagram pull-right"><img src="images/diagrams/doublecollection@2x.png" alt="Publishing a collection twice"/><figcaption>Publishing a collection twice</figcaption></figure>
            
            <p>This means we can have <em>more than one publication</em> linking the client and server versions of any collection.</p>
            
            <p>We&#39;ve already encountered this pattern in our <a href="/chapter/pagination/">pagination chapter</a>, when we published a paginated subset of all the posts in addition to the currently displayed post. </p>
            
            <p>Another similar use case is to publish an <em>overview</em> of a large set of documents, as well as the full details of a single item:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;allPosts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">fields</span><span class="o">:</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">author</span><span class="o">:</span> <span class="kc">true</span><span class="p">}});</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;postDetail&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">);</span>&#x000A;<span class="p">});</span></pre></div>
            <p>Now when the client subscribes to those two publications (using <code>autorun</code> to ensure that the right <code>postId</code> is being sent to the <code>postDetail</code> subscription), its <code>&#39;posts&#39;</code> collection gets populated from two sources: a list of titles and author&#39;s names from the first subscription, and the full details of a post from the second.</p>
            
            <p>You may realise that the post published by <code>postDetail</code> is also being published by <code>allPosts</code> (although with only a subset of its properties). However, Meteor takes care of the overlap by merging the fields and ensuring there is no duplicate post.</p>
            
            <p>This is great, because now when we render the list of post summaries, we are dealing with data objects that have just enough data for us to show what we need. However, when we render out the page for a single post, we have everything we need to show it. Of course, we need to take care on the client to not expect all fields to be available on all posts in this case &ndash; this is a common gotcha!</p>
            
            <p>It should be noted that you&#39;re not limited to varying document properties. You could very well publish the same properties in both publications, but order items differently. In fact this is exactly what we&#39;re doing in Microscope:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;newPosts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="nx">limit</span><span class="o">:</span> <span class="nx">limit</span><span class="p">});</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;bestPosts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">votes</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="nx">limit</span><span class="o">:</span> <span class="nx">limit</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">server/publications.js</div>
            
            <h3>Subscribing to a Publication Multiple Times</h3>
            
            <p>We&#39;ve just seen how you can publish a single collection more than once. It turns out you can accomplish a very similar result with another pattern: creating a single publication, but <em>subscribing</em> to it multiple times. </p>
            
            <figure class="diagram pull-right"><img src="images/diagrams/subscribetwice@2x.png" alt="Subscribing twice to one publication"/><figcaption>Subscribing twice to one publication</figcaption></figure>
            
            <p>In the <a href="/chapter/voting/">voting chapter</a>, we create a second posts listing publication called <code>topPosts</code> and subscribe to it independently of <code>newPosts</code>, our current post listing subscription. It makes sense to keep things simple when there are only two such listing publications.</p>
            
            <p>However in the <a href="http://telesc.pe">Telescope</a> project, there are three such subscriptions, corresponding to three different post listing pages. Rather than having three different publications (each identical except for the order of posts that are returned), we only define a single publication:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sort</span><span class="p">,</span> <span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">sort</span><span class="o">:</span> <span class="nx">sort</span><span class="p">,</span> <span class="nx">limit</span><span class="o">:</span> <span class="nx">limit</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <p>And we then <em>subscribe</em> to this publication multiple times:</p>
            <div class="highlight"><pre><span class="nx">newPostsHandle</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="mi">10</span><span class="p">);</span>&#x000A;<span class="nx">topPostsHandle</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">score</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="mi">10</span><span class="p">);</span>&#x000A;<span class="nx">bestPostsHandle</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">baseScore</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">submitted</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="mi">10</span><span class="p">);</span></pre></div>
            <p>So what&#39;s happening here exactly? Each browser is opening up <em>three</em> different subscriptions, each connecting to the <em>same</em> publication on the server. Each subscription provides different arguments to that publication, but fundamentally, each time a (different) set of documents is being plucked from the <code>posts</code> collection and sent down the wire to the client-side collection.</p>
            
            <p>Compared to the previous pattern (which is the one used in Microscope), this saves us quite a bit of code even if it introduces a little bit more complexity. </p>
            
            <!-- We don't switch between publications because we prefer all pages to render instantly when a user switches between them. -->
            
            <h3>Multiple Collections in a Single Subscription</h3>
            
            <p>Unlike more traditional relational databses like MySQL which make use of <em>joins</em>, NoSQL databases like Mongo are all about <em>denormalizing</em> and <em>embedding</em>. Let&#39;s see how that works in the context of Meteor.</p>
            
            <figure class="diagram pull-right"><img src="images/diagrams/multiplecollections@2x.png" alt="Two collections in one subscription"/><figcaption>Two collections in one subscription</figcaption></figure>
            
            <p>Let&#39;s look at a concrete example. We&#39;ve added comments to our posts, and so far, we&#39;ve been happy to only publish the comments on the single post that the user is looking at. </p>
            
            <p>However, suppose we wanted to show comments on <em>all</em> the posts on the front page (keeping in mind that these posts will change as we paginate through them). This use case presents a good reason for embedding comments in posts, and in fact is what pushed us to denormalize comment <em>counts</em>.</p>
            
            <p>Of course we could always just embed comments in posts, getting rid of the <code>Comments</code> collection altogether. But like we previously saw in the <em>Denormalization</em> chapter, by doing so we would be losing some of the extra benefits of working with separate collections. </p>
            
            <p>But it turns out there&#39;s a trick involving subscriptions that makes it possible to embed our comments while preserving separate collections. </p>
            
            <p>Let&#39;s suppose that along with our front-page list of posts, we want to subscribe to a list of the top 2 comments for each post. </p>
            
            <p>It would be difficult to accomplish this with an independent comments publication, especially if the list of posts was limited in some way (say, the 10 most recent). We&#39;d have to write a publication that looked something like:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;topComments&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">topPostIds</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">postId</span><span class="o">:</span> <span class="nx">topPostIds</span><span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <p>This would be a problem from a performance standpoint, as the publication would need to get torn down and re-established each time the list of <code>topPostIds</code> changed. </p>
            
            <p>There is a way around this though. We just use the fact that we can not only have more than one <em>publication</em> per <em>collection</em>, but we can also have more than one <em>collection</em> per <em>publication</em>:</p>
            <div class="highlight"><pre><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;topPosts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="kd">var</span> <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">commentHandles</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">postHandle</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">;</span>&#x000A;&#x000A;  <span class="c1">// send over the top two comments attached to a single post</span>&#x000A;  <span class="kd">function</span> <span class="nx">publishPostComments</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">comments</span> <span class="o">=</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">postId</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">});</span>&#x000A;    <span class="nx">commentHandles</span><span class="p">[</span><span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">observe</span><span class="p">({</span>&#x000A;      <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">comment</span><span class="p">)</span> <span class="p">{</span>&#x000A;        <span class="nx">sub</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">comment</span><span class="p">);</span>&#x000A;      <span class="p">}</span>&#x000A;      <span class="c1">// etc, see _publishCursor (in the Meteor core source code) for hints</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">}</span>&#x000A;&#x000A;  <span class="nx">postHandle</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="nx">limit</span><span class="p">}).</span><span class="nx">observe</span><span class="p">({</span>&#x000A;    <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="nx">publishPostComments</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>&#x000A;      <span class="nx">sub</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span>&#x000A;    <span class="p">},</span>&#x000A;    <span class="nx">removed</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="c1">// stop observing changes on the post&#39;s comments</span>&#x000A;      <span class="nx">commentHandles</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">commentHandles</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">stop</span><span class="p">();</span>&#x000A;      <span class="c1">// delete the post</span>&#x000A;      <span class="nx">sub</span><span class="p">.</span><span class="nx">removed</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">oldPost</span><span class="p">));</span>&#x000A;    <span class="p">}</span>&#x000A;    <span class="c1">// etc, see _publishCursor for hints</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="nx">sub</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>&#x000A;&#x000A;  <span class="c1">// make sure we clean everything up</span>&#x000A;  <span class="nx">sub</span><span class="p">.</span><span class="nx">onStop</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">postsHandle</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>&#x000A;    <span class="nx">commentsHandle</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>&#x000A;  <span class="p">});</span>&#x000A;<span class="p">});</span></pre></div>
            <p>Note that we aren&#39;t returning anything in this publication, as we manually send messages to the <code>sub</code> ourselves (via <code>.added()</code> and friends). So we don&#39;t need to ask <code>_publishCursor</code> to do it for us by returning a cursor.</p>
            
            <p>Now, every time we publish a post we also automatically publish the top two comments attached to it. And all with a single subscription call!</p>
            
            <p>Although Meteor doesn&#39;t make this approach very straightforward yet, you can also look into the <code>publish-with-relations</code> package on Atmosphere, which aims to make this pattern easier to use.</p>
            
            <h3>Linking different collections</h3>
            
            <p>What else can our newfound knowledge of the flexibility of subscriptions give us? Well, if we don&#39;t use <code>_publishCursor</code>, we don&#39;t need to follow the constraint that the source collection on the server needs to have the same name as the target collection on the client.</p>
            
            <figure class="diagram pull-right"><img src="images/diagrams/linkedcollections@2x.png" alt="One collection for two subscriptions"/><figcaption>One collection for two subscriptions</figcaption></figure>
            
            <p>One reason why we would want to do this is <em>Single Table Inheritance</em>. </p>
            
            <p>Suppose that we wanted to reference various types of objects from our posts, each of which stored common fields but also differed slightly in content. For example, we could be building a Tumblr-like blogging engine where each post possesses the usual ID, timestamp, and title; but in addition can also feature an image, video, link, or just text.</p>
            
            <p>We could store all these objects in a single <code>&#39;resources&#39;</code> collection, using a <code>type</code> attribute to indicate which sort of object they are. (<code>video</code>, <code>image</code>, <code>link</code>, etc.).</p>
            
            <p>And although we&#39;d have a single <code>Resources</code> collection on the server, we could  transform that single collection into multiple <code>Videos</code>, <code>Images</code>, etc. collections on the client with the following bit of magic:</p>
            <div class="highlight"><pre>  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;videos&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>&#x000A;&#x000A;    <span class="kd">var</span> <span class="nx">handle</span> <span class="o">=</span> <span class="nx">Resources</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;video&#39;</span><span class="p">}).</span><span class="nx">observe</span><span class="p">({</span>&#x000A;      <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">video</span><span class="p">)</span> <span class="p">{</span>&#x000A;        <span class="nx">sub</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s1">&#39;videos&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">video</span><span class="p">);</span>&#x000A;      <span class="p">}</span>&#x000A;      <span class="c1">// for other events, see _publishCursor for hints.</span>&#x000A;    <span class="p">})</span>&#x000A;&#x000A;    <span class="c1">// mark complete, clean up when stopped</span>&#x000A;    <span class="nx">sub</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>&#x000A;&#x000A;    <span class="nx">sub</span><span class="p">.</span><span class="nx">onStop</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span> <span class="p">});</span>&#x000A;  <span class="p">});</span></pre></div>
            <p>We are basically doing what <code>_publishCursor</code> does, but rather than publishing from <code>&#39;resources&#39;</code> to <code>&#39;resources&#39;</code>, instead we are publishing from <code>&#39;resources&#39;</code> to <code>&#39;videos&#39;</code>. </p>
            
            <p>Is it a good idea to be doing this? It&#39;s not our place to judge. In any case, it&#39;s good to know what&#39;s possible in order to use Meteor to its fullest!</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='animations'>
              Animations
              <span class='number'>14</span>
            </h2>
            <div class="note chapter"><h3>In this chapter, you will:</h3><ul>
            <li>See what happens behind the scenes when Meteor swaps two DOM elements.</li>
            <li>Learn how to animate the reordering of posts.</li>
            <li>Learn how to animate the insertion of new posts.</li>
            </ul>
            </div>
            
            <p>We now have real-time voting, scoring, and ranking. However, this leads to a jarring, erratic user experience as posts jump around on the homepage. We&#39;ll use animations to smooth this over.</p>
            
            <h3>Meteor &amp; the DOM</h3>
            
            <p>Before we can start the fun part (making things move around), we need to understand how Meteor interacts with the DOM (Document Object Model &ndash; the collection of HTML elements that make up a page&#39;s contents).</p>
            
            <p>The crucial point to keep in mind is that elements <em>cannot be moved</em>. They can only be deleted and created (note that this is a limitation of the DOM itself, not of Meteor). So to give the illusion of elements A and B switching place, Meteor will actually delete element B and insert a brand new copy (B&#39;) before element A. </p>
            
            <p>This does make animation tricky, as you can&#39;t just animate B to move it to a new position, because B will be gone as soon as Meteor re-renders the page (which as we know happens instantly, thanks to reactivity). Instead, you have to animate the newly created B&#39; as it moves from B&#39;s old position to its new position before A. </p>
            
            <p>To switch posts A and B (positioned in positions p1 and p2, respectively), we would go through the following steps:</p>
            
            <ol>
            <li>Delete B</li>
            <li>Create B&#39; before A in the DOM</li>
            <li>Move B&#39; to p2</li>
            <li>Move A to p1</li>
            <li>Animate A to p2</li>
            <li>Animate B&#39; to p1</li>
            </ol>
            
            <p>The following diagram explains these steps in more detail:</p>
            
            <figure class="diagram pull-center"><img src="images/diagrams/animation_diagram@2x.png" alt="Swtiching two posts"/><figcaption>Swtiching two posts</figcaption></figure>
            
            <p>Note that in steps 3 and 4 we&#39;re not <em>animating</em> A and B&#39; to their positions but &ldquo;teleporting&rdquo; them there instantly. Since this is instantaneous, it will give the illusion that B was never deleted, and properly position both elements to be animated back to their new position.</p>
            
            <p>Thankfully, Meteor takes care of steps 1 &amp; 2 for us, so we only need to worry about steps 3 through 6. </p>
            
            <p>Moreover, in steps 5 and 6 all we&#39;re doing is moving the elements to their proper spot. So the only part we really need to worry about is steps 3 and 4, i.e. sending the elements to the animation&#39;s starting point. </p>
            
            <h3>Proper Timing</h3>
            
            <p>Up to now we&#39;ve talked about <em>how</em> to animate our posts but not <em>when</em> to animate them. </p>
            
            <p>For steps 3 and 4, the answer is on Meteor&#39;s <code>rendered</code> template callback inside the <code>post_item.js</code> manager, which is fired any time a post&#39;s property (in our case, ranking) changes. </p>
            
            <p>Steps 5 and 6 are a bit trickier. Think of it this way: if you told a perfectly logical android to run north for 5 minutes, and then once that&#39;s done run south for 5 minutes, it would probably deduce that since it will end up in the same place, it might as well save its energy and not run at all. </p>
            
            <p>So if you want to ensure that your android runs during the entire 10 minutes, you have to <em>wait</em> until it&#39;s ran the first 5 minutes, and <em>then</em> tell it to come back.</p>
            
            <p>The browser works in a similar way: if we just gave it both instructions simultaneously, the new coordinates would simply replace the old ones and nothing would happen. In other words, the browser needs to register the position changes as separate points in time, otherwise it won&#39;t be able to animate them. </p>
            
            <p>Meteor doesn&#39;t provide a <code>justAfterRendered</code> callback, but we can fake it using <code>Meteor.defer()</code>, which simply takes a function and defers its execution just enough to register as a different event. </p>
            
            <h3>CSS Positioning</h3>
            
            <p>To animate the posts being reordered around the page, we&#39;ll have to venture into CSS territory. A quick review of CSS positioning might be in order. </p>
            
            <p>Elements on a page use <strong>static</strong> positioning by default. Statically positioned elements just fit within the flow of the page, and their coordinates on the screen cannot be changed or animated. </p>
            
            <p><strong>Relative</strong> positioning on the other hand means that the element also fits in the flow of the page, but can be positioned <em>relative to its original position</em>. </p>
            
            <p><strong>Absolute</strong> positioning goes one step further and lets you give  the element specific x/y coordinates relative to the <strong>document</strong> or <strong>the first absolute or relative-positioned parent element</strong>. </p>
            
            <p>We&#39;ll use relative positioning to animate our posts. We&#39;ve already taken care of the CSS for you, but if you needed to do it yourself all you would do is add this code to your stylesheet:</p>
            <div class="highlight"><pre><span class="nc">.post</span><span class="p">{</span>&#x000A;  <span class="k">position</span><span class="o">:</span><span class="k">relative</span><span class="p">;</span>&#x000A;  <span class="n">transition</span><span class="o">:</span><span class="n">all</span> <span class="m">300</span><span class="n">ms</span> <span class="m">0</span><span class="n">ms</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="p">;</span>&#x000A;<span class="p">}</span></pre></div>
            <div class="caption">client/stylesheets/style.css</div>
            
            <p>This makes steps 5 and 6 quite easy: all we need to do is set <code>top</code> to <code>0px</code> (its default value) and our posts will slide back to their &ldquo;normal&rdquo; position. </p>
            
            <p>This means our only challenge is figuring where to animate them <em>from</em> (steps 3 and 4) relative to their new position. In other words, how much to offset them. But that&#39;s not very hard either: the correct offset is simply a post&#39;s previous position minus its new one. </p>
            
            <div class="note"><h3>Position:absolute</h3>
            
            <p>We could also use <code>position:absolute</code> with a relative parent to position our elements. But a big downside of absolutely positioned elements is that they&#39;re completely removed from the flow of the page, causing their parent container to collapse as if it were empty. </p>
            
            <p>This in turns means we&#39;d need to artificially set the height of the container via JavaScript, instead of leaving the browser reflow elements naturally. Consequently, whenever possible it&#39;s best to stick with relative positioning. </p>
            </div>
            
            <h3>Total Recall</h3>
            
            <p>We do have one more problem though. While element A persists in the DOM and can thus &ldquo;remember&rdquo; its previous position, element B experiences reincarnation and comes back to life as B&#39; with its memory wiped clean. </p>
            
            <p>Thankfully Meteor comes to the rescue by giving us access to the  <strong>template instance</strong> object in the <code>rendered</code> callback. As the <a href="http://docs.meteor.com/#template_rendered">Meteor documentation</a> states:</p>
            
            <blockquote>
            <p>In the body of the callback, <code>this</code> is a template instance object that is unique to this occurrence of the template and persists across re-renderings. </p>
            </blockquote>
            
            <p>So what we&#39;ll do is find out a post&#39;s current position in the page, and then store that position in the template instance object. This way, even when a post is deleted and recreated, we&#39;ll still be able to know where we&#39;re supposed to animate it from. </p>
            
            <p>Template instances also let us access collection data through the <code>data</code> property. This will come in handy to get a post&#39;s rank. </p>
            
            <h3>Ranking Posts</h3>
            
            <p>We&#39;ve been talking about posts rank, but this &ldquo;rank&rdquo; does not actually exist as a post property, since it&#39;s just a consequence of the order in which posts are listed in our collection. If we want to be able to animate posts according to their rank, we&#39;ll have to somehow conjure up this property out of thin air. </p>
            
            <p>Note that we can&#39;t put this <code>rank</code> property in the database itself, since rank is a relative property that depends on how you sort posts (i.e. a post can be ranked first when sorting by date, but third when sorting by points).</p>
            
            <p>We would ideally put that property in our <code>newPosts</code> and <code>topPosts</code> collections, but Meteor doesn&#39;t offer a convenient mechanism to do this yet. </p>
            
            <p>So instead, we&#39;ll insert <code>rank</code> at the last possible step, the <code>postList</code> template manager:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="nx">postsWithRank</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">rewind</span><span class="p">();</span>&#x000A;    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="nx">post</span><span class="p">.</span><span class="nx">_rank</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>&#x000A;      <span class="k">return</span> <span class="nx">post</span><span class="p">;</span>&#x000A;    <span class="p">});</span>&#x000A;  <span class="p">},</span>&#x000A;  <span class="nx">hasMorePosts</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;    <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">rewind</span><span class="p">();</span>&#x000A;    <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">limit</span><span class="p">()</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">/client/views/posts/posts_list.js</div><div class="lines-highlight" data-lines="2~8" data-class="added"></div>
            
            <p>Instead of simply returning the <code>Posts.find({}, {sort: {submitted: -1}, limit: postsHandle.limit()})</code> cursor like our previous <code>posts</code> helper, <code>postsWithRank</code> takes the cursor and adds the <code>_rank</code> property to each of its documents. </p>
            
            <p>Don&#39;t forget to update the <code>postsList</code> template as well:</p>
            <div class="highlight"><pre><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">&quot;postsList&quot;</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;posts&quot;</span><span class="nt">&gt;</span>&#x000A;    {{#each postsWithRank}}&#x000A;      {{&gt; postItem}}&#x000A;    {{/each}}&#x000A;&#x000A;    {{#if postsReady}}&#x000A;      {{#unless allPostsLoaded}}&#x000A;        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;load-more&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Load more<span class="nt">&lt;/a&gt;</span>&#x000A;      {{/unless}}&#x000A;    {{else}}&#x000A;      <span class="nt">&lt;div&gt;</span>{{&gt; spinner}}<span class="nt">&lt;/div&gt;</span>&#x000A;    {{/if}}&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/template&gt;</span></pre></div>
            <div class="caption">/client/views/posts/posts_list.html</div>
            
            <div class="lines-highlight" data-lines="3~5" data-class="added"></div>
            
            <div class="note"><h3>Be Kind, Rewind</h3>
            
            <p>Meteor is one of the most forward-thinking and cutting-edge web frameworks around. But one of its features feels like a throwback to the days of VCRs and video cassette recording, namely the <code>rewind()</code> function. </p>
            
            <p>Whenever you use a cursor with <code>forEach()</code>, <code>map()</code>, or <code>fetch()</code>, you&#39;ll need to rewind the cursor afterwards before it&#39;s ready to be used again. </p>
            
            <p>And in some cases, it&#39;s better to be on the safe side and <code>rewind()</code> the cursor preventively rather than risk a bug. </p>
            </div>
            
            <h3>Putting it together</h3>
            
            <p>We can now put everything together by using the <code>post_item.js</code> manager&#39;s <code>rendered</code> template callback for our animation logic:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="c1">//...</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">rendered</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;  <span class="c1">// animate post from previous position to new position</span>&#x000A;  <span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>&#x000A;  <span class="kd">var</span> <span class="nx">rank</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_rank</span><span class="p">;</span>&#x000A;  <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">firstNode</span><span class="p">);</span>&#x000A;  <span class="kd">var</span> <span class="nx">postHeight</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>&#x000A;  <span class="kd">var</span> <span class="nx">newPosition</span> <span class="o">=</span> <span class="nx">rank</span> <span class="o">*</span> <span class="nx">postHeight</span><span class="p">;</span>&#x000A;&#x000A;  <span class="c1">// if element has a currentPosition (i.e. it&#39;s not the first ever render)</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">currentPosition</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">previousPosition</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">currentPosition</span><span class="p">;</span>&#x000A;    <span class="c1">// calculate difference between old position and new position and send element there</span>&#x000A;    <span class="kd">var</span> <span class="nx">delta</span> <span class="o">=</span> <span class="nx">previousPosition</span> <span class="o">-</span> <span class="nx">newPosition</span><span class="p">;</span>&#x000A;    <span class="nx">$this</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="nx">delta</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;&#x000A;  <span class="c1">// let it draw in the old position, then..</span>&#x000A;  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">instance</span><span class="p">.</span><span class="nx">currentPosition</span> <span class="o">=</span> <span class="nx">newPosition</span><span class="p">;</span>&#x000A;    <span class="c1">// bring element back to its new original position</span>&#x000A;    <span class="nx">$this</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>  <span class="s2">&quot;0px&quot;</span><span class="p">);</span>&#x000A;  <span class="p">});</span> &#x000A;<span class="p">};</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="c1">//...</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">/client/views/posts/post_item.js</div><div class="lines-highlight" data-lines="5~27" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 14-1</h4><p>Added post reordering animation.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter14-1" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter14-1.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>It shouldn&#39;t be too hard to follow along if you refer back to our previous diagram.</p>
            
            <p>Note that since we set the template instance&#39;s <code>currentPosition</code> property in the <code>defer</code> callback, this means that this property won&#39;t exist on the very first render of the template fragment. But this is not a problem since we&#39;re not interested in animating that first render anyway. </p>
            
            <p>Now open your site and start upvoting. You should now see posts gently moving up and down with ballet-like grace!</p>
            
            <h3>Animating New Posts</h3>
            
            <p>Our posts are now reordering properly, but we don&#39;t really have a &ldquo;new post&rdquo; animation yet. Instead of having new posts simply pop up at the top of our list, let&#39;s fade them in. </p>
            
            <p>This is actually more complicated than it sounds. The problem is that Meteor&#39;s <code>rendered</code> callback actually gets triggered in two separate cases:</p>
            
            <ol>
            <li>When a new template is inserted into the DOM</li>
            <li>Whenever a template&#39;s underlying data changes</li>
            </ol>
            
            <p>Only case 1 should be animated, unless you want your user interface lighting up like a christmas tree every time your data changes. </p>
            
            <p>So let&#39;s make sure we only animate posts when they&#39;re actually new, and not just when they&#39;re re-rendered because their data changed. We&#39;re already testing for the presence of an instance variable (which is only set after the first render), so we just have to go back to our <code>rendered</code> callback and add an <code>else</code> block:</p>
            <div class="highlight"><pre><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>&#x000A;  <span class="c1">//...</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">rendered</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;  <span class="c1">// animate post from previous position to new position</span>&#x000A;  <span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>&#x000A;  <span class="kd">var</span> <span class="nx">rank</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_rank</span><span class="p">;</span>&#x000A;  <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">firstNode</span><span class="p">);</span>&#x000A;  <span class="kd">var</span> <span class="nx">postHeight</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>&#x000A;  <span class="kd">var</span> <span class="nx">newPosition</span> <span class="o">=</span> <span class="nx">rank</span> <span class="o">*</span> <span class="nx">postHeight</span><span class="p">;</span>&#x000A;&#x000A;  <span class="c1">// if element has a currentPosition (i.e. it&#39;s not the first ever render)</span>&#x000A;  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">currentPosition</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">previousPosition</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">currentPosition</span><span class="p">;</span>&#x000A;    <span class="c1">// calculate difference between old position and new position and send element there</span>&#x000A;    <span class="kd">var</span> <span class="nx">delta</span> <span class="o">=</span> <span class="nx">previousPosition</span> <span class="o">-</span> <span class="nx">newPosition</span><span class="p">;</span>&#x000A;    <span class="nx">$this</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="nx">delta</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">);</span>&#x000A;  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>&#x000A;    <span class="c1">// it&#39;s the first ever render, so hide element</span>&#x000A;    <span class="nx">$this</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;invisible&quot;</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;&#x000A;  <span class="c1">// let it draw in the old position, then..</span>&#x000A;  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">instance</span><span class="p">.</span><span class="nx">currentPosition</span> <span class="o">=</span> <span class="nx">newPosition</span><span class="p">;</span>&#x000A;    <span class="c1">// bring element back to its new original position</span>&#x000A;    <span class="nx">$this</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>  <span class="s2">&quot;0px&quot;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;invisible&quot;</span><span class="p">);</span>&#x000A;  <span class="p">});</span> &#x000A;<span class="p">};</span>&#x000A;&#x000A;<span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>&#x000A;  <span class="c1">//...</span>&#x000A;<span class="p">});</span></pre></div>
            <div class="caption">/client/views/posts/post_item.js</div><div class="lines-highlight" data-lines="19~22,28" data-class="added"></div>
            
            <div class="commit"><img src="images/code.svg"/><div class="message"><h4>Commit 14-2</h4><p>Fade items in when they are drawn.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter14-2" target="_blank">View on GitHub</a><a class="instance-link" href="http://meteor-book-chapter14-2.meteor.com" target="_blank" class="live-instance">Launch Instance</a></div></div>
            
            <p>Note that the <code>removeClass(&quot;invisible&quot;)</code> we added in the <code>defer()</code> function will run for every rendering. But it will only  do something if the <code>.invisible</code> class is actually present on the element, which will only be true the first time it&#39;s rendered. </p>
            
            <div class="note"><h3>CSS &amp; JavaScript</h3>
            
            <p>You might have noticed that we&#39;re using an <code>.invisible</code> CSS class to trigger the animation instead of animating the CSS <code>opacity</code> property directly like we did for <code>top</code>. This is because for <code>top</code>, we needed to animate the property to a specific value that depended on the instance data. </p>
            
            <p>On the other hand, here we only want to show and hide an element independently of its data. Since it&#39;s a good idea to keep your CSS out of your JavaScript as much as possible, we&#39;ll only add and remove the class here, and specify the details of the animation over in our stylesheet. </p>
            </div>
            
            <p>We should finally have the animation behavior we wanted. Load up your app and give it a try! And you can also play around with the <code>.post</code> and <code>.post.invisible</code> classes to see if you can come up with other transitions. Hint: <a href="http://matthewlein.com/ceaser/">CSS easing functions</a> are a good place to start!</p>
          </div>
        </section>
        <section class='chapter'>
          <div class='post-content'>
            <h2 id='meteorvocabulary'>
              Meteor Vocabulary
              <span class='sidebar-marker'>Sidebar</span>
              <span class='number'>14.5</span>
            </h2>
            <p>In this book, you&#39;ll hear some words which may be new, or at least used in a new way in a Meteor context. We&#39;ll use this chapter to define them.</p>
            
            <h4>Collection</h4>
            
            <p>A Meteor Collection is the data store that automatically synchronizes between client and server. Collections have a name (such as <code>posts</code>), and usually exist both on client and server. Although they behave differently, they have a common API based on Mongo&#39;s API.</p>
            
            <h4>MiniMongo</h4>
            
            <p>The client-side collection is an in-memory data store offering a Mongo-like API. The library that supports this behaviour is called &ldquo;MiniMongo&rdquo;, to indicate it&#39;s a smaller version of Mongo that runs completely in memory.</p>
            
            <h4>Document</h4>
            
            <p>Mongo is a document-based data-store, so the objects that come out of collections are called &ldquo;documents&rdquo;. They are plain JavaScript objects (although they can&#39;t contain functions) with a single special property, the <code>_id</code>, which Meteor uses to track their properties over DDP.</p>
            
            <h4>DDP</h4>
            
            <p>DDP is Meteor&#39;s Distributed Data Protocol, the wire protocol used to synchronize collections and make Method calls. DDP is intended as a generic protocol, which takes the place of HTTP for realtime applications that are data heavy.</p>
            
            <h4>Client</h4>
            
            <p>When we talk about the Client, we are referring to code running in the users <em>web browser</em>, whether that is a traditional browser like Firefox or Safari, or something as complex as a UIWebView in a native iPhone application.</p>
            
            <h4>Computation</h4>
            
            <p>A computation is a block of code that runs every time one of the reactive data sources that it depends on changes. If you have a reactive data source (for example, a Session variable) and would like to respond reactively to it, you&#39;ll need set up a computation for it. </p>
            
            <h4>Server</h4>
            
            <p>The Meteor server is a HTTP and DDP server run via node.js. It consists of the all the Meteor libraries as well your server-side JavaScript code. When you start your Meteor server, it connects to a Mongo database (which it starts itself in development).</p>
            
            <h4>Method</h4>
            
            <p>A Meteor Method is a remote procedure call from the client to the server, with some special logic to keep track of collection changes and allow Latency Compensation.</p>
            
            <h4>Latency Compensation</h4>
            
            <p>Is a technique to allow simulation of Method calls on the client, to avoid lagginess while waiting for the server to respond.</p>
            
            <h4>Template</h4>
            
            <p>A template is a method of generating HTML in JavaScript. By default, Meteor supports Handlebars, a logic-less templating system, although there are plans to support more in the future.</p>
            
            <h4>Template Data Context</h4>
            
            <p>When a template renders, it refers to a JavaScript object that provides specific data for this particular rendering. Usually such objects are plain-old-JavaScript-objects (POJOs), often documents from a collection, although they can be more complicated and have functions available on them.</p>
            
            <h4>Helpers</h4>
            
            <p>When a template needs to render something more complex than a document property it can call a helper, a function that is used to aid rendering.</p>
            
            <h4>Session</h4>
            
            <p>The Session in Meteor refers to a client-side reactive data source that&#39;s used by your application to track the state that the user&#39;s in. </p>
            
            <h4>Publication</h4>
            
            <p>A publication is a named set of data that is customized for each user that subscribes to it. You set up a publication on the server.</p>
            
            <h4>Subscription</h4>
            
            <p>A subscription is a connection to a publication for a specific client. The subscription is code that runs in the browser that talks to a publication on the server and keeps the data in sync.</p>
            
            <h4>Cursor</h4>
            
            <p>A cursor is the result of running a query on a Mongo collection. On the client side, a cursor isn&#39;t just an array of results, but a <em>reactive</em> object that can be observed as objects in the relevant collection are added, removed and updated.</p>
            
            <h4>Package</h4>
            
            <p>A Meteor package can consist of 
              1. JavaScript code to run on the server.
              2. JavaScript code to run on the client.
              3. Instructions on how to process resources (such as SASS to CSS).
              4. Resources to be processed.</p>
            
            <p>A package is like a super-powered library. Meteor comes with an extensive set of core packages. There&#39;s also <a href="http://atmosphere.meteor.com">Atmosphere</a>, which is a collection of community supplied third party packages.</p>
            
            <h4>Deps</h4>
            
            <p>Deps is Meteor&#39;s reactivity system. Deps is used behind the scenes to keep HTML automatically sync with the underlying data model.</p>
          </div>
        </section>
      </div>
    </div>
  </body>
</html>
